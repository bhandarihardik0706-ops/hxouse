<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HXOUSE Coffee Co. | Aniga AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400..900&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary-light: #FFFFFF; --bg-secondary-light: #F3F4F6; --text-primary-light: #111827; --text-secondary-light: #6B7280; --border-light: #E5E7EB; --brand-primary-light: #111827;
            --bg-primary-dark: #111111; --bg-secondary-dark: #1F2023; --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF; --border-dark: #374151; --brand-primary-dark: #FFFFFF;
            --bg-primary-matcha: #F0FFF4; --bg-secondary-matcha: #DCF2E3; --text-primary-matcha: #2F4858; --text-secondary-matcha: #5C7A89; --border-matcha: #B8D8C0; --brand-primary-matcha: #3A8154;
            --app-height: 100vh;
        }
        [data-theme="light"] { --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border-color: var(--border-light); --brand-primary: var(--brand-primary-light); }
        [data-theme="dark"] { --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border-color: var(--border-dark); --brand-primary: var(--brand-primary-dark); }
        [data-theme="matcha"] { --bg-primary: var(--bg-primary-matcha); --bg-secondary: var(--bg-secondary-matcha); --text-primary: var(--text-primary-matcha); --text-secondary: var(--text-secondary-matcha); --border-color: var(--border-matcha); --brand-primary: var(--brand-primary-matcha); }

        html, body { height: 100%; overflow: hidden; margin: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: #000000; color: var(--text-primary); -webkit-tap-highlight-color: transparent; transition: background-color 0.5s ease; }
        .app-container { background-color: var(--bg-primary); transition: background-color 0.5s ease; height: var(--app-height); }
        .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); }
        .bg-primary { background-color: var(--bg-primary); } .bg-secondary { background-color: var(--bg-secondary); }
        .border-custom { border-color: var(--border-color); } .brand-text { color: var(--brand-primary); }
        .brand-bg { background-color: var(--brand-primary); color: var(--bg-primary); }

        .fade-in { animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { animation: fadeIn 0.3s ease; }
        .modal-content { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .accordion-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; }
        .accordion-content.open { opacity: 1; }

        .instagram-card { background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .classy-x { font-family: 'Playfair Display', serif; font-style: italic; font-weight: 600; font-size: 1.5em; vertical-align: -0.2em; }
        
        .quantity-control { display: flex; align-items: center; justify-content: space-between; background-color: var(--brand-primary); color: var(--bg-primary); border-radius: 9999px; font-weight: 600; overflow: hidden; width: 100px; height: 40px; }
        .add-to-cart-btn { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-primary); color: var(--brand-primary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        
        .combo-card { background: linear-gradient(135deg, rgba(58, 129, 84, 0.1) 0%, rgba(58, 129, 84, 0.05) 100%); border: 2px dashed var(--brand-primary); }
        .glow-tag { background-color: var(--brand-primary); color: white; animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow { 0% { opacity: 0.8; } 50% { opacity: 1; box-shadow: 0 0 15px var(--brand-primary); } 100% { opacity: 0.8; } }

        .countdown-timer { font-variant-numeric: tabular-nums; letter-spacing: 1px; }

        .option-button.active { background-color: var(--brand-primary) !important; color: var(--bg-primary) !important; border-color: var(--brand-primary) !important; box-shadow: 0 4px 20px rgba(58, 129, 84, 0.3); transform: scale(1.05); }
        
        .chat-bubble-user { border-radius: 20px 20px 4px 20px; background-color: var(--brand-primary); color: var(--bg-primary); }
        .chat-bubble-aniga { border-radius: 20px 20px 20px 4px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); }

        .aniga-float { animation: anigaPulse 3s infinite ease-in-out; }
        @keyframes anigaPulse { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px var(--brand-primary)); } 50% { transform: scale(1.08); filter: drop-shadow(0 0 25px var(--brand-primary)); } }
    </style>
</head>
<body data-theme="matcha">

    <!-- Splash Loader -->
    <div id="splash-screen" class="fixed inset-0 bg-primary flex flex-col items-center justify-center z-[100]">
        <div class="relative">
            <img src="https://ttdnlatylcqrevzlyrru.supabase.co/storage/v1/object/public/assets/Untitled%20design_20251008_093211_0000.png" 
                 alt="HXOUSE Logo" class="w-48 h-48 object-contain rounded-full shadow-2xl">
        </div>
        <div class="mt-12 flex flex-col items-center text-center">
            <div class="w-10 h-10 border-4 border-t-brand border-secondary rounded-full animate-spin mb-6"></div>
            <p class="text-secondary text-xs font-bold tracking-[0.4em] animate-pulse uppercase">Aniga AI Training...</p>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app" class="app-container max-w-lg mx-auto shadow-2xl flex flex-col hidden">
        <main class="flex-grow overflow-y-auto relative">
            <div id="main-interface" class="hidden">
                <header id="page-header" class="sticky top-0 bg-primary z-20 h-20 px-6 flex justify-between items-center border-b border-custom"></header>
                <div id="page-content"></div>
            </div>
            <div class="h-24 flex-shrink-0"></div>
        </main>
        
        <!-- Navbar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 max-w-lg w-full bg-primary border-t border-custom flex justify-around items-center h-20 z-30 hidden pb-4 shadow-2xl"></nav>
    </div>

    <div id="modal-container"></div>
    <div id="toast" class="hidden fixed bottom-28 left-1/2 -translate-x-1/2 brand-bg py-3 px-8 rounded-full shadow-2xl z-[70] whitespace-nowrap text-white font-black text-xs uppercase tracking-widest">
        <p id="toast-message"></p>
    </div>

<script>
/**
 * HXOUSE COFFEE CO.
 * ANIGA AI ENGINE v3.4.2 (Official Logo Update)
 */

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

const SUPABASE_URL = 'https://ttdnlatylcqrevzlyrru.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0ZG5sYXR5bGNxcmV2emx5cnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzAyMDEsImV4cCI6MjA3NTc0NjIwMX0.aiQ1_viA1JrugEyMWxA2e5f2Aqrao9BNgCTb70NWyCc';
const GEMINI_API_KEY = "AIzaSyC0ype4GbppYe4CEHrBzurlYABkJYk-s6Y";

const sb = self.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const PAGES = ['home', 'order', 'cart', 'social', 'cowork', 'aniga', 'more'];

const LOGO_URL = "https://ttdnlatylcqrevzlyrru.supabase.co/storage/v1/object/public/assets/Untitled%20design_20251008_093211_0000.png";

const ANIGA_PROMPT = `You are Aniga, the super-talented and friendly female AI assistant for HXOUSE Coffee Co. 
You are an expert on coffee, the HXOUSE creative community, and our specific cafe menu. 
Your personality: Cheerful, modern, creative, and extremely helpful. 
Cafe Specialties: 
1. Build Your Own Meal (‚Çπ189): Includes a choice of Margherita, Paneer Tikka, or Momos + a choice of 2 Mojitos or 1 Cold Frappe + Peri Peri Fries.
2. Our roasts are premium and built for the creative hustle.
3. We are located in the heart of the creative studio.
4. Ordering is currently in live tracking mode for our admin side.
You can help with navigating the app, suggesting Instagram captions (coffee-themed), and explaining the menu.
If someone asks for a combo, guide them to our 'Build Your Own Meal'.`;

const app = {
    state: {
        currentPage: 'home',
        cart: [],
        activeOrder: null,
        tableNumber: null,
        user: null,
        customerProfile: null,
        theme: 'matcha',
        menuData: [],
        allMenuItems: [],
        expandedCategory: null,
        searchQuery: '',
        isListening: false,
        chatHistory: [{ role: 'aniga', text: "Hey! I'm Aniga. I've been upgraded with Gemini intelligence. Ask me anything about the menu or building your perfect meal!" }],
        countdownText: "00d 00h 00m 00s",
        builder: { snack: null, drink: null, fries: 'Peri Peri' }
    },

    async init() {
        this.setHeight();
        window.addEventListener('resize', () => this.setHeight());
        window.addEventListener('popstate', (e) => this.handleBack(e));
        const initialHash = location.hash.substring(1);
        this.state.currentPage = PAGES.includes(initialHash) ? initialHash : 'home';
        this.startCountdown();
        await this.runStartup();
    },

    startCountdown() {
        const target = new Date("March 1, 2026 00:00:00").getTime();
        setInterval(() => {
            const diff = target - new Date().getTime();
            if (diff <= 0) { this.state.countdownText = "LIVE NOW"; }
            else {
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                this.state.countdownText = `${String(d).padStart(2, '0')}d ${String(h).padStart(2, '0')}h ${String(m).padStart(2, '0')}m ${String(s).padStart(2, '0')}s`;
            }
            if ($('#home-countdown')) $('#home-countdown').textContent = this.state.countdownText;
        }, 1000);
    },

    setHeight() { document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`); },

    async runStartup() {
        try {
            const { data: { session } } = await sb.auth.getSession();
            this.state.user = session?.user;
            if (!this.state.user) {
                const { data: anon } = await sb.auth.signInAnonymously();
                this.state.user = anon.user;
            }
            await Promise.all([this.loadProfile(), this.loadMenu()]);
            this.parseTable();
            $('#splash-screen').style.display = 'none';
            $('#app').classList.remove('hidden');
            $('#app').classList.add('flex');
            if (!this.state.customerProfile?.name) this.onboard();
            else if (this.state.tableNumber) this.launch();
            else this.askTable();
        } catch (e) { console.error("Aniga Engine Error", e); }
    },

    async loadProfile() {
        const { data } = await sb.from('customers').select('*').eq('id', this.state.user.id).maybeSingle();
        this.state.customerProfile = data;
    },

    async loadMenu() {
        const { data } = await sb.from('products').select('*').eq('is_available', true).order('id');
        this.state.allMenuItems = data || [];
        this.state.menuData = (data || []).reduce((acc, item) => {
            let cat = acc.find(c => c.category === item.category);
            if (!cat) { cat = { category: item.category, items: [] }; acc.push(cat); }
            cat.items.push(item);
            return acc;
        }, []);
        this.state.expandedCategory = 'LIMITED OFFERS';
    },

    parseTable() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get('table');
        if (raw) {
            const map = { "6": 1, "10": 2, "1": 3, "7": 4, "4": 6, "3": 7, "2": 8 };
            this.state.tableNumber = parseInt(map[raw] || raw);
        }
    },

    launch() {
        this.fetchActiveOrder();
        $('#main-interface').classList.remove('hidden');
        $('#bottom-nav').classList.remove('hidden');
        ui.renderNav();
        this.navigateTo(this.state.currentPage, false);
    },

    onboard() {
        ui.showModal('onboard-ui', `
            <div class="text-center">
                <div class="w-24 h-24 brand-bg mx-auto rounded-full flex items-center justify-center p-2 mb-6 shadow-xl aniga-float">
                    <img src="${LOGO_URL}" class="w-full h-full object-contain" alt="HXOUSE Logo">
                </div>
                <h2 class="text-3xl font-black mb-10 text-primary uppercase">HXOUSE ID</h2>
                <div class="space-y-4">
                    <input type="text" id="ob-name" class="w-full p-5 bg-secondary border border-custom rounded-2xl font-bold uppercase text-center text-primary" placeholder="Full Name">
                    <input type="tel" id="ob-phone" class="w-full p-5 bg-secondary border border-custom rounded-2xl font-bold text-center text-primary" placeholder="WhatsApp Number">
                    ${!this.state.tableNumber ? `<input type="number" id="ob-table" class="w-full p-5 bg-secondary border border-custom rounded-2xl font-bold text-center text-primary" placeholder="Table #">` : ''}
                </div>
                <button onclick="app.submitOnboard()" class="w-full brand-bg mt-12 py-6 rounded-[2rem] font-black text-xl shadow-2xl uppercase">Initialize</button>
            </div>
        `);
    },

    async submitOnboard() {
        const name = $('#ob-name').value.trim();
        const phone = $('#ob-phone').value.trim();
        const table = this.state.tableNumber || parseInt($('#ob-table')?.value);
        if (!name || phone.length < 10 || isNaN(table)) return ui.showToast("Missing Data");
        try {
            const profile = { id: this.state.user.id, name, whatsapp_number: phone, loyalty_points: 0 };
            await sb.from('customers').upsert(profile);
            this.state.customerProfile = profile;
            this.state.tableNumber = table;
            ui.closeModal('onboard-ui');
            this.launch();
        } catch (e) { ui.showToast("Auth Error"); }
    },

    askTable() {
        ui.showModal('table-ui', `
            <h2 class="text-2xl font-black mb-8 text-center text-primary">SELECT SPOT</h2>
            <div class="grid grid-cols-5 gap-3 mb-10">
                ${[1,2,3,4,5,6,7,8,9,10].map(n => `<button onclick="$('#manual-table').value=${n}" class="p-5 bg-secondary rounded-2xl font-black border border-custom active:brand-bg text-primary">${n}</button>`).join('')}
            </div>
            <input type="number" id="manual-table" class="w-full p-6 border border-custom rounded-3xl bg-secondary font-black text-center text-4xl text-primary" placeholder="--">
            <button onclick="app.submitTable()" class="w-full brand-bg py-6 rounded-[2rem] font-black text-xl uppercase mt-4">Confirm</button>
        `);
    },

    submitTable() {
        const v = parseInt($('#manual-table').value);
        if (!v) return;
        this.state.tableNumber = v;
        ui.closeModal('table-ui');
        this.launch();
    },

    navigateTo(page, push = true) {
        if (push) location.hash = page;
        this.state.currentPage = page;
        ui.renderHeader();
        ui.renderContent();
        ui.updateNav();
        $('#app main').scrollTo(0, 0);
    },

    handleBack(e) {
        const modal = $('#modal-container').children[0];
        if (modal) { ui.closeModal(modal.id); e.preventDefault(); return; }
        if (this.state.currentPage !== 'home') { this.navigateTo('home'); e.preventDefault(); }
    },

    addCart(id, change) {
        const item = this.state.allMenuItems.find(i => i.id === id);
        let cartItem = this.state.cart.find(i => i.id === id);
        if (!cartItem && change > 0) { this.state.cart.push({ ...item, quantity: 1 }); }
        else if (cartItem) {
            cartItem.quantity += change;
            if (cartItem.quantity <= 0) this.state.cart = this.state.cart.filter(i => i.id !== id);
        }
        ui.renderContent();
    },

    addCustomCombo() {
        const { snack, drink, fries } = this.state.builder;
        if (!snack || !drink) return ui.showToast("Select all choices!");
        const comboItem = {
            id: `combo_${Date.now()}`,
            name: `Meal: ${snack} + ${drink}`,
            price: 189,
            quantity: 1,
            description: `Inc: ${fries} Fries.`
        };
        this.state.cart.push(comboItem);
        ui.closeModal('builder-ui');
        ui.showToast("Meal Added!");
        this.navigateTo('cart');
    },

    async fetchActiveOrder() {
        const { data } = await sb.from('orders').select('*, order_items(*, products(*))').eq('customer_id', this.state.user.id).in('status', ['received', 'preparing']).order('created_at', { ascending: false }).limit(1).maybeSingle();
        this.state.activeOrder = data;
        if (data) this.subscribeRealtime(data.id);
        ui.renderContent();
    },

    subscribeRealtime(id) {
        if (this.state.realtimeChannel) sb.removeChannel(this.state.realtimeChannel);
        this.state.realtimeChannel = sb.channel(`order-${id}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${id}` }, p => {
            this.state.activeOrder = p.new;
            if (['delivered', 'cancelled'].includes(p.new.status)) { this.state.activeOrder = null; ui.showToast(`Order ${p.new.status}`); }
            ui.renderContent();
        }).subscribe();
    },

    async handleAnigaInput(input) {
        if (!input.trim()) return;
        this.state.chatHistory.push({ role: 'user', text: input });
        ui.renderContent();
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: input }] }],
                    systemInstruction: { parts: [{ text: ANIGA_PROMPT }] }
                })
            });
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "I'm having a little coffee break, try again in a second!";
            
            this.state.chatHistory.push({ role: 'aniga', text: text });
            ui.renderContent();
            this.speakAniga(text);
        } catch (e) {
            this.state.chatHistory.push({ role: 'aniga', text: "Gemini connection lost. I'm offline for a moment!" });
            ui.renderContent();
        }
    },

    speakAniga(text) {
        if (!('speechSynthesis' in window)) return;
        const u = new SpeechSynthesisUtterance(text);
        const voices = window.speechSynthesis.getVoices();
        u.voice = voices.find(v => v.name.includes('Female') || v.name.includes('Google UK English Female') || v.name.includes('Samantha')) || voices[0];
        u.pitch = 1.1; u.rate = 1.0;
        window.speechSynthesis.speak(u);
    },

    startVoice() {
        if (!('webkitSpeechRecognition' in window)) return ui.showToast("Voice not supported");
        const rec = new webkitSpeechRecognition();
        rec.lang = 'en-US';
        rec.onstart = () => { this.state.isListening = true; ui.renderContent(); };
        rec.onend = () => { this.state.isListening = false; ui.renderContent(); };
        rec.onresult = (e) => { this.handleAnigaInput(e.results[0][0].transcript); };
        rec.start();
    },

    async placeOrder() {
        const subtotal = this.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
        const total = subtotal * 1.05;
        try {
            const { error } = await sb.rpc('create_order_with_items', {
                table_number_input: this.state.tableNumber,
                total_amount_input: total,
                source_input: 'Customer-Rebel',
                order_items: this.state.cart.map(i => ({ 
                    product_id: isNaN(i.id) ? 1 : parseInt(i.id), 
                    quantity: i.quantity, 
                    price_at_time_of_order: i.price 
                }))
            });
            if (error) throw error;
            this.state.cart = []; ui.closeModal('pay-ui'); ui.showToast("Admin Dispatched!");
            await this.fetchActiveOrder(); this.navigateTo('cart');
        } catch (e) { ui.showToast("Order Failed"); }
    }
};

const ui = {
    renderHeader() {
        const h = $('#page-header');
        h.innerHTML = `
            <div onclick="app.navigateTo('home')" class="cursor-pointer">
                <img src="${LOGO_URL}" class="h-12 w-auto object-contain" alt="HXOUSE Logo">
            </div>
            <div class="text-right">
                <p class="font-black text-sm tracking-tighter uppercase text-primary">#${app.state.tableNumber || '?'}</p>
                <p class="text-[9px] uppercase opacity-40 font-black text-primary">${app.state.customerProfile?.name || 'Guest'}</p>
            </div>`;
    },

    renderContent() {
        const c = $('#page-content');
        const p = app.state.currentPage;
        if (p === 'home') this.home(c);
        else if (p === 'order') this.menu(c);
        else if (p === 'cart') this.cart(c);
        else if (p === 'social') this.social(c);
        else if (p === 'aniga') this.aniga(c);
        else if (p === 'more') this.more(c);
    },

    home(c) {
        c.innerHTML = `
            <div class="space-y-6 fade-in pb-10">
                <div class="relative h-64 overflow-hidden rounded-b-[3.5rem] shadow-2xl">
                    <video src="https://ttdnlatylcqrevzlyrru.supabase.co/storage/v1/object/public/assets/lv_0_20251012011509.mp4" autoplay loop muted playsinline class="absolute top-0 left-0 w-full h-full object-cover opacity-60"></video>
                    <div class="absolute inset-0 bg-black/40 flex flex-col items-center justify-center text-white p-6">
                        <h1 class="text-4xl font-bold tracking-tighter uppercase leading-none text-center">Fuel the Hustle</h1>
                        <p class="text-[9px] font-bold tracking-[0.6em] mt-4 opacity-80 uppercase">HUSTLE TRACKER</p>
                    </div>
                </div>

                <div class="px-6">
                    <div class="bg-primary border-2 border-custom rounded-[2.5rem] p-7 text-center shadow-lg">
                        <p class="text-[9px] font-black uppercase text-secondary tracking-[0.4em] mb-3">Limited Meal Offers Ending:</p>
                        <div id="home-countdown" class="text-3xl font-black text-primary tracking-tighter countdown-timer">${app.state.countdownText}</div>
                    </div>
                </div>

                <div class="px-6">
                    <div onclick="ui.builderModal()" class="combo-card p-10 rounded-[3rem] text-center shadow-2xl cursor-pointer border-4 border-dashed active:scale-95 transition-all">
                        <div class="flex flex-col items-center">
                            <span class="glow-tag text-[9px] px-3 py-1 rounded-full font-black uppercase mb-4">EXCLUSIVE COMBO</span>
                            <h2 class="text-3xl font-black text-primary uppercase tracking-tighter leading-none mb-2">Build Your <br> Own Meal</h2>
                            <p class="text-[10px] text-secondary font-bold uppercase mt-2">Pick Snack + Drink + Peri Peri Fries!</p>
                            <h3 class="mt-4 font-black text-2xl text-primary">‚Çπ189</h3>
                            <button class="mt-8 brand-bg px-10 py-4 rounded-full font-black text-xs uppercase shadow-xl">Start Building</button>
                        </div>
                    </div>
                </div>
            </div>`;
    },

    builderModal() {
        app.state.builder = { snack: null, drink: null, fries: 'Peri Peri' };
        ui.showModal('builder-ui', `
            <div class="text-center">
                <h2 class="text-3xl font-black mb-1 uppercase tracking-tighter text-primary uppercase">HXOUSE MEAL</h2>
                <p class="text-secondary text-[10px] font-black uppercase tracking-widest mb-10 text-primary">Select your choices below</p>
                
                <div class="space-y-10">
                    <div>
                        <p class="text-[9px] font-black text-secondary uppercase tracking-[0.4em] mb-4 text-left px-2">1. PICK SNACK</p>
                        <div class="flex flex-wrap justify-center gap-2" id="snack-opts">
                            ${['Margherita', 'Paneer Tikka', 'Momos'].map(s => `<button data-val="${s}" onclick="ui.setBuilder('snack', '${s}')" class="option-button flex-grow p-4 bg-secondary border border-custom rounded-2xl font-black uppercase text-[10px] text-primary transition-all">${s}</button>`).join('')}
                        </div>
                    </div>

                    <div>
                        <p class="text-[9px] font-black text-secondary uppercase tracking-[0.4em] mb-4 text-left px-2">2. PICK DRINK</p>
                        <div class="grid grid-cols-2 gap-3" id="drink-opts">
                            <button data-val="2x Mojitos" onclick="ui.setBuilder('drink', '2x Mojitos')" class="option-button p-6 bg-secondary border border-custom rounded-[2rem] flex flex-col items-center transition-all">
                                <span class="text-2xl mb-2">üçπüçπ</span>
                                <span class="font-black uppercase text-[9px] text-primary">2x Mojitos</span>
                                <span class="text-[8px] opacity-40 uppercase font-black mt-1">Duo Pack</span>
                            </button>
                            <button data-val="1x Cold Frappe" onclick="ui.setBuilder('drink', '1x Cold Frappe')" class="option-button p-6 bg-secondary border border-custom rounded-[2rem] flex flex-col items-center transition-all">
                                <span class="text-2xl mb-2">ü•§</span>
                                <span class="font-black uppercase text-[9px] text-primary">Cold Frappe</span>
                                <span class="text-[8px] opacity-40 uppercase font-black mt-1">Solo Chill</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-primary border-2 border-custom border-dashed p-6 rounded-3xl flex justify-between items-center">
                        <div class="text-left">
                            <p class="text-[8px] font-black text-secondary uppercase tracking-widest">AUTO ADD-ON</p>
                            <h3 class="font-black uppercase text-sm text-primary">Peri Peri Fries</h3>
                        </div>
                        <span class="text-2xl">üî•</span>
                    </div>
                </div>

                <div class="mt-12">
                    <div class="flex justify-between items-center mb-6 px-4">
                        <span class="font-black uppercase text-secondary text-[10px] tracking-widest">Meal Total</span>
                        <span class="font-black text-3xl text-primary tracking-tighter">‚Çπ189</span>
                    </div>
                    <button onclick="app.addCustomCombo()" class="w-full brand-bg py-6 rounded-[2rem] font-black text-xl shadow-2xl uppercase tracking-widest">Finalize Meal</button>
                    <button onclick="ui.closeModal('builder-ui')" class="mt-6 opacity-30 font-black uppercase text-[10px] tracking-widest text-primary">Cancel</button>
                </div>
            </div>
        `);
    },

    setBuilder(type, val) {
        app.state.builder[type] = val;
        const selector = type === 'snack' ? '#snack-opts' : '#drink-opts';
        $$(selector + ' .option-button').forEach(btn => {
            if (btn.getAttribute('data-val') === val) btn.classList.add('active');
            else btn.classList.remove('active');
        });
    },

    menu(c) {
        c.innerHTML = `
            <div class="p-6 fade-in">
                <input type="text" placeholder="I'm craving..." class="w-full p-6 bg-secondary border border-custom rounded-2xl font-bold shadow-inner text-primary" oninput="app.state.searchQuery = this.value; ui.menuList()">
                <div id="menu-sections" class="space-y-4 mt-8"></div>
            </div>`;
        this.menuList();
    },

    menuList() {
        const target = $('#menu-sections'); if (!target) return;
        const q = app.state.searchQuery.toLowerCase();
        
        let html = `
            <div class="bg-secondary rounded-[2.5rem] border-2 border-brand-primary border-dashed overflow-hidden shadow-md mb-8 p-8 cursor-pointer transform active:scale-[0.98] transition" onclick="ui.builderModal()">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[8px] font-black uppercase text-brand-primary tracking-[0.2em] mb-1">LIMITED OFFER</p>
                        <h4 class="font-black text-lg uppercase text-primary leading-none">BUILD YOUR MEAL</h4>
                        <p class="text-xs text-secondary font-black uppercase mt-1">Snack + Drink + Fries</p>
                    </div>
                    <div class="text-right">
                        <span class="font-black text-2xl text-primary tracking-tighter">‚Çπ189</span>
                    </div>
                </div>
            </div>
        `;

        html += app.state.menuData.map(group => {
            const filtered = group.items.filter(i => i.name.toLowerCase().includes(q));
            if (filtered.length === 0 && q) return '';
            const isExp = app.state.expandedCategory === group.category || q;
            return `
                <div class="bg-secondary rounded-[2rem] border border-custom overflow-hidden mb-4">
                    <button onclick="app.state.expandedCategory='${group.category}'; ui.menuList()" class="w-full p-6 flex justify-between items-center font-black uppercase text-[10px] tracking-widest text-primary">
                        ${group.category} <span class="transition-transform ${isExp ? 'rotate-90' : ''}">‚Üí</span>
                    </button>
                    <div class="accordion-content ${isExp ? 'open' : ''}" style="max-height: ${isExp ? '1500px' : '0'}">
                        <div class="p-4 space-y-3">
                            ${filtered.map(i => `<div class="bg-primary p-5 rounded-[1.5rem] shadow-sm flex justify-between items-center border border-custom">
                                <div class="pr-4">
                                    <h4 class="font-black text-sm uppercase leading-tight text-primary">${i.name}</h4>
                                    <p class="text-secondary font-black text-[10px] opacity-50 tracking-widest">‚Çπ${i.price}</p>
                                </div>
                                <button onclick="app.addCart('${i.id}', 1)" class="add-to-cart-btn brand-bg font-black text-2xl active:scale-90 transition">+</button>
                            </div>`).join('')}
                        </div>
                    </div>
                </div>`;
        }).join('');
        target.innerHTML = html;
    },

    cart(c) {
        if (app.state.activeOrder) return this.track(c);
        if (app.state.cart.length === 0) return c.innerHTML = `<div class="p-20 text-center opacity-30 h-full flex flex-col justify-center"><p class="text-9xl mb-10">üõí</p><p class="font-black uppercase tracking-widest text-xs">Bag is Empty</p></div>`;
        const subtotal = app.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
        c.innerHTML = `
            <div class="p-6 space-y-6 pb-32 fade-in">
                <h2 class="text-4xl font-black tracking-tighter uppercase mb-10 text-primary">Selected Bag</h2>
                <div class="space-y-4">${app.state.cart.map(i => `
                    <div class="flex justify-between items-center p-6 bg-secondary rounded-[2rem] border border-custom shadow-sm">
                        <div class="flex-grow pr-4">
                            <p class="font-black text-sm uppercase text-primary leading-tight">${i.name}</p>
                            <p class="text-[9px] opacity-40 font-black mt-2 uppercase text-primary">‚Çπ${i.price} x ${i.quantity}</p>
                            ${i.description ? `<p class="text-[8px] text-brand-primary font-black uppercase mt-1">${i.description}</p>` : ''}
                        </div>
                        <div class="quantity-control shadow-sm">
                            <button onclick="app.addCart('${i.id}', -1)" class="px-3">‚àí</button><span>${i.quantity}</span><button onclick="app.addCart('${i.id}', 1)" class="px-3">+</button>
                        </div>
                    </div>`).join('')}
                </div>
                <div class="p-10 bg-secondary rounded-[3.5rem] border border-custom shadow-sm uppercase text-primary">
                    <div class="flex justify-between font-black text-3xl tracking-tighter uppercase"><span>Payable</span><span>‚Çπ${subtotal}</span></div>
                </div>
                <button onclick="ui.payModal()" class="w-full brand-bg py-8 rounded-[2.5rem] font-black text-2xl shadow-2xl uppercase tracking-tighter">Confirm Order</button>
            </div>`;
    },

    track(c) {
        const s = app.state.activeOrder?.status || 'received';
        c.innerHTML = `<div class="p-10 text-center space-y-16 fade-in h-full flex flex-col justify-center"><h2 class="text-5xl font-black uppercase leading-none text-primary">HXOUSE <br> Live Feed</h2><div class="relative h-6 w-full bg-secondary rounded-full border border-custom shadow-inner"><div class="absolute h-full brand-bg transition-all duration-1000" style="width: ${s === 'preparing' ? '66%' : '33%'}"></div></div><p class="text-xs font-black uppercase text-secondary tracking-widest">Admin Side: ${s.toUpperCase()}</p><button onclick="ui.gameModal()" class="bg-secondary px-12 py-5 rounded-full font-black text-xs border border-custom shadow-xl uppercase tracking-widest text-primary">Arcade</button></div>`;
    },

    social(c) {
        c.innerHTML = `
            <div class="p-6 space-y-12 fade-in h-full flex flex-col justify-center text-center">
                <h2 class="text-4xl font-black uppercase tracking-tighter leading-none text-primary">HXOUSE <br> Collective</h2>
                <div class="bg-secondary p-12 rounded-[4rem] border border-custom shadow-2xl">
                    <p class="instagram-card font-black text-4xl mb-12 tracking-tighter" onclick="window.open('https://instagram.com/hxousecoffeeco', '_blank')">@hxousecoffeeco</p>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https://instagram.com/hxousecoffeeco" class="mx-auto rounded-[3rem] border-8 border-white p-2 shadow-2xl scale-110">
                </div>
            </div>`;
    },

    aniga(c) {
        c.innerHTML = `
            <div class="p-6 flex flex-col h-full fade-in">
                <div class="flex-grow overflow-y-auto space-y-5 pr-2 pb-6" id="chat-window">
                    ${app.state.chatHistory.map(chat => `
                        <div class="flex ${chat.role === 'user' ? 'justify-end' : 'justify-start'}">
                            <div class="${chat.role === 'user' ? 'chat-bubble-user shadow-xl' : 'chat-bubble-aniga'} p-6 max-w-[90%] text-sm font-bold">${chat.text}</div>
                        </div>
                    `).join('')}
                    ${app.state.isListening ? `<div class="flex justify-start"><div class="chat-bubble-aniga p-5 flex space-x-2"><div class="w-2 h-2 brand-bg rounded-full animate-bounce"></div><div class="w-2 h-2 brand-bg rounded-full animate-bounce delay-100"></div><div class="w-2 h-2 brand-bg rounded-full animate-bounce delay-200"></div></div></div>` : ''}
                </div>
                <div class="mt-auto space-y-4">
                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Ask Aniga..." class="flex-grow p-6 bg-secondary border border-custom rounded-[2rem] font-bold text-sm text-primary shadow-inner">
                        <button onclick="app.handleAnigaInput($('#chat-input').value); $('#chat-input').value=''" class="brand-bg w-16 h-16 rounded-[2rem] flex items-center justify-center text-xl shadow-xl">‚ûî</button>
                    </div>
                    <button onclick="app.startVoice()" class="w-full flex items-center justify-center space-x-3 py-6 rounded-[2rem] bg-secondary border-2 border-custom font-black uppercase text-xs tracking-widest text-primary shadow-lg">${app.state.isListening ? 'Listening...' : 'üéôÔ∏è Voice Assist'}</button>
                </div>
            </div>`;
        const win = $('#chat-window'); win.scrollTop = win.scrollHeight;
    },

    more(c) {
        c.innerHTML = `
            <div class="p-8 space-y-6 fade-in">
                <h2 class="text-4xl font-black uppercase tracking-tighter mb-10 text-primary">Member</h2>
                <div class="bg-secondary p-12 rounded-[3rem] border border-custom shadow-xl mb-10">
                    <p class="font-black text-3xl tracking-tighter uppercase mb-2 text-primary">${app.state.customerProfile?.name || 'User'}</p>
                    <p class="text-[9px] opacity-40 uppercase tracking-[0.5em] text-primary">Member Since ${new Date().getFullYear()}</p>
                </div>
                <div class="space-y-4">
                    <button onclick="ui.gameModal()" class="w-full p-8 bg-secondary rounded-[2rem] text-left font-black border border-custom flex justify-between shadow-xl text-primary"><span>Arcade</span><span>üéÆ</span></button>
                    <button onclick="location.reload()" class="w-full p-8 bg-secondary rounded-[2rem] text-left font-black border border-custom flex justify-between shadow-xl text-primary"><span>Restart App</span><span>‚ü≥</span></button>
                </div>
                <p class="text-center text-[8px] font-black uppercase opacity-20 mt-20 tracking-[1em] text-primary">HXOUSE v3.4.1</p>
            </div>`;
    },

    payModal() {
        ui.showModal('pay-ui', `
            <h2 class="text-3xl font-black mb-12 uppercase text-primary">Checkout</h2>
            <div class="space-y-5">
                <button onclick="app.placeOrder()" class="w-full p-8 bg-secondary rounded-3xl text-left font-black border border-custom flex justify-between items-center shadow-xl uppercase text-[10px] tracking-widest text-primary"><span>Pay at Counter</span><span>üíµ</span></button>
                <button onclick="app.placeOrder()" class="w-full p-8 bg-secondary rounded-3xl text-left font-black border border-custom flex justify-between items-center shadow-xl uppercase text-[10px] tracking-widest text-primary"><span>UPI / Digital</span><span>üì±</span></button>
            </div>
            <button onclick="ui.closeModal('pay-ui')" class="w-full mt-10 opacity-30 font-black uppercase text-[10px] tracking-widest text-primary">Cancel</button>
        `);
    },

    gameModal() {
        ui.showModal('games-ui', `
            <h2 class="text-3xl font-black mb-12 uppercase text-primary text-center">Arcade</h2>
            <div class="space-y-5">
                <div class="bg-secondary p-12 rounded-[3rem] border border-custom flex justify-between items-center text-primary shadow-lg"><p class="font-black uppercase text-xs tracking-widest">Tic-Tac-Toe</p><button onclick="GAMES.ttt.start()" class="brand-bg px-12 py-5 rounded-full font-black text-[10px] shadow-xl">PLAY</button></div>
            </div>
            <button onclick="ui.closeModal('games-ui')" class="w-full mt-10 opacity-30 font-black uppercase text-[10px] tracking-widest text-primary">CLOSE</button>
        `);
    },

    showModal(id, content) {
        const m = document.createElement('div'); m.id = id; m.className = "modal-overlay fixed inset-0 bg-black/98 z-[60] flex items-end p-4 backdrop-blur-xl";
        m.innerHTML = `<div class="modal-content w-full bg-primary p-12 rounded-[4.5rem] shadow-2xl border border-custom">${content}</div>`;
        $('#modal-container').appendChild(m);
    },

    closeModal(id) { $(`#${id}`)?.remove(); },

    showToast(msg) {
        const t = $('#toast'); $('#toast-message').textContent = msg.toUpperCase();
        t.classList.remove('hidden'); t.classList.add('fade-in');
        setTimeout(() => t.classList.add('hidden'), 2500);
    },

    renderNav() {
        const nav = $('#bottom-nav');
        const items = [{ id: 'home', l: 'Home', i: 'üè†' }, { id: 'order', l: 'Store', i: '‚òï' }, { id: 'aniga', l: 'Aniga', i: '‚ú®' }, { id: 'cart', l: 'Live', i: 'üõí' }, { id: 'more', l: 'User', i: '‚ò∞' }];
        nav.innerHTML = items.map(item => `
            <button onclick="app.navigateTo('${item.id}')" class="nav-btn flex flex-col items-center flex-1 py-1 transition-all duration-300" id="nav-${item.id}">
                <div class="mb-2 text-2xl">${item.id === 'aniga' ? '<span class="aniga-float">‚ú®</span>' : item.i}</div>
                <span class="text-[8px] font-black uppercase tracking-[0.2em] opacity-40 text-primary">${item.l}</span>
            </button>
        `).join('');
    },

    updateNav() {
        $$('.nav-btn').forEach(btn => { btn.classList.remove('brand-text', 'scale-110'); btn.querySelector('span').classList.replace('opacity-100', 'opacity-40'); });
        const active = $(`#nav-${app.state.currentPage}`);
        if (active) { active.classList.add('brand-text', 'scale-110'); active.querySelector('span').classList.replace('opacity-40', 'opacity-100'); }
    }
};

const GAMES = {
    ttt: {
        board: Array(9).fill(null), p: 'X', win: null,
        start() {
            this.board.fill(null); this.p = 'X'; this.win = null;
            ui.showModal('ttt-run', `<h2 class="text-4xl font-black mb-12 text-center uppercase tracking-tighter text-primary">Match</h2><div class="grid grid-cols-3 gap-4 w-72 mx-auto mb-12">${this.board.map((_, i) => `<div onclick="GAMES.ttt.play(${i})" class="w-20 h-20 bg-secondary rounded-[1.5rem] flex items-center justify-center text-4xl font-black border-2 border-custom shadow-xl text-primary" id="ttt-${i}"></div>`).join('')}</div><p id="ttt-status" class="text-center font-black uppercase text-[10px] tracking-[0.6em] opacity-40 mb-12 text-primary">TURN: ${this.p}</p><button onclick="ui.closeModal('ttt-run')" class="w-full opacity-30 font-black uppercase text-[10px] tracking-widest text-primary">QUIT</button>`);
        },
        play(i) {
            if (this.board[i] || this.win) return;
            this.board[i] = this.p;
            $(`#ttt-${i}`).textContent = this.p;
            if (this.check()) { this.win = this.p; $('#ttt-status').textContent = `WINNER: ${this.p}`; $('#ttt-status').classList.add('brand-text'); }
            else if (this.board.every(b => b)) { $('#ttt-status').textContent = `DRAW!`; }
            else { this.p = this.p === 'X' ? 'O' : 'X'; $('#ttt-status').textContent = `TURN: ${this.p}`; }
        },
        check() { const w = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; return w.some(l => this.board[l[0]] && this.board[l[0]] === this.board[l[1]] && this.board[l[0]] === this.board[l[2]]); }
    }
};

window.addEventListener('load', () => app.init());
</script>
</body>
</html>
