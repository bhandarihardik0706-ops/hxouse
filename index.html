<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HXOUSE | The Collective Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary-light: #FFFFFF; --bg-secondary-light: #F8F9FA; --text-primary-light: #111827; --text-secondary-light: #6B7280; --border-light: #E5E7EB; --brand-primary-light: #111827;
            --bg-primary-dark: #0A0A0A; --bg-secondary-dark: #141414; --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF; --border-dark: #1F1F1F; --brand-primary-dark: #FFFFFF;
            --bg-primary-matcha: #F4FAF6; --bg-secondary-matcha: #E8F5EE; --text-primary-matcha: #2F4858; --text-secondary-matcha: #5C7A89; --border-matcha: #D1E7D9; --brand-primary-matcha: #3A8154;
        }
        [data-theme="light"] { --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border-color: var(--border-light); --brand-primary: var(--brand-primary-light); }
        [data-theme="dark"] { --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border-color: var(--border-dark); --brand-primary: var(--brand-primary-dark); }
        [data-theme="matcha"] { --bg-primary: var(--bg-primary-matcha); --bg-secondary: var(--bg-secondary-matcha); --text-primary: var(--text-primary-matcha); --text-secondary: var(--text-secondary-matcha); --border-color: var(--border-matcha); --brand-primary: var(--brand-primary-matcha); }

        html, body { height: 100%; overflow: hidden; margin: 0; background-color: var(--bg-secondary-light); }
        body { font-family: 'Poppins', sans-serif; color: var(--text-primary); -webkit-tap-highlight-color: transparent; transition: background 0.4s ease; }
        .app-container { background-color: var(--bg-primary); height: 100vh; display: flex; flex-direction: column; position: relative; }
        
        /* Fixed Splash Screen Color */
        #splash-screen { background-color: #FFFFFF; }

        .fade-in { animation: fadeIn 0.4s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); } @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .brand-text { color: var(--brand-primary); }
        .brand-bg { background-color: var(--brand-primary); color: var(--bg-primary); }
        .border-custom { border-color: var(--border-color); }
        
        .combo-card { background: linear-gradient(135deg, rgba(58, 129, 84, 0.1) 0%, rgba(58, 129, 84, 0.02) 100%); border: 2px dashed var(--brand-primary); }
        .option-button.active { background-color: var(--brand-primary) !important; color: var(--bg-primary) !important; transform: scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        
        .ticker-wrap { width: 100%; overflow: hidden; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); height: 30px; display: flex; align-items: center; }
        .ticker { display: inline-block; white-space: nowrap; animation: ticker 25s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        .quantity-pill { display: flex; align-items: center; background: var(--brand-primary); color: var(--bg-primary); border-radius: 99px; padding: 4px; gap: 12px; }
        .quantity-pill button { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-weight: 900; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .accordion-content { overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .menu-item-card { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .menu-item-card.in-cart { border-color: var(--brand-primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    </style>
</head>
<body data-theme="matcha">

    <!-- Splash Loader (White Background) -->
    <div id="splash-screen" class="fixed inset-0 flex flex-col items-center justify-center z-[100]">
        <img src="https://ttdnlatylcqrevzlyrru.supabase.co/storage/v1/object/public/assets/Untitled%20design_20251008_093211_0000.png" 
             alt="HXOUSE Logo" class="w-32 h-32 object-contain mb-8 animate-pulse">
        <div class="w-40 h-1 bg-gray-100 rounded-full overflow-hidden">
            <div id="loader-bar" class="h-full bg-black transition-all duration-300" style="width: 0%"></div>
        </div>
        <p class="mt-4 text-[8px] font-black uppercase tracking-[0.5em] text-gray-400">HXOUSE CORE v4.2</p>
    </div>

    <!-- Main App -->
    <div id="app" class="app-container max-w-lg mx-auto shadow-2xl hidden">
        
        <!-- Interactive Ticker -->
        <div class="ticker-wrap">
            <div class="ticker text-[9px] font-black uppercase tracking-widest text-secondary">
                SYST-ONLINE ‚Ä¢ CREATIVE COLLECTIVE BREWING ‚Ä¢ MARGHERITA COMBO POPULAR TODAY ‚Ä¢ STAY FOCUSED ‚Ä¢ NEW MUSIC PLAYING IN STUDIO ‚Ä¢ SYST-ONLINE ‚Ä¢
            </div>
        </div>

        <main class="flex-grow overflow-y-auto no-scrollbar relative">
            <div id="main-interface">
                <header id="page-header" class="sticky top-0 bg-primary z-20 h-20 px-6 flex justify-between items-center border-b border-custom">
                </header>
                <div id="page-content"></div>
            </div>
            <div class="h-28 flex-shrink-0"></div>
        </main>
        
        <!-- Navbar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 max-w-lg w-full bg-primary border-t border-custom flex justify-around items-center h-20 z-30 pb-4 shadow-2xl"></nav>
    </div>

    <div id="modal-container"></div>
    <div id="toast" class="hidden fixed bottom-28 left-1/2 -translate-x-1/2 brand-bg py-3 px-8 rounded-full shadow-2xl z-[70] whitespace-nowrap text-white font-black text-[10px] uppercase tracking-widest">
        <p id="toast-message"></p>
    </div>

<script>
/**
 * HXOUSE COFFEE CO.
 * VERSION 4.2 - ENGINE HARDENING & QUANTITY SYNC
 */

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

// Supabase Connection
const SUPABASE_URL = 'https://ttdnlatylcqrevzlyrru.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0ZG5sYXR5bGNxcmV2emx5cnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzAyMDEsImV4cCI6MjA3NTc0NjIwMX0.aiQ1_viA1JrugEyMWxA2e5f2Aqrao9BNgCTb70NWyCc';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const LOGO_URL = "https://ttdnlatylcqrevzlyrru.supabase.co/storage/v1/object/public/assets/Untitled%20design_20251008_093211_0000.png";

// Simple Audio Feedback
const sound = {
    click: () => {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, ctx.currentTime);
            gain.gain.setValueAtTime(0.05, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.1);
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
        } catch(e) {}
    }
};

const SNACK_PRICES = {
    'Margherita': 159, 'Paneer Tikka': 179, 'Veg Momos': 99, 'Paneer Momos': 119, 'Cheese Corn Momos': 129
};

const app = {
    state: {
        currentPage: 'home',
        cart: [],
        activeOrder: null,
        tableNumber: null,
        user: null,
        customerProfile: null,
        menuData: [],
        allMenuItems: [],
        expandedCategory: null,
        searchQuery: '',
        builder: { snack: null, drink: null, fries: 'Peri Peri', price: 0 }
    },

    async init() {
        this.setHeight();
        window.addEventListener('popstate', (e) => this.handleBack(e));
        
        const initialHash = location.hash.substring(1);
        this.state.currentPage = ['home', 'order', 'arcade', 'cart', 'more'].includes(initialHash) ? initialHash : 'home';
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 25;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                this.runStartup();
            }
            $('#loader-bar').style.width = progress + '%';
        }, 100);
    },

    setHeight() { document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`); },

    async runStartup() {
        try {
            const { data: { session } } = await sb.auth.getSession();
            this.state.user = session?.user;
            if (!this.state.user) {
                const { data: anon } = await sb.auth.signInAnonymously();
                this.state.user = anon.user;
            }

            await Promise.all([this.loadProfile(), this.loadMenu()]);
            this.parseTable();
            
            $('#splash-screen').style.display = 'none';
            $('#app').classList.remove('hidden');
            
            if (!this.state.customerProfile?.name) this.onboard();
            else if (this.state.tableNumber) this.launch();
            else this.askTable();
        } catch (e) { 
            console.error("Engine Start Fail:", e);
            ui.showToast("Engine Sync Error");
        }
    },

    async loadProfile() {
        const { data } = await sb.from('customers').select('*').eq('id', this.state.user.id).maybeSingle();
        if (data) this.state.customerProfile = data;
    },

    async loadMenu() {
        const { data } = await sb.from('products').select('*').eq('is_available', true).order('id');
        this.state.allMenuItems = data || [];
        this.state.menuData = (data || []).reduce((acc, item) => {
            let cat = acc.find(c => c.category === item.category);
            if (!cat) { cat = { category: item.category, items: [] }; acc.push(cat); }
            cat.items.push(item);
            return acc;
        }, []);
    },

    parseTable() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get('table');
        if (raw) {
            const map = { "6": 1, "10": 2, "1": 3, "7": 4, "4": 6, "3": 7, "2": 8 };
            this.state.tableNumber = parseInt(map[raw] || raw);
        }
    },

    launch() {
        this.fetchActiveOrder();
        ui.renderNav();
        this.navigateTo(this.state.currentPage, false);
    },

    onboard() {
        ui.showModal('onboard-ui', `
            <div class="text-center p-4">
                <img src="${LOGO_URL}" class="h-16 mx-auto mb-6">
                <h2 class="text-2xl font-black mb-6 text-primary uppercase tracking-tighter">HXOUSE ID</h2>
                <div class="space-y-3">
                    <input type="text" id="ob-name" class="w-full p-5 bg-secondary border border-custom rounded-2xl font-bold text-center text-primary focus:border-brand-primary outline-none" placeholder="Enter Full Name">
                    <input type="tel" id="ob-phone" class="w-full p-5 bg-secondary border border-custom rounded-2xl font-bold text-center text-primary focus:border-brand-primary outline-none" placeholder="WhatsApp Number">
                </div>
                <button onclick="app.submitOnboard()" class="w-full brand-bg mt-8 py-5 rounded-3xl font-black text-lg uppercase tracking-widest shadow-xl active:scale-95 transition">Join Collective</button>
            </div>
        `);
    },

    async submitOnboard() {
        const name = $('#ob-name').value.trim();
        const phone = $('#ob-phone').value.trim();
        if (!name || phone.length < 10) return ui.showToast("Incomplete Identity");
        try {
            const profile = { id: this.state.user.id, name, whatsapp_number: phone, loyalty_points: 0 };
            await sb.from('customers').upsert(profile);
            this.state.customerProfile = profile;
            ui.closeModal('onboard-ui');
            if (this.state.tableNumber) this.launch(); else this.askTable();
        } catch (e) { ui.showToast("Identity Error"); }
    },

    askTable() {
        ui.showModal('table-ui', `
            <h2 class="text-2xl font-black mb-8 text-center text-primary uppercase">Current Spot</h2>
            <div class="grid grid-cols-5 gap-2 mb-8">
                ${[1,2,3,4,5,6,7,8,9,10].map(n => `<button onclick="$('#manual-table').value=${n}" class="p-4 bg-secondary rounded-xl font-black border border-custom active:brand-bg text-primary transition-all">${n}</button>`).join('')}
            </div>
            <input type="number" id="manual-table" class="w-full p-5 border border-custom rounded-2xl bg-secondary font-black text-center text-3xl text-primary" placeholder="--">
            <button onclick="app.submitTable()" class="w-full brand-bg py-5 rounded-3xl font-black text-lg uppercase mt-4 active:scale-95 transition">Verify Table</button>
        `);
    },

    submitTable() {
        const v = parseInt($('#manual-table').value);
        if (!v) return;
        this.state.tableNumber = v;
        ui.closeModal('table-ui');
        this.launch();
    },

    navigateTo(page, push = true) {
        if (push) location.hash = page;
        this.state.currentPage = page;
        ui.renderHeader();
        ui.renderContent();
        ui.updateNav();
        $('#app main').scrollTo(0, 0);
    },

    handleBack(e) {
        const modal = $('#modal-container').lastElementChild;
        if (modal) { ui.closeModal(modal.id); e.preventDefault(); return; }
        if (this.state.currentPage !== 'home') { this.navigateTo('home'); e.preventDefault(); }
    },

    addCart(id, change) {
        sound.click();
        const item = this.state.allMenuItems.find(i => i.id == id);
        let cartItem = this.state.cart.find(i => i.id == id);
        if (!cartItem && change > 0) { 
            this.state.cart.push({ ...item, quantity: 1 }); 
        } else if (cartItem) {
            cartItem.quantity += change;
            if (cartItem.quantity <= 0) this.state.cart = this.state.cart.filter(i => i.id != id);
        }
        
        // Dynamic UI update: Refresh menu or cart list
        if (this.state.currentPage === 'order') this.menuList();
        else ui.renderContent();
    },

    async fetchActiveOrder() {
        const { data } = await sb.from('orders')
            .select('*, order_items(*)')
            .eq('customer_id', this.state.user.id)
            .in('status', ['received', 'preparing'])
            .order('created_at', { ascending: false }).limit(1).maybeSingle();
        
        if (data) {
            this.state.activeOrder = data;
            this.subscribeRealtime(data.id);
        } else {
            this.state.activeOrder = null;
        }
        ui.renderContent();
    },

    subscribeRealtime(id) {
        sb.channel(`order-${id}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${id}` }, p => {
            this.state.activeOrder = p.new;
            if (['delivered', 'cancelled'].includes(p.new.status)) { 
                this.state.activeOrder = null; 
                ui.showToast(`Order: ${p.new.status.toUpperCase()}`); 
            }
            ui.renderContent();
        }).subscribe();
    },

    async placeOrder(btn) {
        btn.disabled = true;
        btn.innerHTML = `<span class="animate-pulse">COMMUNICATING...</span>`;
        
        const subtotal = this.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
        const total = Math.round(subtotal * 1.05);

        try {
            // 1. Create Order (Using basic fields to avoid Engine Errors)
            const { data: order, error: orderErr } = await sb.from('orders').insert({
                customer_id: this.state.user.id,
                table_number: this.state.tableNumber,
                total_amount: total,
                status: 'received'
            }).select().single();

            if (orderErr) throw orderErr;

            // 2. Add Order Items
            const items = this.state.cart.map(i => ({
                order_id: order.id,
                product_id: isNaN(i.id) ? 1 : parseInt(i.id),
                quantity: i.quantity,
                price_at_time_of_order: i.price
            }));

            const { error: itemErr } = await sb.from('order_items').insert(items);
            if (itemErr) throw itemErr;

            confetti({ particleCount: 150, spread: 60, origin: { y: 0.7 } });
            this.state.cart = [];
            ui.closeModal('pay-ui');
            ui.showToast("Order Dispatched");
            await this.fetchActiveOrder();
            this.navigateTo('cart');
        } catch (e) {
            console.error("Supabase Error:", e);
            ui.showToast("Engine Error: Retry");
            btn.disabled = false;
            btn.innerHTML = "Retry Order";
        }
    }
};

const ui = {
    renderHeader() {
        const h = $('#page-header');
        h.innerHTML = `
            <div onclick="app.navigateTo('home')" class="cursor-pointer">
                <img src="${LOGO_URL}" class="h-10 w-auto object-contain">
            </div>
            <div class="flex items-center space-x-3">
                <div class="text-right">
                    <p class="font-black text-xs uppercase text-primary">Table #${app.state.tableNumber || '?'}</p>
                    <p class="text-[7px] uppercase opacity-40 font-black text-primary truncate max-w-[70px]">${app.state.customerProfile?.name || 'HX-User'}</p>
                </div>
            </div>`;
    },

    renderContent() {
        const c = $('#page-content');
        const p = app.state.currentPage;
        if (p === 'home') this.home(c);
        else if (p === 'order') this.menu(c);
        else if (p === 'arcade') this.arcade(c);
        else if (p === 'cart') this.cart(c);
        else if (p === 'more') this.more(c);
    },

    home(c) {
        c.innerHTML = `
            <div class="space-y-6 fade-in pb-10">
                <div class="relative h-64 overflow-hidden rounded-b-[4rem] shadow-xl">
                    <video src="https://ttdnlatylcqrevzlyrru.supabase.co/storage/v1/object/public/assets/lv_0_20251012011509.mp4" autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover opacity-60"></video>
                    <div class="absolute inset-0 bg-black/40 flex flex-col items-center justify-center text-white p-6">
                        <h1 class="text-5xl font-black tracking-tighter uppercase leading-none text-center">Fuel the <br> Hustle</h1>
                        <p class="text-[9px] font-bold tracking-[0.5em] mt-6 opacity-60 uppercase">STUDIO EDITION</p>
                    </div>
                </div>

                <div class="px-6">
                    <div onclick="ui.builderModal()" class="combo-card p-10 rounded-[3.5rem] text-center shadow-lg cursor-pointer transform hover:scale-[1.01] active:scale-95 transition">
                        <span class="bg-black text-white text-[8px] px-4 py-1 rounded-full font-black uppercase mb-4 inline-block">MEMBER ONLY</span>
                        <h2 class="text-3xl font-black text-primary uppercase tracking-tighter leading-none mb-1">Construct <br> Your Meal</h2>
                        <h3 class="mt-4 font-black text-xl text-primary opacity-60 tracking-tighter">Starts ‚Çπ99</h3>
                    </div>
                </div>

                <div class="px-6 pb-10">
                    <h4 class="text-[9px] font-black uppercase tracking-widest text-secondary mb-4 ml-1">App Atmosphere</h4>
                    <div class="flex space-x-2 overflow-x-auto no-scrollbar">
                        <button onclick="document.body.dataset.theme='matcha'; sound.click();" class="px-6 py-3 bg-secondary border border-custom rounded-full text-[9px] font-black uppercase text-primary">üçµ Matcha</button>
                        <button onclick="document.body.dataset.theme='dark'; sound.click();" class="px-6 py-3 bg-secondary border border-custom rounded-full text-[9px] font-black uppercase text-primary">üåö Night</button>
                        <button onclick="document.body.dataset.theme='light'; sound.click();" class="px-6 py-3 bg-secondary border border-custom rounded-full text-[9px] font-black uppercase text-primary">üé® Light</button>
                    </div>
                </div>
            </div>`;
    },

    menu(c) {
        c.innerHTML = `
            <div class="p-6 fade-in pb-10">
                <div class="relative mb-6">
                    <input type="text" placeholder="I'm looking for..." class="w-full p-5 bg-secondary border border-custom rounded-2xl font-bold text-primary outline-none focus:border-brand-primary" oninput="app.state.searchQuery = this.value; ui.menuList()">
                    <span class="absolute right-5 top-5 opacity-20 text-lg">üîç</span>
                </div>
                <div id="menu-sections" class="space-y-4"></div>
            </div>`;
        this.menuList();
    },

    menuList() {
        const target = $('#menu-sections'); if (!target) return;
        const q = app.state.searchQuery.toLowerCase();
        
        target.innerHTML = app.state.menuData.map(group => {
            const filtered = group.items.filter(i => i.name.toLowerCase().includes(q));
            if (filtered.length === 0 && q) return '';
            const isExp = app.state.expandedCategory === group.category || q;
            
            return `
                <div class="bg-secondary rounded-[2.5rem] border border-custom overflow-hidden mb-4">
                    <button onclick="app.state.expandedCategory = app.state.expandedCategory === '${group.category}' ? null : '${group.category}'; ui.menuList()" class="w-full p-6 flex justify-between items-center font-black uppercase text-[10px] tracking-widest text-primary">
                        ${group.category} <span class="text-lg transition-transform ${isExp ? 'rotate-180' : ''}">‚Üì</span>
                    </button>
                    <div class="accordion-content" style="max-height: ${isExp ? '2000px' : '0'}">
                        <div class="p-3 space-y-2">
                            ${filtered.map(i => {
                                const inCart = app.state.cart.find(c => c.id == i.id);
                                return `
                                <div class="menu-item-card bg-primary p-5 rounded-[2rem] flex justify-between items-center border border-custom ${inCart ? 'in-cart' : ''}">
                                    <div class="pr-2 truncate">
                                        <h4 class="font-black text-xs uppercase text-primary truncate">${i.name}</h4>
                                        <p class="text-secondary font-black text-[9px] opacity-50 mt-1">‚Çπ${i.price}</p>
                                    </div>
                                    <div class="flex items-center">
                                        ${inCart ? `
                                            <div class="quantity-pill">
                                                <button onclick="app.addCart('${i.id}', -1)">‚àí</button>
                                                <span class="text-[10px] font-black">${inCart.quantity}</span>
                                                <button onclick="app.addCart('${i.id}', 1)">+</button>
                                            </div>
                                        ` : `
                                            <button onclick="app.addCart('${i.id}', 1)" class="w-10 h-10 brand-bg rounded-full flex items-center justify-center font-black text-xl active:scale-90 transition">+</button>
                                        `}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
        }).join('');
    },

    cart(c) {
        if (app.state.activeOrder) return this.track(c);
        if (app.state.cart.length === 0) return c.innerHTML = `<div class="p-20 text-center h-full flex flex-col justify-center items-center"><span class="text-[80px] opacity-10 mb-6">üõí</span><p class="font-black uppercase tracking-widest text-[9px] text-secondary">Bag is empty</p><button onclick="app.navigateTo('order')" class="mt-8 font-black border-b-2 border-brand-primary text-primary text-[10px] uppercase tracking-widest">Open Menu</button></div>`;
        
        const subtotal = app.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
        c.innerHTML = `
            <div class="p-6 space-y-6 pb-24 fade-in">
                <h2 class="text-4xl font-black uppercase text-primary">Your Bag</h2>
                <div class="space-y-3">${app.state.cart.map(i => `
                    <div class="flex justify-between items-center p-5 bg-secondary rounded-[2rem] border border-custom">
                        <div class="flex-grow pr-3 truncate">
                            <p class="font-black text-xs uppercase text-primary truncate">${i.name}</p>
                            <p class="text-[8px] opacity-40 font-black mt-1 uppercase text-primary">‚Çπ${i.price} x ${i.quantity}</p>
                        </div>
                        <div class="quantity-pill">
                            <button onclick="app.addCart('${i.id}', -1)">‚àí</button>
                            <span class="text-xs font-black">${i.quantity}</span>
                            <button onclick="app.addCart('${i.id}', 1)">+</button>
                        </div>
                    </div>`).join('')}
                </div>
                <div class="p-8 bg-secondary rounded-[3rem] border border-custom shadow-md text-primary">
                    <div class="flex justify-between font-black text-[9px] opacity-40 mb-2 uppercase"><span>Subtotal</span><span>‚Çπ${subtotal}</span></div>
                    <div class="flex justify-between font-black text-[9px] opacity-40 mb-6 uppercase"><span>Tax (5%)</span><span>‚Çπ${(subtotal * 0.05).toFixed(0)}</span></div>
                    <div class="flex justify-between font-black text-3xl tracking-tighter uppercase"><span>Total</span><span>‚Çπ${Math.round(subtotal * 1.05)}</span></div>
                </div>
                <button onclick="ui.payModal()" class="w-full brand-bg py-6 rounded-[2.5rem] font-black text-xl shadow-xl uppercase tracking-widest active:scale-95 transition">Check Out</button>
            </div>`;
    },

    track(c) {
        const s = app.state.activeOrder?.status || 'received';
        const prog = s === 'received' ? '33%' : s === 'preparing' ? '66%' : '100%';
        c.innerHTML = `
            <div class="p-10 text-center h-full flex flex-col justify-center items-center space-y-10">
                <h2 class="text-6xl font-black uppercase text-primary leading-none">Order <br> Pulse</h2>
                <div class="w-full space-y-6">
                    <div class="relative h-3 w-full bg-secondary rounded-full border border-custom overflow-hidden">
                        <div class="absolute h-full brand-bg transition-all duration-[1000ms]" style="width: ${prog}"></div>
                    </div>
                    <div class="flex justify-between text-[7px] font-black uppercase tracking-widest opacity-40">
                        <span class="${s === 'received' ? 'opacity-100 brand-text' : ''}">Received</span>
                        <span class="${s === 'preparing' ? 'opacity-100 brand-text' : ''}">Cooking</span>
                        <span class="${s === 'delivered' ? 'opacity-100 brand-text' : ''}">Ready</span>
                    </div>
                </div>
                <div class="bg-secondary p-8 rounded-[3rem] border border-custom w-full">
                    <p class="text-xs font-bold text-primary italic">"Preparing your brew. Get back to creating."</p>
                </div>
            </div>`;
    },

    payModal() {
        ui.showModal('pay-ui', `
            <h2 class="text-3xl font-black mb-8 uppercase text-primary text-center">Payment Method</h2>
            <div class="space-y-3">
                <button onclick="app.placeOrder(this)" class="w-full p-8 bg-secondary rounded-3xl text-left font-black border border-custom flex justify-between items-center text-primary uppercase text-[10px] tracking-widest active:brand-bg transition"><span>Pay at Counter</span><span>üí¥</span></button>
                <button onclick="app.placeOrder(this)" class="w-full p-8 bg-secondary rounded-3xl text-left font-black border border-custom flex justify-between items-center text-primary uppercase text-[10px] tracking-widest active:brand-bg transition"><span>Scan & Pay (UPI)</span><span>üì±</span></button>
            </div>
            <button onclick="ui.closeModal('pay-ui')" class="w-full mt-8 opacity-20 font-black uppercase text-[9px] tracking-widest text-primary text-center">Cancel Order</button>
        `);
    },

    showModal(id, content) {
        const m = document.createElement('div'); m.id = id; 
        m.className = "modal-overlay fixed inset-0 bg-black/80 z-[60] flex items-end p-4 backdrop-blur-sm";
        m.innerHTML = `<div class="modal-content w-full bg-primary p-10 rounded-[4rem] shadow-2xl border border-custom overflow-hidden">${content}</div>`;
        $('#modal-container').appendChild(m);
    },

    closeModal(id) { $(`#${id}`)?.remove(); },

    showToast(msg) {
        const t = $('#toast'); $('#toast-message').textContent = msg.toUpperCase();
        t.classList.remove('hidden', 'fade-in'); void t.offsetWidth;
        t.classList.add('fade-in');
        setTimeout(() => t.classList.add('hidden'), 2500);
    },

    renderNav() {
        const nav = $('#bottom-nav');
        const items = [
            { id: 'home', l: 'Studio', i: 'üè†' }, { id: 'order', l: 'Menu', i: '‚òï' }, 
            { id: 'arcade', l: 'Play', i: 'üéÆ' }, { id: 'cart', l: 'Bag', i: 'üõí' }, { id: 'more', l: 'ID', i: '‚ò∞' }
        ];
        nav.innerHTML = items.map(item => `
            <button onclick="app.navigateTo('${item.id}')" class="nav-btn flex flex-col items-center flex-1 py-1" id="nav-${item.id}">
                <div class="mb-1 text-2xl">${item.i}</div>
                <span class="text-[7px] font-black uppercase tracking-widest opacity-30 text-primary">${item.l}</span>
            </button>
        `).join('');
    },

    updateNav() {
        $$('.nav-btn').forEach(btn => { 
            btn.classList.remove('brand-text', 'scale-110'); 
            btn.querySelector('span').classList.replace('opacity-100', 'opacity-30'); 
        });
        const active = $(`#nav-${app.state.currentPage}`);
        if (active) { 
            active.classList.add('brand-text', 'scale-110'); 
            active.querySelector('span').classList.replace('opacity-30', 'opacity-100'); 
        }
    }
};

window.addEventListener('load', () => app.init());
</script>
</body>
</html>
