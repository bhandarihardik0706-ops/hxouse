<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Welcome to HXOUSE Coffee Co.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400..900&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary-light: #FFFFFF; --bg-secondary-light: #F3F4F6; --text-primary-light: #111827; --text-secondary-light: #6B7280; --border-light: #E5E7EB; --brand-primary-light: #111827;
            --bg-primary-dark: #111111; --bg-secondary-dark: #1F2023; --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF; --border-dark: #374151; --brand-primary-dark: #FFFFFF;
            --bg-primary-matcha: #F0FFF4; --bg-secondary-matcha: #DCF2E3; --text-primary-matcha: #2F4858; --text-secondary-matcha: #5C7A89; --border-matcha: #B8D8C0; --brand-primary-matcha: #3A8154;
            --app-height: 100vh;
        }
        [data-theme="light"] { --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border-color: var(--border-light); --brand-primary: var(--brand-primary-light); }
        [data-theme="dark"] { --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border-color: var(--border-dark); --brand-primary: var(--brand-primary-dark); }
        [data-theme="matcha"] { --bg-primary: var(--bg-primary-matcha); --bg-secondary: var(--bg-secondary-matcha); --text-primary: var(--text-primary-matcha); --text-secondary: var(--text-secondary-matcha); --border-color: var(--border-matcha); --brand-primary: var(--brand-primary-matcha); }

        html, body { height: 100%; overflow: hidden; margin: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: #000000; color: var(--text-primary); -webkit-tap-highlight-color: transparent; transition: background-color 0.5s ease; }
        .app-container { background-color: var(--bg-primary); transition: background-color 0.5s ease; height: var(--app-height); }
        .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); }
        .bg-primary { background-color: var(--bg-primary); } .bg-secondary { background-color: var(--bg-secondary); }
        .border-custom { border-color: var(--border-color); } .brand-text { color: var(--brand-primary); }
        .brand-bg { background-color: var(--brand-primary); color: var(--bg-primary); }

        .fade-in { animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { animation: fadeIn 0.3s ease; }
        .modal-content { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #splash-screen img { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .accordion-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; }
        .accordion-content.open { opacity: 1; }

        .tracker-container { display: flex; align-items: center; justify-content: space-between; position: relative; }
        .tracker-line-container { position: absolute; top: 18px; left: 40px; right: 40px; height: 4px; background-color: var(--border-color); border-radius: 2px; }
        .tracker-progress { height: 100%; background-color: var(--brand-primary); border-radius: 2px; transition: width 0.5s ease-in-out; }
        .tracker-step { display: flex; flex-direction: column; align-items: center; text-align: center; width: 80px; position: relative; z-index: 1; }
        .tracker-icon-container { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-primary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; font-size: 20px; }
        .tracker-step.active .tracker-icon-container { border-color: var(--brand-primary); background-color: var(--brand-primary); color: var(--bg-primary); transform: scale(1.1); }

        .instagram-card { background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .classy-x { font-family: 'Playfair Display', serif; font-style: italic; font-weight: 600; font-size: 1.5em; vertical-align: -0.2em; }
        
        .quantity-control { display: flex; align-items: center; justify-content: space-between; background-color: var(--brand-primary); color: var(--bg-primary); border-radius: 9999px; font-weight: 600; overflow: hidden; width: 100px; height: 40px; }
        .add-to-cart-btn { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-primary); color: var(--brand-primary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        
        #loyalty-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; }
        #loyalty-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: var(--brand-primary); border-radius: 50%; cursor: pointer; }

        .accordion-arrow { transition: transform 0.3s ease; }
        .rotate-90 { transform: rotate(90deg); }
        .accordion-item-list { padding-left: 1rem; padding-right: 1rem; padding-bottom: 1rem; display: grid; gap: 0.75rem; }
    </style>
</head>
<body data-theme="matcha">

    <div id="splash-screen" class="fixed inset-0 bg-primary flex flex-col items-center justify-center z-[100]">
        <img src="https://qaytrfhpqsajgfqedxak.supabase.co/storage/v1/object/public/assets/WhatsApp%20Image%202025-10-08%20at%2009.25.36_1c1533ac.jpg" alt="HXOUSE Logo" class="w-48 h-48 object-contain rounded-full shadow-2xl">
        <div id="splash-loading" class="mt-8 flex flex-col items-center">
            <div class="spinner border-4 border-t-brand w-8 h-8 rounded-full animate-spin mb-4"></div>
            <p class="text-secondary text-xs font-bold tracking-widest animate-pulse">BREWING CONNECTION...</p>
        </div>
    </div>

    <div id="app" class="app-container max-w-lg mx-auto shadow-2xl flex flex-col hidden">
        <main class="flex-grow overflow-y-auto">
            <div id="main-interface" class="hidden">
                <header id="page-header" class="sticky top-0 bg-primary z-20 h-16 px-4 flex justify-between items-center border-b border-custom"></header>
                <div id="page-content"></div>
            </div>
            <div class="h-20 flex-shrink-0"></div>
        </main>
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 max-w-lg w-full bg-primary border-t border-custom flex justify-around items-center h-16 z-30 hidden pb-2"></nav>
    </div>

    <div id="modal-container"></div>
    <div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2 brand-bg py-3 px-5 rounded-lg shadow-xl z-50 whitespace-nowrap text-white font-bold">
        <p id="toast-message"></p>
    </div>

<script>
/**
 * HXOUSE COFFEE CO.
 * STABILITY PATCH: ONBOARDING & AUTH FIX
 */

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

const SUPABASE_URL = 'https://ttdnlatylcqrevzlyrru.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0ZG5sYXR5bGNxcmV2emx5cnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzAyMDEsImV4cCI6MjA3NTc0NjIwMX0.aiQ1_viA1JrugEyMWxA2e5f2Aqrao9BNgCTb70NWyCc';

// Renamed to 'sb' to prevent global naming conflict with Supabase JS library
const sb = self.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const PAGES = ['home', 'order', 'cart', 'social', 'cowork', 'more'];

const app = {
    state: {
        currentPage: 'home',
        cart: [],
        activeOrder: null,
        tableNumber: null,
        user: null,
        customerProfile: null,
        theme: 'matcha',
        menuData: [],
        allMenuItems: [],
        expandedCategory: null,
        searchQuery: '',
        pointsToRedeem: 0,
    },

    async init() {
        this.setHeight();
        window.addEventListener('resize', () => this.setHeight());
        window.addEventListener('popstate', (e) => this.handleHardwareBack(e));

        const initialHash = location.hash.substring(1);
        this.state.currentPage = PAGES.includes(initialHash) ? initialHash : 'home';
        
        await this.startAppFlow();
    },

    setHeight() { document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`); },

    async startAppFlow() {
        console.log("üöÄ HXOUSE: Initialization sequence started...");
        
        // Safety Timeout: If loading takes > 8 seconds, show manual skip
        const loadTimeout = setTimeout(() => {
            console.warn("‚ö†Ô∏è HXOUSE: Supabase taking too long. Check Internet or dashboard settings.");
            $('#splash-loading').innerHTML = `
                <p class="text-red-500 font-bold mb-4">Connection slow...</p>
                <button onclick="location.reload()" class="bg-secondary p-3 rounded-xl font-bold mb-2">Retry Connection</button>
                <p class="text-[10px] text-secondary opacity-50 px-6 text-center">Ensure "Anonymous Auth" is enabled in Supabase Providers.</p>
            `;
        }, 8000);

        try {
            // 1. Auth Bridge
            const { data: { session }, error: sessionError } = await sb.auth.getSession();
            if (sessionError) throw sessionError;
            this.state.user = session?.user;
            
            if (!this.state.user) {
                console.log("üîê HXOUSE: No session. Authenticating anonymously...");
                const { data: anonData, error: anonError } = await sb.auth.signInAnonymously();
                if (anonError) {
                    console.error("‚ùå Auth Error:", anonError);
                    throw new Error("Anonymous Auth is likely DISABLED in your dashboard.");
                }
                this.state.user = anonData.user;
            }
            console.log("üë§ HXOUSE: User ID established:", this.state.user.id);

            // 2. Data Sync
            await Promise.all([
                this.fetchCustomerProfile(),
                this.fetchMenuData()
            ]);

            this.getTableNumberFromURL();

            if (this.state.menuData.length > 0) this.state.expandedCategory = this.state.menuData[0].category;

            // Clear timeout and Launch
            clearTimeout(loadTimeout);
            $('#splash-screen').style.display = 'none';
            $('#app').classList.remove('hidden');
            $('#app').classList.add('flex');

            if (!this.state.customerProfile || !this.state.customerProfile.name) {
                console.log("üìù HXOUSE: Profile needed.");
                this.showOnboardingModal();
            } else if (this.state.tableNumber) {
                console.log("‚ú® HXOUSE: Launching session.");
                this.startSession();
            } else {
                this.showTableNumberModal();
            }
        } catch (e) {
            console.error("‚ùå HXOUSE Startup Failed:", e);
            clearTimeout(loadTimeout);
            $('#splash-loading').innerHTML = `
                <p class="text-red-500 font-bold mb-2">System Error</p>
                <p class="text-xs text-secondary px-8 mb-6">${e.message}</p>
                <button onclick="location.reload()" class="bg-primary text-secondary px-8 py-3 rounded-full font-bold shadow-xl">Re-Init</button>
            `;
        }
    },

    async fetchCustomerProfile() {
        console.log("üì° HXOUSE: Fetching profile...");
        const { data, error } = await sb.from('customers').select('*').eq('id', this.state.user.id).maybeSingle();
        if (error) console.warn("Profile fetch warning:", error);
        this.state.customerProfile = data;
    },

    async fetchMenuData() {
        console.log("üì° HXOUSE: Fetching menu...");
        const { data, error } = await sb.from('products').select('*').eq('is_available', true).order('id');
        if (error) throw error;
        this.state.allMenuItems = data;
        this.state.menuData = data.reduce((acc, item) => {
            let cat = acc.find(c => c.category === item.category);
            if (!cat) { cat = { category: item.category, items: [] }; acc.push(cat); }
            cat.items.push(item);
            return acc;
        }, []);
    },

    getTableNumberFromURL() {
        const params = new URLSearchParams(window.location.search);
        const scanned = params.get('table');
        if (scanned) {
            const fixMap = { "6": 1, "10": 2, "1": 3, "7": 4, "4": 6, "3": 7, "2": 8 };
            this.state.tableNumber = parseInt(fixMap[scanned] || scanned);
        }
    },

    async startSession() {
        await this.fetchActiveOrder();
        $('#main-interface').classList.remove('hidden');
        $('#bottom-nav').classList.remove('hidden');
        ui.renderBottomNav();
        this.navigateTo(this.state.currentPage, false);
    },

    showOnboardingModal() {
        ui.showModal('onboarding-modal', `
            <h2 class="text-2xl font-bold text-primary mb-2 text-center uppercase tracking-tighter">New Member</h2>
            <p class="text-secondary mb-8 text-center text-sm">Please register to access orders and rewards.</p>
            <div class="space-y-4">
                <input type="text" id="ob-name" class="w-full p-5 border border-custom rounded-2xl bg-secondary text-primary font-bold" placeholder="Full Name">
                <input type="tel" id="ob-phone" class="w-full p-5 border border-custom rounded-2xl bg-secondary text-primary font-bold" placeholder="WhatsApp Number">
                ${!this.state.tableNumber ? `<input type="number" id="ob-table" class="w-full p-5 border border-custom rounded-2xl bg-secondary text-primary font-bold" placeholder="Table #">` : ''}
            </div>
            <button id="ob-submit" onclick="app.completeOnboarding()" class="w-full mt-10 brand-bg font-bold py-5 rounded-2xl shadow-2xl uppercase tracking-widest text-sm active:scale-95 transition">Enter HXOUSE</button>
        `);
    },

    async completeOnboarding() {
        const name = $('#ob-name').value.trim();
        const phone = $('#ob-phone').value.trim();
        const table = this.state.tableNumber || parseInt($('#ob-table')?.value);
        const btn = $('#ob-submit');

        if (!name || phone.length < 10 || isNaN(table)) return ui.showToast("Incomplete details");

        btn.disabled = true; btn.innerHTML = "Creating Profile...";

        try {
            const profile = { id: this.state.user.id, name, whatsapp_number: phone, loyalty_points: 0 };
            // Using insert for first time onboarding to avoid conflict logic
            const { error } = await sb.from('customers').upsert(profile);
            if (error) throw error;

            this.state.customerProfile = profile;
            this.state.tableNumber = table;
            ui.closeModal('onboarding-modal');
            this.startSession();
        } catch (e) {
            console.error("Onboarding logic error:", e);
            ui.showToast("Phone number might be in use.");
            btn.disabled = false; btn.innerHTML = "Enter HXOUSE";
        }
    },

    showTableNumberModal() {
        ui.showModal('table-modal', `
            <h2 class="text-2xl font-bold text-primary mb-6 text-center uppercase tracking-tighter">Your Location</h2>
            <input type="number" id="manual-table" class="w-full p-5 border border-custom rounded-2xl bg-secondary text-primary text-center font-bold text-2xl shadow-inner" placeholder="0">
            <button onclick="app.completeTableManual()" class="w-full mt-8 brand-bg font-bold py-5 rounded-2xl shadow-2xl uppercase tracking-widest text-sm">Set Spot</button>
        `);
    },

    completeTableManual() {
        const val = $('#manual-table').value;
        if (!val) return ui.showToast("Required");
        this.state.tableNumber = parseInt(val);
        ui.closeModal('table-modal');
        this.startSession();
    },

    navigateTo(page, push = true) {
        if (push) location.hash = page;
        this.state.currentPage = page;
        ui.renderHeader(page);
        ui.renderPageContent(page);
        ui.updateActiveNav(page);
    },

    handleHardwareBack(e) {
        const modal = $('#modal-container').children[0];
        if (modal) { ui.closeModal(modal.id); e.preventDefault(); return; }
        if (this.state.currentPage !== 'home') { this.navigateTo('home'); e.preventDefault(); }
    },

    toggleCategory(cat) {
        const id = cat.replace(/\s+/g, '-').toUpperCase();
        const div = $(`#items-for-${id}`);
        if (this.state.expandedCategory === cat) {
            div.style.maxHeight = '0'; div.classList.remove('open');
            this.state.expandedCategory = null;
        } else {
            if (this.state.expandedCategory) {
                const prevId = this.state.expandedCategory.replace(/\s+/g, '-').toUpperCase();
                const prev = $(`#items-for-${prevId}`);
                if (prev) { prev.style.maxHeight = '0'; prev.classList.remove('open'); }
            }
            this.state.expandedCategory = cat;
            div.classList.add('open');
            setTimeout(() => { div.style.maxHeight = div.scrollHeight + 'px'; }, 10);
        }
        ui.renderMenuPageContent();
    },

    addOrUpdateCart(id, change) {
        const item = this.state.allMenuItems.find(i => i.id === id);
        let cartItem = this.state.cart.find(i => i.id === id);
        if (!cartItem && change > 0) {
            this.state.cart.push({ ...item, quantity: 1 });
        } else if (cartItem) {
            cartItem.quantity += change;
            if (cartItem.quantity <= 0) this.state.cart = this.state.cart.filter(i => i.id !== id);
        }
        this.refreshPage();
    },

    refreshPage() {
        ui.renderPageContent(this.state.currentPage);
        ui.updateActiveNav(this.state.currentPage);
    },

    calculateTotals() {
        const subtotal = this.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
        const pts = this.state.customerProfile?.loyalty_points || 0;
        const maxRedeem = Math.min(Math.floor(pts * 0.8), Math.floor(subtotal));
        const discount = Math.min(this.state.pointsToRedeem, maxRedeem);
        const gst = (subtotal - discount) * 0.05;
        const total = (subtotal - discount) + gst;
        return { subtotal, discount, gst, total, maxRedeem };
    },

    async placeOrder(method, btn) {
        const { subtotal, discount, total } = this.calculateTotals();
        btn.disabled = true; btn.innerHTML = "Processing...";

        try {
            const { data: tableData } = await sb.from('tables').select('id').eq('table_number', this.state.tableNumber).single();
            const orderPayload = {
                customer_id: this.state.user.id,
                table_id: tableData.id,
                total_amount: total,
                discount_amount: discount,
                discount_points_redeemed: this.state.pointsToRedeem,
                payment_method: method,
                status: 'received'
            };

            const { data: order, error } = await sb.from('orders').insert(orderPayload).select().single();
            if (error) throw error;

            const items = this.state.cart.map(i => ({
                order_id: order.id,
                product_id: i.id,
                quantity: i.quantity,
                price_at_time_of_order: i.price
            }));
            await sb.from('order_items').insert(items);

            if (this.state.pointsToRedeem > 0) await sb.rpc('redeem_loyalty_points', { customer_id_input: this.state.user.id, points_to_redeem: discount });
            
            this.state.cart = [];
            this.state.pointsToRedeem = 0;
            this.state.activeOrder = order;
            this.listenToOrderUpdates(order.id);
            ui.closeModal('payment-modal');
            this.navigateTo('cart');
        } catch (e) {
            console.error(e);
            ui.showToast("Order Failed.");
            btn.disabled = false; btn.innerHTML = "Try Again";
        }
    },

    async fetchActiveOrder() {
        const { data } = await sb.from('orders').select('*, order_items(*, products(*))').eq('customer_id', this.state.user.id).in('status', ['received', 'preparing']).order('created_at', { ascending: false }).limit(1).maybeSingle();
        this.state.activeOrder = data;
        if (data) this.listenToOrderUpdates(data.id);
    },

    listenToOrderUpdates(id) {
        sb.channel(`order-${id}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${id}` }, p => {
            this.state.activeOrder = p.new;
            if (['delivered', 'cancelled'].includes(p.new.status)) {
                this.state.activeOrder = null;
            }
            this.refreshPage();
        }).subscribe();
    }
};

const ui = {
    renderHeader(page) {
        const header = $('#page-header');
        header.innerHTML = `
            <div><h1 class="text-2xl font-bold brand-text tracking-tighter uppercase">H<span class="classy-x">X</span>OUSE</h1></div>
            <div class="text-right">
                <p class="font-bold text-sm tracking-tighter">TABLE #${app.state.tableNumber || '?'}</p>
                <p class="text-[10px] uppercase opacity-40 font-black tracking-widest">${app.state.customerProfile?.name || 'Guest'}</p>
            </div>`;
    },

    renderPageContent(page) {
        const content = $('#page-content');
        if (page === 'home') this.renderHome(content);
        else if (page === 'order') this.renderMenu(content);
        else if (page === 'cart') this.renderCart(content);
        else if (page === 'social') this.renderSocial(content);
        else if (page === 'cowork') this.renderCowork(content);
        else if (page === 'more') this.renderMore(content);
    },

    renderHome(c) {
        c.innerHTML = `
            <div class="space-y-6 fade-in">
                <div class="relative h-60 overflow-hidden rounded-b-[2.5rem] shadow-2xl">
                    <video src="https://ttdnlatylcqrevzlyrru.supabase.co/storage/v1/object/public/assets/lv_0_20251012011509.mp4" autoplay loop muted playsinline class="absolute top-0 left-0 w-full h-full object-cover"></video>
                    <div class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white p-6">
                        <h1 class="text-4xl font-bold tracking-tighter uppercase leading-none text-center">Brewed for <br> the Hustle</h1>
                        <p class="text-[10px] font-bold tracking-[0.4em] mt-3 opacity-80 uppercase">HXOUSE COFFEE CO.</p>
                    </div>
                </div>
                <div class="p-6 space-y-6">
                    <div class="bg-yellow-100/80 border-2 border-yellow-200 p-8 rounded-[2.5rem] text-center shadow-sm">
                        <h2 class="font-black text-lg text-yellow-900 uppercase tracking-tighter">Loyalty Member</h2>
                        <p class="text-yellow-800 text-xs font-medium mt-1">Get 50 pts for every ‚Çπ500 spent.</p>
                        <div class="mt-4 brand-bg text-primary py-2 px-6 inline-block rounded-full font-black text-sm shadow-sm">${app.state.customerProfile?.loyalty_points || 0} POINTS</div>
                    </div>
                    <button onclick="app.navigateTo('order')" class="w-full brand-bg py-6 rounded-[2.5rem] font-black text-xl shadow-2xl active:scale-95 transition uppercase tracking-tighter">Explore Menu</button>
                </div>
            </div>`;
    },

    renderMenu(c) {
        c.innerHTML = `
            <div class="p-4 fade-in"><input type="text" id="menu-search" placeholder="Search beverages..." class="w-full p-5 bg-secondary border border-custom rounded-[1.5rem] font-bold shadow-inner" oninput="app.state.searchQuery = this.value; ui.renderMenuPageContent()"></div>
            <div id="menu-sections" class="p-4 space-y-4"></div>`;
        this.renderMenuPageContent();
    },

    renderMenuPageContent() {
        const target = $('#menu-sections');
        if (!target) return;
        const q = app.state.searchQuery.toLowerCase();
        
        target.innerHTML = app.state.menuData.map(group => {
            const filteredItems = group.items.filter(i => i.name.toLowerCase().includes(q));
            if (filteredItems.length === 0 && q.length > 0) return '';
            const isExp = app.state.expandedCategory === group.category || q.length > 0;
            const id = group.category.replace(/\s+/g, '-').toUpperCase();
            return `
                <div class="bg-secondary rounded-[1.5rem] border border-custom overflow-hidden shadow-sm">
                    <button onclick="app.toggleCategory('${group.category}')" class="w-full p-5 flex justify-between items-center font-black uppercase text-[10px] tracking-widest">
                        ${group.category} <span class="accordion-arrow transform transition-transform ${isExp ? 'rotate-90' : ''}">‚Üí</span>
                    </button>
                    <div id="items-for-${id}" class="accordion-content ${isExp ? 'open' : ''}" style="max-height: ${isExp ? '2000px' : '0'}">
                        <div class="accordion-item-list">
                            ${filteredItems.map(i => this.renderItemCard(i)).join('')}
                        </div>
                    </div>
                </div>`;
        }).join('');
    },

    renderItemCard(i) {
        const cartItem = app.state.cart.find(ci => ci.id === i.id);
        return `
            <div class="bg-primary p-5 rounded-2xl shadow-sm flex justify-between items-center border border-custom transform active:scale-95 transition">
                <div class="flex-grow pr-4">
                    <h4 class="font-black text-sm uppercase leading-tight mb-1">${i.name}</h4>
                    <p class="text-secondary font-black text-xs opacity-50 tracking-widest uppercase">‚Çπ${i.price}</p>
                </div>
                <div class="flex-shrink-0">
                    ${cartItem ? `
                        <div class="quantity-control bg-primary border-2 border-brand-primary text-brand-primary">
                            <button onclick="app.addOrUpdateCart(${i.id}, -1)" class="px-3 font-black">‚àí</button>
                            <span class="text-sm font-black">${cartItem.quantity}</span>
                            <button onclick="app.addOrUpdateCart(${i.id}, 1)" class="px-3 font-black">+</button>
                        </div>
                    ` : `
                        <button onclick="app.addOrUpdateCart(${i.id}, 1)" class="add-to-cart-btn brand-bg shadow-lg font-black text-2xl active:scale-90 transition">+</button>
                    `}
                </div>
            </div>`;
    },

    renderCart(c) {
        if (app.state.activeOrder) { this.renderTracking(c); return; }
        if (app.state.cart.length === 0) { c.innerHTML = `<div class="p-20 text-center opacity-30 fade-in h-full flex flex-col justify-center"><p class="text-7xl mb-8">‚òïÔ∏è</p><p class="font-black tracking-widest uppercase text-xs">Selection Empty</p></div>`; return; }

        const { subtotal, discount, gst, total, maxRedeem } = app.calculateTotals();
        c.innerHTML = `
            <div class="p-6 space-y-6 pb-32 fade-in">
                <h2 class="text-3xl font-black tracking-tighter uppercase">Cart</h2>
                <div class="space-y-3">
                    ${app.state.cart.map(i => `
                        <div class="flex justify-between items-center p-5 bg-secondary rounded-[1.5rem] border border-custom shadow-sm">
                            <div><p class="font-black text-sm uppercase">${i.name}</p><p class="text-[10px] opacity-40 font-black mt-1 tracking-widest">‚Çπ${i.price} x ${i.quantity}</p></div>
                            <div class="quantity-control shadow-sm"><button onclick="app.addOrUpdateCart(${i.id}, -1)" class="px-2">‚àí</button><span>${i.quantity}</span><button onclick="app.addOrUpdateCart(${i.id}, 1)" class="px-2">+</button></div>
                        </div>`).join('')}
                </div>
                ${maxRedeem > 0 ? `
                    <div class="p-8 bg-secondary rounded-[2rem] border border-custom shadow-inner">
                        <p class="text-[10px] font-black uppercase mb-5 opacity-40 tracking-widest text-center">Redeem Rewards</p>
                        <input type="range" id="loyalty-slider" min="0" max="${maxRedeem}" value="${app.state.pointsToRedeem}" oninput="app.state.pointsToRedeem = parseInt(this.value); ui.renderPageContent('cart')">
                        <div class="flex justify-between font-black text-[10px] mt-5 uppercase opacity-60"><span>Redeem ‚Çπ${app.state.pointsToRedeem}</span><span>Balance ${app.state.customerProfile.loyalty_points - app.state.pointsToRedeem} pts</span></div>
                    </div>` : ''}
                <div class="p-8 bg-secondary rounded-[2rem] space-y-3 border border-custom shadow-sm">
                    <div class="flex justify-between font-black text-[10px] opacity-40 uppercase tracking-widest"><span>Subtotal</span><span>‚Çπ${subtotal.toFixed(2)}</span></div>
                    ${discount > 0 ? `<div class="flex justify-between font-black text-[10px] text-green-600 uppercase tracking-widest"><span>Discount</span><span>-‚Çπ${discount.toFixed(2)}</span></div>` : ''}
                    <div class="flex justify-between font-black text-[10px] opacity-40 uppercase tracking-widest"><span>GST (5%)</span><span>‚Çπ${gst.toFixed(2)}</span></div>
                    <div class="flex justify-between font-black text-2xl pt-4 border-t border-custom tracking-tighter uppercase"><span>Total</span><span>‚Çπ${total.toFixed(2)}</span></div>
                </div>
                <button onclick="ui.showPaymentModal()" class="w-full brand-bg py-6 rounded-[2rem] font-black text-2xl shadow-2xl tracking-tighter uppercase active:scale-95 transition">Place Order</button>
            </div>`;
    },

    renderTracking(c) {
        const order = app.state.activeOrder;
        const steps = ['received', 'preparing', 'delivered'];
        const idx = steps.indexOf(order.status);
        const progress = ((idx + 1) / steps.length) * 100;
        
        c.innerHTML = `
            <div class="p-8 text-center space-y-12 fade-in">
                <h2 class="text-4xl font-black tracking-tighter uppercase">Tracking</h2>
                <div class="relative h-5 w-full bg-secondary rounded-full overflow-hidden border border-custom shadow-inner">
                    <div class="absolute h-full brand-bg transition-all duration-1000" style="width: ${progress}%"></div>
                </div>
                <div class="space-y-10 text-left px-4">
                    ${steps.map((s, i) => `
                        <div class="flex items-center space-x-8 ${i <= idx ? '' : 'opacity-10'}">
                            <div class="w-16 h-16 rounded-[1.5rem] border-2 border-custom flex items-center justify-center text-3xl shadow-sm bg-secondary">${i === 0 ? 'üìù' : i === 1 ? '‚òï' : 'üèÅ'}</div>
                            <div>
                                <p class="font-black text-sm uppercase tracking-widest leading-none mb-2">${s}</p>
                                <p class="text-[10px] font-bold text-secondary uppercase opacity-60 tracking-wider">${i <= idx ? 'Done' : 'Upcoming'}</p>
                            </div>
                        </div>`).join('')}
                </div>
            </div>`;
    },

    renderSocial(c) {
        c.innerHTML = `
            <div class="p-6 space-y-8 fade-in h-full flex flex-col justify-center text-center">
                <h2 class="text-3xl font-black uppercase tracking-tighter">Inner Circle</h2>
                <div class="bg-secondary p-10 rounded-[2.5rem] border border-custom shadow-xl">
                    <p class="instagram-card font-black text-2xl mb-8 tracking-tighter">@hxousecoffeeco</p>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=https://instagram.com/hxousecoffeeco" class="mx-auto rounded-[2rem] border-8 border-white p-2 shadow-inner">
                </div>
            </div>`;
    },

    renderCowork(c) {
        c.innerHTML = `
            <div class="p-8 text-center space-y-10 fade-in h-full flex flex-col justify-center">
                <span class="text-9xl mb-4 drop-shadow-2xl">üè¢</span>
                <h2 class="text-5xl font-black tracking-tighter uppercase leading-none">Studio</h2>
                <p class="text-secondary font-medium leading-relaxed px-10 text-sm">Fiber-optic Wi-Fi, premium brews, and a productive creative vibe. Ask staff for availability.</p>
                <button onclick="app.sendStaffCall('cowork')" class="brand-bg py-6 rounded-[2rem] font-black text-xl shadow-2xl w-full uppercase tracking-tighter active:scale-95 transition">Inquire Seat</button>
            </div>`;
    },

    renderMore(c) {
        c.innerHTML = `
            <div class="p-6 space-y-4 fade-in">
                <h2 class="text-3xl font-black uppercase tracking-tighter">Account</h2>
                <div class="bg-secondary p-10 rounded-[2rem] border border-custom shadow-sm mb-8">
                    <p class="text-[10px] font-black uppercase opacity-40 mb-2 tracking-[0.3em]">Verified Member</p>
                    <p class="font-black text-2xl tracking-tighter uppercase">${app.state.customerProfile?.name || 'Guest'}</p>
                    <p class="text-xs opacity-50 font-bold mt-2 tracking-widest">+91 ${app.state.customerProfile?.whatsapp_number || '----------'}</p>
                </div>
                <button onclick="ui.showGamesModal()" class="w-full p-6 bg-secondary rounded-2xl text-left font-black border border-custom flex justify-between shadow-sm active:bg-primary transition"><span>Mini Arcade</span><span>üéÆ</span></button>
                <button onclick="location.reload()" class="w-full p-6 bg-secondary rounded-2xl text-left font-black border border-custom flex justify-between shadow-sm active:bg-primary transition"><span>Refresh Engine</span><span>‚ü≥</span></button>
            </div>`;
    },

    showModal(id, content) {
        const m = document.createElement('div');
        m.id = id; m.className = "modal-overlay fixed inset-0 bg-black/95 z-[60] flex items-end p-4 backdrop-blur-md";
        m.innerHTML = `<div class="modal-content w-full bg-primary p-12 rounded-[3.5rem] shadow-2xl border border-custom">${content}</div>`;
        $('#modal-container').appendChild(m);
    },

    closeModal(id) { $(`#${id}`)?.remove(); },

    showToast(msg) {
        const t = $('#toast'); $('#toast-message').textContent = msg.toUpperCase();
        t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 2500);
    },

    showPaymentModal() {
        this.showModal('payment-modal', `
            <h2 class="text-3xl font-black mb-10 uppercase tracking-tighter">Select Pay</h2>
            <div class="space-y-4">
                <button onclick="app.placeOrder('Counter', this)" class="w-full p-6 bg-secondary rounded-2xl text-left font-black border border-custom flex justify-between items-center shadow-sm uppercase text-xs tracking-widest"><span>Counter Pay</span><span>üíµ</span></button>
                <button onclick="app.placeOrder('UPI', this)" class="w-full p-6 bg-secondary rounded-2xl text-left font-black border border-custom flex justify-between items-center shadow-sm uppercase text-xs tracking-widest"><span>UPI Digital</span><span>üì±</span></button>
            </div>
            <button onclick="ui.closeModal('payment-modal')" class="w-full mt-10 opacity-40 font-black uppercase text-[10px] tracking-widest">Cancel</button>
        `);
    },

    showGamesModal() {
        this.showModal('games-modal', `
            <h2 class="text-3xl font-black mb-8 uppercase tracking-tighter">Arcade</h2>
            <div class="space-y-4">
                <div class="bg-secondary p-8 rounded-[1.5rem] border border-custom shadow-sm flex justify-between items-center">
                    <p class="font-black uppercase text-xs tracking-widest">Tic-Tac-Toe</p>
                    <button onclick="GAMES.ttt.start()" class="brand-bg px-8 py-3 rounded-full font-black text-[10px] uppercase shadow-sm">Play</button>
                </div>
            </div>
            <button onclick="ui.closeModal('games-modal')" class="w-full mt-10 opacity-40 font-black uppercase text-[10px] tracking-widest">Return</button>
        `);
    },

    renderBottomNav() {
        const nav = $('#bottom-nav');
        const items = [
            { id: 'home', l: 'Home', i: 'üè†' },
            { id: 'order', l: 'Menu', i: '‚òï' },
            { id: 'cart', l: 'Track', i: 'üõí' },
            { id: 'more', l: 'User', i: '‚ò∞' }
        ];
        nav.innerHTML = items.map(item => `
            <button onclick="app.navigateTo('${item.id}')" class="nav-btn flex flex-col items-center flex-1 py-1 transition-all duration-300" id="nav-${item.id}">
                <div class="mb-1 text-lg">${item.i}</div>
                <span class="text-[8px] font-black uppercase tracking-[0.2em] opacity-40">${item.l}</span>
            </button>
        `).join('');
    },

    updateActiveNav(page) {
        $$('.nav-btn').forEach(btn => { 
            btn.classList.remove('brand-text', 'scale-110'); 
            btn.querySelector('span').classList.replace('opacity-100', 'opacity-40'); 
        });
        const active = $(`#nav-${page}`);
        if (active) { 
            active.classList.add('brand-text', 'scale-110'); 
            active.querySelector('span').classList.replace('opacity-40', 'opacity-100'); 
        }
    }
};

const GAMES = {
    ttt: {
        board: Array(9).fill(null), p: 'X', win: null,
        start() {
            this.board.fill(null); this.p = 'X'; this.win = null;
            ui.showModal('ttt-ui', `
                <h2 class="text-3xl font-black mb-8 text-center tracking-tighter uppercase">Tic-Tac-Toe</h2>
                <div class="grid grid-cols-3 gap-3 w-72 mx-auto mb-10">
                    ${this.board.map((_, i) => `<div onclick="GAMES.ttt.play(${i})" class="w-20 h-20 bg-secondary rounded-[1.5rem] flex items-center justify-center text-4xl font-black border border-custom shadow-sm transition active:scale-90" id="ttt-${i}"></div>`).join('')}
                </div>
                <p id="ttt-status" class="text-center font-black uppercase text-[10px] tracking-[0.5em] opacity-40 mb-10">Turn: ${this.p}</p>
                <button onclick="ui.closeModal('ttt-ui')" class="w-full opacity-30 font-black uppercase text-[8px] tracking-widest">Quit Game</button>
            `);
        },
        play(i) {
            if (this.board[i] || this.win) return;
            this.board[i] = this.p;
            $(`#ttt-${i}`).textContent = this.p;
            if (this.check()) {
                this.win = this.p;
                $('#ttt-status').textContent = `Winner: ${this.p}`;
            } else if (this.board.every(b => b)) {
                this.win = 'Draw';
                $('#ttt-status').textContent = `Draw Game`;
            } else {
                this.p = this.p === 'X' ? 'O' : 'X';
                $('#ttt-status').textContent = `Turn: ${this.p}`;
            }
        },
        check() {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            return wins.some(w => this.board[w[0]] && this.board[w[0]] === this.board[w[1]] && this.board[w[0]] === this.board[w[2]]);
        }
    }
};

window.addEventListener('load', () => app.init());
</script>
</body>
</html>
