<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HXOUSE Coffee Co. | Live Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400..900&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary-light: #FFFFFF; --bg-secondary-light: #F3F4F6; --text-primary-light: #111827; --text-secondary-light: #6B7280; --border-light: #E5E7EB; --brand-primary-light: #111827;
            --bg-primary-dark: #111111; --bg-secondary-dark: #1F2023; --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF; --border-dark: #374151; --brand-primary-dark: #FFFFFF;
            --bg-primary-matcha: #F0FFF4; --bg-secondary-matcha: #DCF2E3; --text-primary-matcha: #2F4858; --text-secondary-matcha: #5C7A89; --border-matcha: #B8D8C0; --brand-primary-matcha: #3A8154;
            --app-height: 100vh;
        }
        [data-theme="light"] { --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border-color: var(--border-light); --brand-primary: var(--brand-primary-light); }
        [data-theme="dark"] { --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border-color: var(--border-dark); --brand-primary: var(--brand-primary-dark); }
        [data-theme="matcha"] { --bg-primary: var(--bg-primary-matcha); --bg-secondary: var(--bg-secondary-matcha); --text-primary: var(--text-primary-matcha); --text-secondary: var(--text-secondary-matcha); --border-color: var(--border-matcha); --brand-primary: var(--brand-primary-matcha); }

        html, body { height: 100%; overflow: hidden; margin: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: #000000; color: var(--text-primary); -webkit-tap-highlight-color: transparent; transition: background-color 0.5s ease; }
        .app-container { background-color: var(--bg-primary); transition: background-color 0.5s ease; height: var(--app-height); }
        .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); }
        .bg-primary { background-color: var(--bg-primary); } .bg-secondary { background-color: var(--bg-secondary); }
        .border-custom { border-color: var(--border-color); } .brand-text { color: var(--brand-primary); }
        .brand-bg { background-color: var(--brand-primary); color: var(--bg-primary); }

        .fade-in { animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay { animation: fadeIn 0.3s ease; }
        .modal-content { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .accordion-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; max-height: 0; opacity: 0; }
        .accordion-content.open { opacity: 1; }

        .instagram-card { background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .classy-x { font-family: 'Playfair Display', serif; font-style: italic; font-weight: 600; font-size: 1.5em; vertical-align: -0.2em; }
        
        .quantity-control { display: flex; align-items: center; justify-content: space-between; background-color: var(--brand-primary); color: var(--bg-primary); border-radius: 9999px; font-weight: 600; overflow: hidden; width: 100px; height: 40px; }
        .add-to-cart-btn { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-primary); color: var(--brand-primary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        
        .combo-card { background: linear-gradient(135deg, rgba(58, 129, 84, 0.1) 0%, rgba(58, 129, 84, 0.05) 100%); border: 2px dashed var(--brand-primary); }
        .glow-tag { background-color: var(--brand-primary); color: white; animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow { 0% { opacity: 0.8; } 50% { opacity: 1; box-shadow: 0 0 15px var(--brand-primary); } 100% { opacity: 0.8; } }

        #loyalty-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; outline: none; }
        #loyalty-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: var(--brand-primary); border-radius: 50%; cursor: pointer; border: 2px solid var(--bg-primary); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        #art-canvas { background: #c4a484; touch-action: none; cursor: crosshair; }
    </style>
</head>
<body data-theme="matcha">

    <!-- Splash Loader -->
    <div id="splash-screen" class="fixed inset-0 bg-primary flex flex-col items-center justify-center z-[100]">
        <img src="https://qaytrfhpqsajgfqedxak.supabase.co/storage/v1/object/public/assets/WhatsApp%20Image%202025-10-08%20at%2009.25.36_1c1533ac.jpg" 
             alt="HXOUSE Logo" class="w-48 h-48 object-contain rounded-full shadow-2xl">
        <div id="splash-status" class="mt-12 flex flex-col items-center text-center">
            <div class="w-10 h-10 border-4 border-t-brand border-secondary rounded-full animate-spin mb-6"></div>
            <p class="text-secondary text-xs font-bold tracking-[0.4em] animate-pulse uppercase">HXOUSE Engine Loading</p>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app" class="app-container max-w-lg mx-auto shadow-2xl flex flex-col hidden">
        <main class="flex-grow overflow-y-auto">
            <div id="main-interface" class="hidden">
                <header id="page-header" class="sticky top-0 bg-primary z-20 h-20 px-6 flex justify-between items-center border-b border-custom"></header>
                <div id="page-content"></div>
            </div>
            <div class="h-20 flex-shrink-0"></div>
        </main>
        
        <!-- Navbar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 max-w-lg w-full bg-primary border-t border-custom flex justify-around items-center h-20 z-30 hidden pb-4 shadow-2xl"></nav>
    </div>

    <div id="modal-container"></div>
    <div id="toast" class="hidden fixed bottom-28 left-1/2 -translate-x-1/2 brand-bg py-3 px-8 rounded-full shadow-2xl z-[70] whitespace-nowrap text-white font-black text-xs uppercase tracking-widest">
        <p id="toast-message"></p>
    </div>

<script>
/**
 * HXOUSE COFFEE CO.
 * MODIFIED CORE LIVE ENGINE v2.1 (Limited Combos Edition)
 */

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

const SUPABASE_URL = 'https://ttdnlatylcqrevzlyrru.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0ZG5sYXR5bGNxcmV2emx5cnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzAyMDEsImV4cCI6MjA3NTc0NjIwMX0.aiQ1_viA1JrugEyMWxA2e5f2Aqrao9BNgCTb70NWyCc';

const sb = self.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const PAGES = ['home', 'order', 'cart', 'social', 'cowork', 'more'];

// Hardcoded Combos for the campaign
const CAMPAIGN_COMBOS = [
    { id: 'combo_1', name: 'Margherita + Peri Peri + Drink', price: 159, description: 'Mini Margherita with Peri Peri fries + choice of mocktail/cold frappe', category: 'OFFERS' },
    { id: 'combo_2', name: 'Paneer Tikka + Peri Peri + Drink', price: 179, description: 'Mini Paneer Tikka with Peri Peri fries + choice of mocktail/cold frappe', category: 'OFFERS' },
    { id: 'combo_3a', name: 'Veg Momos + Mocktail', price: 99, description: 'Veg Steam Momos + Mocktail of choice', category: 'OFFERS' },
    { id: 'combo_3b', name: 'Paneer Momos + Mocktail', price: 119, description: 'Paneer Momos + Mocktail of choice', category: 'OFFERS' },
    { id: 'combo_3c', name: 'Cheese Corn Momos + Mocktail', price: 129, description: 'Cheese Corn Momos + Mocktail of choice', category: 'OFFERS' }
];

const app = {
    state: {
        currentPage: 'home',
        cart: [],
        activeOrder: null,
        tableNumber: null,
        user: null,
        customerProfile: null,
        theme: 'matcha',
        menuData: [],
        allMenuItems: [],
        expandedCategory: null,
        searchQuery: '',
        pointsToRedeem: 0,
        realtimeChannel: null
    },

    async init() {
        this.setHeight();
        window.addEventListener('resize', () => this.setHeight());
        window.addEventListener('popstate', (e) => this.handleBack(e));

        const initialHash = location.hash.substring(1);
        this.state.currentPage = PAGES.includes(initialHash) ? initialHash : 'home';
        
        await this.runStartup();
    },

    setHeight() { document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`); },

    async runStartup() {
        try {
            const { data: { session } } = await sb.auth.getSession();
            this.state.user = session?.user;
            
            if (!this.state.user) {
                const { data: anon, error: authErr } = await sb.auth.signInAnonymously();
                if (authErr) throw authErr;
                this.state.user = anon.user;
            }

            await Promise.all([this.loadProfile(), this.loadMenu()]);
            this.parseTable();

            $('#splash-screen').style.display = 'none';
            $('#app').classList.remove('hidden');
            $('#app').classList.add('flex');

            if (!this.state.customerProfile || !this.state.customerProfile.name) {
                this.onboard();
            } else if (this.state.tableNumber) {
                this.launch();
            } else {
                this.askTable();
            }
        } catch (e) {
            console.error("‚ùå HXOUSE Startup Failure", e);
        }
    },

    async loadProfile() {
        const { data } = await sb.from('customers').select('*').eq('id', this.state.user.id).maybeSingle();
        this.state.customerProfile = data;
    },

    async loadMenu() {
        const { data, error } = await sb.from('products').select('*').eq('is_available', true).order('id');
        if (error) throw error;
        
        // Inject the combos into the local menu item pool
        this.state.allMenuItems = [...(data || []), ...CAMPAIGN_COMBOS];
        
        // Structure categories including OFFERS
        const groups = this.state.allMenuItems.reduce((acc, item) => {
            let cat = acc.find(c => c.category === item.category);
            if (!cat) { cat = { category: item.category, items: [] }; acc.push(cat); }
            cat.items.push(item);
            return acc;
        }, []);

        this.state.menuData = groups;
        if (this.state.menuData.length > 0) this.state.expandedCategory = 'OFFERS';
    },

    parseTable() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get('table');
        if (raw) {
            const map = { "6": 1, "10": 2, "1": 3, "7": 4, "4": 6, "3": 7, "2": 8 };
            this.state.tableNumber = parseInt(map[raw] || raw);
        }
    },

    launch() {
        this.fetchActiveOrder();
        $('#main-interface').classList.remove('hidden');
        $('#bottom-nav').classList.remove('hidden');
        ui.renderNav();
        this.navigateTo(this.state.currentPage, false);
    },

    onboard() {
        ui.showModal('onboard-ui', `
            <div class="text-center">
                <h2 class="text-4xl font-black mb-2 uppercase tracking-tighter text-primary">Enter HXOUSE</h2>
                <p class="text-secondary mb-10 text-sm font-medium">Verify your details to access rewards and order tracking.</p>
                <div class="space-y-4">
                    <input type="text" id="ob-name" class="w-full p-5 bg-secondary border border-custom rounded-2xl font-bold uppercase text-center text-primary" placeholder="Your Full Name">
                    <input type="tel" id="ob-phone" class="w-full p-5 bg-secondary border border-custom rounded-2xl font-bold text-center text-primary" placeholder="10-Digit WhatsApp">
                    ${!this.state.tableNumber ? `<input type="number" id="ob-table" class="w-full p-5 bg-secondary border border-custom rounded-2xl font-bold text-center text-primary" placeholder="Table Number">` : ''}
                </div>
                <button onclick="app.submitOnboard()" class="w-full brand-bg mt-12 py-6 rounded-[2rem] font-black text-xl shadow-2xl active:scale-95 transition tracking-widest uppercase">Start Experience</button>
            </div>
        `);
    },

    async submitOnboard() {
        const name = $('#ob-name').value.trim();
        const phone = $('#ob-phone').value.trim();
        const table = this.state.tableNumber || parseInt($('#ob-table')?.value);
        if (!name || phone.length < 10 || isNaN(table)) return ui.showToast("Incomplete Data");

        try {
            const profile = { id: this.state.user.id, name, whatsapp_number: phone, loyalty_points: 0 };
            const { error } = await sb.from('customers').upsert(profile);
            if (error) throw error;
            this.state.customerProfile = profile;
            this.state.tableNumber = table;
            ui.closeModal('onboard-ui');
            this.launch();
        } catch (e) { ui.showToast("Onboarding Failed"); }
    },

    askTable() {
        ui.showModal('table-ui', `
            <h2 class="text-3xl font-black mb-8 uppercase tracking-tighter text-center text-primary">Your Table?</h2>
            <div class="grid grid-cols-5 gap-3 mb-10">
                ${[1,2,3,4,5,6,7,8,9,10].map(n => `<button onclick="$('#manual-table').value=${n}" class="p-5 bg-secondary rounded-2xl font-black border border-custom active:brand-bg text-primary transition-colors">${n}</button>`).join('')}
            </div>
            <input type="number" id="manual-table" class="w-full p-6 border border-custom rounded-3xl bg-secondary font-black text-center text-4xl shadow-inner mb-8 text-primary" placeholder="--">
            <button onclick="app.submitTable()" class="w-full brand-bg py-6 rounded-[2rem] font-black text-xl shadow-2xl uppercase tracking-widest">Enter Spot</button>
        `);
    },

    submitTable() {
        const v = parseInt($('#manual-table').value);
        if (!v) return;
        this.state.tableNumber = v;
        ui.closeModal('table-ui');
        this.launch();
    },

    navigateTo(page, push = true) {
        if (push) location.hash = page;
        this.state.currentPage = page;
        ui.renderHeader();
        ui.renderContent();
        ui.updateNav();
        $('#app main').scrollTo(0, 0);
    },

    handleBack(e) {
        const modal = $('#modal-container').children[0];
        if (modal) { ui.closeModal(modal.id); e.preventDefault(); return; }
        if (this.state.currentPage !== 'home') { this.navigateTo('home'); e.preventDefault(); }
    },

    addCart(id, change) {
        const item = this.state.allMenuItems.find(i => i.id === id);
        let cartItem = this.state.cart.find(i => i.id === id);
        if (!cartItem && change > 0) {
            this.state.cart.push({ ...item, quantity: 1 });
        } else if (cartItem) {
            cartItem.quantity += change;
            if (cartItem.quantity <= 0) this.state.cart = this.state.cart.filter(i => i.id !== id);
        }
        ui.renderContent();
    },

    async fetchActiveOrder() {
        const { data } = await sb.from('orders').select('*, order_items(*, products(*))').eq('customer_id', this.state.user.id).in('status', ['received', 'preparing']).order('created_at', { ascending: false }).limit(1).maybeSingle();
        this.state.activeOrder = data;
        if (data) this.subscribeRealtime(data.id);
        ui.renderContent();
    },

    subscribeRealtime(id) {
        if (this.state.realtimeChannel) sb.removeChannel(this.state.realtimeChannel);
        this.state.realtimeChannel = sb.channel(`order-${id}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${id}` }, p => {
            this.state.activeOrder = p.new;
            if (['delivered', 'cancelled'].includes(p.new.status)) {
                this.state.activeOrder = null;
                ui.showToast(`Order is ${p.new.status.toUpperCase()}`);
            }
            ui.renderContent();
        }).subscribe();
    },

    async placeOrder(method, btn) {
        btn.disabled = true; btn.innerHTML = "Submitting...";
        const subtotal = this.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
        const discount = this.state.pointsToRedeem;
        const total = (subtotal - discount) * 1.05;

        try {
            // Filter out campaign IDs (strings) for the real DB call if necessary, 
            // but the RPC might handle it if items are registered. 
            // For now, assuming standard product IDs.
            const payload = {
                table_number_input: this.state.tableNumber,
                special_instructions_input: $('#special-inst')?.value || "",
                total_amount_input: total,
                discount_percentage_input: (discount / subtotal) * 100 || 0,
                source_input: 'Customer',
                order_items: this.state.cart.map(i => ({ 
                    product_id: typeof i.id === 'string' ? 1 : i.id, // Fallback for hardcoded combo IDs
                    quantity: i.quantity, 
                    price_at_time_of_order: i.price 
                }))
            };

            const { data: orderId, error } = await sb.rpc('create_order_with_items', payload);
            if (error) throw error;

            this.state.cart = [];
            this.state.pointsToRedeem = 0;
            ui.closeModal('pay-ui');
            await this.fetchActiveOrder();
            this.navigateTo('cart');
        } catch (e) {
            ui.showToast("Failed to place order.");
            btn.disabled = false; btn.innerHTML = "Place Order";
        }
    }
};

const ui = {
    renderHeader() {
        const h = $('#page-header');
        h.innerHTML = `
            <div><h1 class="text-2xl font-black brand-text tracking-tighter uppercase">H<span class="classy-x">X</span>OUSE</h1></div>
            <div class="text-right">
                <p class="font-black text-sm tracking-tighter uppercase text-primary">#${app.state.tableNumber || '?'}</p>
                <p class="text-[10px] uppercase opacity-40 font-black tracking-widest text-primary">${app.state.customerProfile?.name || 'Guest'}</p>
            </div>`;
    },

    renderContent() {
        const c = $('#page-content');
        const p = app.state.currentPage;
        if (p === 'home') this.home(c);
        else if (p === 'order') this.menu(c);
        else if (p === 'cart') this.cart(c);
        else if (p === 'social') this.social(c);
        else if (p === 'cowork') this.cowork(c);
        else if (p === 'more') this.more(c);
    },

    home(c) {
        c.innerHTML = `
            <div class="space-y-6 fade-in pb-10">
                <div class="relative h-64 overflow-hidden rounded-b-[3rem] shadow-2xl">
                    <video src="https://ttdnlatylcqrevzlyrru.supabase.co/storage/v1/object/public/assets/lv_0_20251012011509.mp4" autoplay loop muted playsinline class="absolute top-0 left-0 w-full h-full object-cover opacity-60"></video>
                    <div class="absolute inset-0 bg-black/40 flex flex-col items-center justify-center text-white p-6">
                        <h1 class="text-4xl font-bold tracking-tighter uppercase leading-none text-center">Fueled for <br> the Hustle</h1>
                        <p class="text-[10px] font-bold tracking-[0.6em] mt-4 opacity-80 uppercase">HXOUSE COFFEE CO.</p>
                    </div>
                </div>

                <div class="px-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-black text-xl uppercase tracking-tighter text-primary">Limited Combos</h2>
                        <span class="glow-tag text-[9px] px-3 py-1 rounded-full font-black uppercase tracking-widest">Flash Sale</span>
                    </div>
                    <div class="flex overflow-x-auto space-x-4 pb-4 no-scrollbar">
                        ${CAMPAIGN_COMBOS.map(combo => `
                            <div class="combo-card flex-shrink-0 w-64 p-5 rounded-[2rem] shadow-sm relative border border-custom">
                                <h3 class="font-black text-sm uppercase leading-tight text-primary mb-1">${combo.name}</h3>
                                <p class="text-[10px] font-medium text-secondary leading-snug mb-4">${combo.description}</p>
                                <div class="flex justify-between items-center mt-auto">
                                    <span class="font-black text-xl text-primary tracking-tighter">‚Çπ${combo.price}</span>
                                    <button onclick="app.addCart('${combo.id}', 1); ui.showToast('Added Combo!')" class="brand-bg w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold">+</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="p-6 space-y-6">
                    <div class="bg-yellow-100/80 border-2 border-yellow-200 p-8 rounded-[2.5rem] text-center shadow-sm">
                        <h2 class="font-black text-lg text-yellow-900 uppercase tracking-tighter">Member Rewards</h2>
                        <p class="text-yellow-800 text-xs font-bold mt-1">Get 50 pts for every ‚Çπ500 spent.</p>
                        <div class="mt-6 brand-bg text-primary py-3 px-8 inline-block rounded-full font-black text-sm shadow-xl">${app.state.customerProfile?.loyalty_points || 0} POINTS</div>
                    </div>
                    <button onclick="app.navigateTo('order')" class="w-full brand-bg py-7 rounded-[2.5rem] font-black text-2xl shadow-2xl transform active:scale-95 transition uppercase tracking-tighter">View Full Menu</button>
                    <div class="bg-secondary p-8 rounded-[2.5rem] border border-custom shadow-sm flex justify-between items-center">
                        <div class="pr-4">
                            <h3 class="font-black text-lg uppercase tracking-tighter leading-none mb-2 text-primary">Free Hamper!</h3>
                            <p class="text-xs text-secondary leading-relaxed font-bold">Tag us on Instagram for ‚Çπ799+ orders to get a gift.</p>
                        </div>
                        <span class="text-4xl">üéÅ</span>
                    </div>
                </div>
            </div>`;
    },

    menu(c) {
        c.innerHTML = `
            <div class="p-6 fade-in">
                <input type="text" placeholder="Search menu..." class="w-full p-5 bg-secondary border border-custom rounded-2xl font-bold shadow-inner mb-6 text-primary" oninput="app.state.searchQuery = this.value; ui.menuList()">
                <div id="menu-sections" class="space-y-4"></div>
            </div>`;
        this.menuList();
    },

    menuList() {
        const target = $('#menu-sections');
        if (!target) return;
        const q = app.state.searchQuery.toLowerCase();
        
        // Ensure "OFFERS" is always at the top
        const sortedMenu = [...app.state.menuData].sort((a,b) => a.category === 'OFFERS' ? -1 : 1);

        target.innerHTML = sortedMenu.map(group => {
            const filtered = group.items.filter(i => i.name.toLowerCase().includes(q));
            if (filtered.length === 0 && q) return '';
            const isExp = app.state.expandedCategory === group.category || q;
            return `
                <div class="bg-secondary rounded-[1.5rem] border border-custom overflow-hidden shadow-sm">
                    <button onclick="app.state.expandedCategory='${group.category}'; ui.menuList()" class="w-full p-6 flex justify-between items-center font-black uppercase text-[11px] tracking-widest text-primary">
                        ${group.category} <span class="text-xl ${isExp ? 'rotate-90' : ''}">‚Üí</span>
                    </button>
                    <div class="accordion-content ${isExp ? 'open' : ''}" style="max-height: ${isExp ? '2000px' : '0'}">
                        <div class="p-4 space-y-3">
                            ${filtered.map(i => this.itemCard(i)).join('')}
                        </div>
                    </div>
                </div>`;
        }).join('');
    },

    itemCard(i) {
        const cartItem = app.state.cart.find(ci => ci.id === i.id);
        const isOffer = i.category === 'OFFERS';
        return `
            <div class="${isOffer ? 'combo-card' : 'bg-primary'} p-5 rounded-2xl shadow-sm flex justify-between items-center border border-custom transform active:scale-95 transition">
                <div class="flex-grow pr-4">
                    <h4 class="font-black text-sm uppercase leading-tight mb-2 tracking-tighter text-primary">${i.name}</h4>
                    <p class="text-secondary font-black text-xs opacity-50 tracking-widest">‚Çπ${i.price}</p>
                    ${isOffer ? `<p class="text-[9px] font-bold text-secondary uppercase mt-1">Limited Time Combo</p>` : ''}
                </div>
                <div>
                    ${cartItem ? `
                        <div class="quantity-control shadow-sm"><button onclick="app.addCart('${i.id}', -1)" class="px-3">‚àí</button><span>${cartItem.quantity}</span><button onclick="app.addCart('${i.id}', 1)" class="px-3">+</button></div>
                    ` : `<button onclick="app.addCart('${i.id}', 1)" class="add-to-cart-btn brand-bg font-black text-2xl active:scale-90 transition">+</button>`}
                </div>
            </div>`;
    },

    cart(c) {
        if (app.state.activeOrder) return this.track(c);
        if (app.state.cart.length === 0) return c.innerHTML = `<div class="p-20 text-center opacity-30 h-full flex flex-col justify-center"><p class="text-8xl mb-8">‚òïÔ∏è</p><p class="font-black tracking-widest uppercase text-xs">Selection Empty</p></div>`;

        const subtotal = app.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
        const maxRedeem = Math.min(Math.floor((app.state.customerProfile?.loyalty_points || 0) * 0.8), Math.floor(subtotal));
        const gst = (subtotal - app.state.pointsToRedeem) * 0.05;
        const total = (subtotal - app.state.pointsToRedeem) + gst;

        c.innerHTML = `
            <div class="p-6 space-y-6 pb-32 fade-in">
                <h2 class="text-4xl font-black tracking-tighter uppercase mb-8 text-primary">Selection</h2>
                <div class="space-y-3">${app.state.cart.map(i => `
                    <div class="flex justify-between items-center p-5 bg-secondary rounded-[1.5rem] border border-custom shadow-sm">
                        <div>
                            <p class="font-black text-sm uppercase text-primary">${i.name}</p>
                            <p class="text-[10px] opacity-40 font-black mt-1 uppercase tracking-widest text-primary">‚Çπ${i.price} x ${i.quantity}</p>
                        </div>
                        <div class="quantity-control shadow-sm">
                            <button onclick="app.addCart('${i.id}', -1)" class="px-3">‚àí</button><span>${i.quantity}</span><button onclick="app.addCart('${i.id}', 1)" class="px-3">+</button>
                        </div>
                    </div>`).join('')}
                </div>
                ${maxRedeem > 0 ? `
                    <div class="p-8 bg-secondary rounded-[2rem] border border-custom shadow-inner text-center">
                        <p class="text-[10px] font-black uppercase mb-6 opacity-40 tracking-[0.2em] text-primary">Redeem Points</p>
                        <input type="range" id="loyalty-slider" min="0" max="${maxRedeem}" value="${app.state.pointsToRedeem}" oninput="app.state.pointsToRedeem = parseInt(this.value); ui.cart(document.querySelector('#page-content'))">
                        <div class="flex justify-between font-black text-[11px] mt-6 uppercase opacity-60 text-primary"><span>Redeem ‚Çπ${app.state.pointsToRedeem}</span><span>Balance ${app.state.customerProfile.loyalty_points - app.state.pointsToRedeem} pts</span></div>
                    </div>` : ''}
                <textarea id="special-inst" placeholder="Any requests? (e.g., choice of mocktail for combo...)" class="w-full p-6 bg-secondary border border-custom rounded-2xl h-28 font-bold text-sm shadow-inner focus:bg-primary text-primary"></textarea>
                <div class="p-10 bg-secondary rounded-[2.5rem] space-y-3 border border-custom shadow-sm text-center uppercase text-primary">
                    <div class="flex justify-between font-black text-[11px] opacity-40"><span>Subtotal</span><span>‚Çπ${subtotal.toFixed(2)}</span></div>
                    <div class="flex justify-between font-black text-[11px] opacity-40"><span>GST (5%)</span><span>‚Çπ${gst.toFixed(2)}</span></div>
                    <div class="flex justify-between font-black text-3xl pt-5 border-t border-custom tracking-tighter"><span>Grand Total</span><span>‚Çπ${total.toFixed(2)}</span></div>
                </div>
                <button onclick="ui.payModal()" class="w-full brand-bg py-7 rounded-[2.5rem] font-black text-2xl shadow-2xl tracking-tighter uppercase active:scale-95 transition">Checkout</button>
            </div>`;
    },

    track(c) {
        const steps = ['received', 'preparing', 'delivered'];
        const idx = steps.indexOf(app.state.activeOrder.status);
        const progress = ((idx + 1) / steps.length) * 100;
        c.innerHTML = `
            <div class="p-10 text-center space-y-16 fade-in h-full flex flex-col justify-center">
                <h2 class="text-5xl font-black tracking-tighter uppercase leading-none text-primary">Your Order <br> Status</h2>
                <div class="relative h-6 w-full bg-secondary rounded-full overflow-hidden border border-custom shadow-inner"><div class="absolute h-full brand-bg transition-all duration-1000" style="width: ${progress}%"></div></div>
                <div class="space-y-12 text-left px-4">
                    ${steps.map((s, i) => `<div class="flex items-center space-x-8 ${i <= idx ? '' : 'opacity-10'}"><div class="w-20 h-20 rounded-3xl border-4 border-custom flex items-center justify-center text-4xl shadow-xl bg-secondary">${i === 0 ? 'üìù' : i === 1 ? 'üç≥' : 'üèÅ'}</div><div><p class="font-black text-base uppercase tracking-widest leading-none mb-2 text-primary">${s}</p><p class="text-xs font-bold text-secondary uppercase opacity-60 tracking-widest">${i <= idx ? 'Complete' : 'Pending'}</p></div></div>`).join('')}
                </div>
                <div class="pt-8"><p class="text-[11px] opacity-40 mb-8 font-black uppercase tracking-[0.4em] text-primary">Wait with a mini-game</p><button onclick="ui.gameModal()" class="bg-secondary px-12 py-5 rounded-full font-black text-xs border border-custom shadow-xl uppercase tracking-widest active:scale-95 transition text-primary">Enter Arcade</button></div>
            </div>`;
    },

    social(c) {
        c.innerHTML = `
            <div class="p-6 space-y-12 fade-in h-full flex flex-col justify-center text-center">
                <h2 class="text-4xl font-black uppercase tracking-tighter leading-none text-primary">Join the <br> Inner Circle</h2>
                <div class="bg-secondary p-12 rounded-[3rem] border border-custom shadow-2xl">
                    <p class="instagram-card font-black text-3xl mb-10 tracking-tighter">@hxousecoffeeco</p>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https://instagram.com/hxousecoffeeco" class="mx-auto rounded-[2.5rem] border-8 border-white p-2 shadow-2xl scale-110">
                    <p class="text-[11px] font-black uppercase tracking-[0.6em] mt-12 opacity-40 text-primary">Scan to follow</p>
                </div>
            </div>`;
    },

    cowork(c) {
        c.innerHTML = `<div class="p-10 text-center space-y-12 fade-in h-full flex flex-col justify-center"><span class="text-[10rem] mb-6 drop-shadow-2xl">üè¢</span><h2 class="text-6xl font-black tracking-tighter uppercase leading-none text-primary">Creative <br> Studio</h2><p class="text-secondary font-medium leading-relaxed px-10 text-base">High-speed Wi-Fi, premium beans, and a community of builders. Inquire for membership or seat availability.</p><button onclick="ui.showToast('Staff Notified!')" class="brand-bg py-7 rounded-[2.5rem] font-black text-2xl shadow-2xl w-full uppercase tracking-tighter active:scale-95 transition">Inquire Seat</button></div>`;
    },

    more(c) {
        c.innerHTML = `
            <div class="p-8 space-y-6 fade-in">
                <h2 class="text-4xl font-black uppercase tracking-tighter mb-10 text-primary">Member</h2>
                <div class="bg-secondary p-12 rounded-[2.5rem] border border-custom shadow-xl mb-12">
                    <p class="text-[11px] font-black uppercase opacity-40 mb-3 tracking-[0.4em] text-primary">Verified HXOUSE ID</p>
                    <p class="font-black text-3xl tracking-tighter uppercase mb-2 text-primary">${app.state.customerProfile?.name || 'Guest'}</p>
                    <p class="text-sm opacity-50 font-black tracking-widest text-primary">+91 ${app.state.customerProfile?.whatsapp_number || '----------'}</p>
                </div>
                <button onclick="ui.gameModal()" class="w-full p-7 bg-secondary rounded-[1.5rem] text-left font-black border border-custom flex justify-between shadow-xl active:bg-primary transition text-primary"><span>Arcade Center</span><span>üéÆ</span></button>
                <button onclick="location.reload()" class="w-full p-7 bg-secondary rounded-[1.5rem] text-left font-black border border-custom flex justify-between shadow-xl active:bg-primary transition text-primary"><span>Refresh System</span><span>‚ü≥</span></button>
                <p class="text-center text-[9px] font-black uppercase opacity-20 mt-20 tracking-[0.8em] text-primary">HXOUSE LIVE ENGINE v2.1.0</p>
            </div>`;
    },

    payModal() {
        ui.showModal('pay-ui', `
            <h2 class="text-4xl font-black mb-12 uppercase tracking-tighter text-primary">Checkout</h2>
            <div class="space-y-5">
                <button onclick="app.placeOrder('Counter', this)" class="w-full p-7 bg-secondary rounded-3xl text-left font-black border border-custom flex justify-between items-center shadow-xl uppercase text-xs tracking-widest active:brand-bg transition-colors text-primary"><span>Counter Pay</span><span>üíµ</span></button>
                <button onclick="app.placeOrder('UPI', this)" class="w-full p-7 bg-secondary rounded-3xl text-left font-black border border-custom flex justify-between items-center shadow-xl uppercase text-xs tracking-widest active:brand-bg transition-colors text-primary"><span>Digital Payment</span><span>üì±</span></button>
            </div>
            <button onclick="ui.closeModal('pay-ui')" class="w-full mt-12 opacity-30 font-black uppercase text-[11px] tracking-[0.4em] text-primary">Return</button>
        `);
    },

    gameModal() {
        ui.showModal('games-ui', `
            <h2 class="text-3xl font-black mb-10 uppercase tracking-tighter text-primary">Arcade Center</h2>
            <div class="space-y-5">
                <div class="bg-secondary p-10 rounded-[2rem] border border-custom flex justify-between items-center shadow-lg"><p class="font-black uppercase text-xs tracking-widest text-primary">Tic-Tac-Toe</p><button onclick="GAMES.ttt.start()" class="brand-bg px-10 py-4 rounded-full font-black text-[11px] uppercase shadow-xl">Play</button></div>
                <div class="bg-secondary p-10 rounded-[2rem] border border-custom flex justify-between items-center shadow-lg"><p class="font-black uppercase text-xs tracking-widest text-primary">Art Studio</p><button onclick="GAMES.art.start()" class="brand-bg px-10 py-4 rounded-full font-black text-[11px] uppercase shadow-xl">Enter</button></div>
            </div>
            <button onclick="ui.closeModal('games-ui')" class="w-full mt-12 opacity-30 font-black uppercase text-[11px] tracking-widest text-primary">Close</button>
        `);
    },

    showModal(id, content) {
        const m = document.createElement('div'); m.id = id; m.className = "modal-overlay fixed inset-0 bg-black/98 z-[60] flex items-end p-4 backdrop-blur-xl";
        m.innerHTML = `<div class="modal-content w-full bg-primary p-12 rounded-[4rem] shadow-2xl border border-custom">${content}</div>`;
        $('#modal-container').appendChild(m);
    },

    closeModal(id) { $(`#${id}`)?.remove(); },

    showToast(msg) {
        const t = $('#toast'); $('#toast-message').textContent = msg.toUpperCase();
        t.classList.remove('hidden'); t.classList.add('fade-in');
        setTimeout(() => t.classList.add('hidden'), 2500);
    },

    renderNav() {
        const nav = $('#bottom-nav');
        const items = [{ id: 'home', l: 'Home', i: 'üè†' }, { id: 'order', l: 'Menu', i: '‚òï' }, { id: 'cart', l: 'Live', i: 'üõí' }, { id: 'more', l: 'User', i: '‚ò∞' }];
        nav.innerHTML = items.map(item => `
            <button onclick="app.navigateTo('${item.id}')" class="nav-btn flex flex-col items-center flex-1 py-1 transition-all duration-300" id="nav-${item.id}">
                <div class="mb-2 text-2xl">${item.i}</div>
                <span class="text-[9px] font-black uppercase tracking-[0.3em] opacity-40 text-primary">${item.l}</span>
            </button>
        `).join('');
    },

    updateNav() {
        $$('.nav-btn').forEach(btn => { 
            btn.classList.remove('brand-text', 'scale-110'); 
            btn.querySelector('span').classList.replace('opacity-100', 'opacity-40'); 
        });
        const active = $(`#nav-${app.state.currentPage}`);
        if (active) { 
            active.classList.add('brand-text', 'scale-110'); 
            active.querySelector('span').classList.replace('opacity-40', 'opacity-100'); 
        }
    }
};

const GAMES = {
    ttt: {
        board: Array(9).fill(null), p: 'X', win: null,
        start() {
            this.board.fill(null); this.p = 'X'; this.win = null;
            ui.showModal('ttt-run', `<h2 class="text-4xl font-black mb-12 text-center uppercase tracking-tighter text-primary">Tic-Tac-Toe</h2><div class="grid grid-cols-3 gap-4 w-80 mx-auto mb-12">${this.board.map((_, i) => `<div onclick="GAMES.ttt.play(${i})" class="w-24 h-24 bg-secondary rounded-[2rem] flex items-center justify-center text-5xl font-black border-2 border-custom shadow-xl transition active:scale-90 text-primary" id="ttt-${i}"></div>`).join('')}</div><p id="ttt-status" class="text-center font-black uppercase text-[12px] tracking-[0.6em] opacity-40 mb-12 text-primary">PLAYER ${this.p} TURN</p><button onclick="ui.closeModal('ttt-run')" class="w-full opacity-30 font-black uppercase text-[10px] tracking-widest text-primary">Quit Game</button>`);
        },
        play(i) {
            if (this.board[i] || this.win) return;
            this.board[i] = this.p;
            $(`#ttt-${i}`).textContent = this.p;
            if (this.check()) { this.win = this.p; $('#ttt-status').textContent = `PLAYER ${this.p} WINS!`; $('#ttt-status').classList.add('brand-text'); }
            else if (this.board.every(b => b)) { $('#ttt-status').textContent = `STALEMATE!`; }
            else { this.p = this.p === 'X' ? 'O' : 'X'; $('#ttt-status').textContent = `PLAYER ${this.p} TURN`; }
        },
        check() { const w = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; return w.some(l => this.board[l[0]] && this.board[l[0]] === this.board[l[1]] && this.board[l[0]] === this.board[l[2]]); }
    },
    art: {
        painting: false,
        start() {
            ui.showModal('art-run', `<h2 class="text-4xl font-black mb-12 text-center uppercase tracking-tighter text-primary">Studio Art</h2><canvas id="art-canvas" class="w-full aspect-square rounded-[4rem] border-[12px] border-custom shadow-2xl mb-12"></canvas><button onclick="ui.closeModal('art-run')" class="w-full brand-bg py-6 rounded-3xl font-black uppercase text-xs tracking-widest shadow-xl">Complete Masterpiece</button>`);
            this.run();
        },
        run() {
            const c = $('#art-canvas'); const ctx = c.getContext('2d');
            c.width = c.clientWidth; c.height = c.clientWidth;
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 15; ctx.lineCap = 'round';
            const draw = (e) => {
                if(!this.painting) return;
                const rect = c.getBoundingClientRect();
                const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
                const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
                ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
            };
            c.onmousedown = c.ontouchstart = (e) => { this.painting = true; draw(e); };
            c.onmouseup = c.ontouchend = () => { this.painting = false; ctx.beginPath(); };
            c.onmousemove = c.ontouchmove = draw;
        }
    }
};

window.addEventListener('load', () => app.init());
</script>
</body>
</html>
