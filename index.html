<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Welcome to HXOUSE Coffee Co.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* --- "Espresso & Cream" Theme --- */
        :root {
            --bg-primary-light: #FFFFFF; --bg-secondary-light: #F3F4F6; --text-primary-light: #111827; --text-secondary-light: #6B7280; --border-light: #E5E7EB; --brand-primary-light: #111827;
            --bg-primary-dark: #111111; --bg-secondary-dark: #1F2023; --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF; --border-dark: #374151; --brand-primary-dark: #FFFFFF;
            --bg-primary-sunset: #1E1E2E; --bg-secondary-sunset: #2D2D44; --text-primary-sunset: #F6F6F6; --text-secondary-sunset: #A8A8C3; --border-sunset: #4A4A6A; --brand-primary-sunset: #FFA756;
            
            --bg-primary-matcha: #FFFDF9; 
            --bg-secondary-matcha: #F5F3EF; 
            --text-primary-matcha: #2D231E; 
            --text-secondary-matcha: #796A61; 
            --border-matcha: #EAE5E0; 
            --brand-primary-matcha: #D95F2B; 

            --app-height: 100vh;
        }
        [data-theme="light"] { --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border-color: var(--border-light); --brand-primary: var(--brand-primary-light); }
        [data-theme="dark"] { --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border-color: var(--border-dark); --brand-primary: var(--brand-primary-dark); }
        [data-theme="sunset"] { --bg-primary: var(--bg-primary-sunset); --bg-secondary: var(--bg-secondary-sunset); --text-primary: var(--text-primary-sunset); --text-secondary: var(--text-secondary-sunset); --border-color: var(--border-sunset); --brand-primary: var(--brand-primary-sunset); }
        [data-theme="matcha"] { --bg-primary: var(--bg-primary-matcha); --bg-secondary: var(--bg-secondary-matcha); --text-primary: var(--text-primary-matcha); --text-secondary: var(--text-secondary-matcha); --border-color: var(--border-matcha); --brand-primary: var(--brand-primary-matcha); }
        
        html, body { height: 100%; overflow: hidden; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000000; 
            color: var(--text-primary); 
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.5s ease; 
        }
        .app-container { 
            background-color: var(--bg-primary); 
            transition: background-color 0.5s ease; 
            height: var(--app-height); 
        }
        
        /* Utility Classes */
        .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); }
        .bg-primary { background-color: var(--bg-primary); } .bg-secondary { background-color: var(--bg-secondary); }
        .border-custom { border-color: var(--border-color); } .brand-text { color: var(--brand-primary); }
        .brand-bg { 
            background-color: var(--brand-primary); 
            color: var(--bg-primary); 
        }
        .brand-border { border-color: var(--brand-primary); }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; } to: { opacity: 1; } }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; } @keyframes fadeOut { from { opacity: 1; } to: { opacity: 0; } }
        
        .toast { 
            animation: toast-in 0.5s cubic-bezier(0.16, 1, 0.3, 1), toast-out 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            bottom: -100px; 
        }
        @keyframes toast-in { from { bottom: -100px; opacity: 0; } to { bottom: 80px; opacity: 1; } }
        @keyframes toast-out { from { bottom: 80px; opacity: 1; } to { bottom: -100px; opacity: 0; display: none; } }
        
        .modal-overlay { 
            animation: fadeIn 0.3s ease; 
            backdrop-filter: blur(4px);
        }
        .modal-content { 
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 1.5rem 1.5rem 0 0; /* 24px */
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        #splash-screen img { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        .horizontal-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Order Tracker */
        .tracker-container { display: flex; align-items: center; justify-content: space-between; position: relative; }
        .tracker-line-container { position: absolute; top: 18px; left: 40px; right: 40px; height: 4px; background-color: var(--border-color); border-radius: 2px; }
        .tracker-progress { height: 100%; background-color: var(--brand-primary); border-radius: 2px; transition: width 0.5s ease-in-out; }
        .tracker-step { display: flex; flex-direction: column; align-items: center; text-align: center; width: 80px; position: relative; z-index: 1; }
        .tracker-icon-container { 
            width: 40px; height: 40px; border-radius: 50%; 
            background-color: var(--bg-primary); 
            border: 2px solid var(--border-color); 
            display: flex; align-items: center; justify-content: center; 
            transition: all 0.3s ease; 
            color: var(--text-secondary);
        }
        .tracker-step.active .tracker-icon-container { 
            border-color: var(--brand-primary); 
            background-color: var(--brand-primary); 
            color: var(--bg-primary);
            transform: scale(1.1); 
        }
        .tracker-label { margin-top: 8px; font-size: 10px; font-weight: 600; transition: color 0.3s ease; }
        .tracker-step.active .tracker-label { color: var(--brand-primary); }

        /* Instagram Gradient Text */
        .instagram-card {
            background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Classy X */
        .classy-x {
            font-family: 'Playfair Display', serif;
            font-style: normal; 
            font-weight: 600;
            font-size: 1.1em; 
            vertical-align: -0.1em; 
            margin: 0 -0.1em; 
        }
        
        /* Spinner */
        .spinner {
            border: 2px solid var(--bg-primary);
            border-top: 2px solid var(--brand-primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Bottom Nav */
        .nav-item {
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .nav-item-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 4.5rem; 
            height: 2.5rem; 
            border-radius: 9999px;
            transition: all 0.2s ease-in-out;
        }
        .nav-item.active .nav-item-content {
            background-color: var(--brand-primary);
            color: var(--bg-primary);
        }
        .nav-item.active .nav-label {
            font-weight: 700;
        }
        
        /* Category Tabs */
        .category-tab {
            padding: 0.5rem 1rem; 
            border-radius: 9999px;
            transition: all 0.2s ease-in-out;
        }
        .category-tab.active {
            background-color: var(--brand-primary);
            color: var(--bg-primary);
        }
        
        /* General Component Styling (Interactive) */
        .btn {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.75rem 1rem; 
            font-weight: 600;
            border-radius: 0.75rem; /* 12px */
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: pointer;
        }
        .btn:hover, .card-clickable:hover {
            transform: scale(1.02);
            opacity: 0.9;
        }
        .btn:active, .card-clickable:active {
            transform: scale(0.98);
            opacity: 1;
        }
        .btn-brand {
            background-color: var(--brand-primary);
            color: var(--bg-primary);
        }
        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .card {
            background-color: var(--bg-secondary);
            border-radius: 1rem; /* 16px */
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
            transition: all 0.2s ease;
        }
    </style>
</head>
<body data-theme="matcha">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-primary flex items-center justify-center z-[100]">
        <img src="https://qaytrfhpqsajgfqedxak.supabase.co/storage/v1/object/public/assets/WhatsApp%20Image%202025-10-08%20at%2009.25.36_1c1533ac.jpg" alt="HXOUSE Logo" class="w-48 h-48 object-contain rounded-full">
    </div>

    <!-- Main Application Container -->
    <div id="app" class="app-container max-w-lg mx-auto shadow-2xl flex flex-col hidden">
        <main class="flex-grow overflow-y-auto">
            <div id="main-interface" class="hidden">
                <header id="page-header" class="sticky top-0 bg-primary z-20 h-16 px-4 flex justify-between items-center border-b border-custom"></header>
                <div id="page-content"></div>
            </div>
            <div class="h-24 flex-shrink-0"></div>
        </main>
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 max-w-lg w-full bg-primary border-t border-custom flex justify-around items-center h-20 z-30 shadow-[0_-4px_12px_rgba(0,0,0,0.02)] hidden"></nav>
    </div>

    <!-- Global Containers -->
    <div id="modal-container"></div>
    <div id="toast" class="hidden fixed right-4 brand-bg py-3 px-5 rounded-xl shadow-xl z-50">
        <p id="toast-message" class="font-semibold"></p>
    </div>
    
<script>
// =================================================================================
//  SECTION 1: SETUP & CONFIGURATION
// =================================================================================

const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

function setAppHeight() {
  document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
}
window.addEventListener('resize', setAppHeight);
setAppHeight();

const SUPABASE_URL = 'https://ttdnlatylcqrevzlyrru.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0ZG5sYXR5bGNxcmV2emx5cnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzAyMDEsImV4cCI6MjA3NTc0NjIwMX0.aiQ1_viA1JrugEyMWxA2e5f2Aqrao9BNgCTb70NWyCc';
const supabase = self.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const STATIC_DATA = {
    captionIdeas: {
        student: [ "Fueling my study session with @hxousecoffeeco ☕️📚 #StudentLife", "Caffeine and concentration, courtesy of @hxousecoffeeco." ],
        office: [ "My real co-worker: this cup from @hxousecoffeeco 💼 #WorkFuel", "Turning coffee into code with @hxousecoffeeco." ],
        couple: [ "Coffee dates with my favorite person ❤️ @hxousecoffeeco", "Love is in the air, and it smells like coffee from @hxousecoffeeco." ],
        friends: [ "Good times and great coffee with the best crew! @hxousecoffeeco #Friends", "A perfect blend of friendship and coffee at @hxousecoffeeco!" ]
    }
};

const sound = {
    audioContext: null,
    init() {
        if (this.audioContext) return;
        try { this.audioContext = new (window.AudioContext || window.webkitAudioContext)(); } 
        catch (e) { console.error("Web Audio API is not supported in this browser."); }
    },
    play(type) {
        if (!this.audioContext) return;
        const o = this.audioContext.createOscillator(), g = this.audioContext.createGain();
        o.connect(g); g.connect(this.audioContext.destination); g.gain.setValueAtTime(0, this.audioContext.currentTime);
        const sounds = {
            click: { type: 'sine', freq: 600, gain: 0.2, len: 0.1 },
            add_to_cart: { type: 'triangle', freq: 440, gain: 0.3, len: 0.2 },
            success: { type: 'sine', freq: 523.25, gain: 0.3, len: 0.3, secondFreq: 659.25 },
            win: { type: 'sine', freq: 587.33, gain: 0.4, len: 0.3, secondFreq: 880 },
            draw: { type: 'sawtooth', freq: 220, gain: 0.2, len: 0.2, secondFreq: 180 },
        };
        const s = sounds[type]; if (!s) return;
        o.type = s.type; o.frequency.setValueAtTime(s.freq, this.audioContext.currentTime);
        g.gain.linearRampToValueAtTime(s.gain, this.audioContext.currentTime + 0.01);
        if (s.secondFreq) { o.frequency.setValueAtTime(s.secondFreq, this.audioContext.currentTime + (s.len / 2)); }
        g.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + s.len);
        o.start(this.audioContext.currentTime); o.stop(this.audioContext.currentTime + s.len);
    }
};

// =================================================================================
//  SECTION 2: CORE APPLICATION LOGIC
// =================================================================================
const app = {
    state: {
        currentPage: 'home',
        cart: [],
        activeOrder: null,
        tableNumber: null,
        user: null,
        customerProfile: null,
        theme: localStorage.getItem('hxouse-theme') || 'matcha', 
        menuData: [],
        appSettings: {},
        orderSubscription: null,
        currentMenuCategory: 'All', // UPDATED: Default to 'All'
        currentSearchTerm: '', // NEW: For search bar
    },
    
    async init() {
        document.body.addEventListener('click', () => sound.init(), { once: true });
        
        // Back Button/History Logic
        const initialHash = window.location.hash.replace('#', '');
        const validPages = ['home', 'order', 'cart', 'social', 'more'];
        if (initialHash && validPages.includes(initialHash)) {
            this.state.currentPage = initialHash;
            history.replaceState({ page: initialHash }, '', '#' + initialHash);
        } else {
            history.replaceState({ page: 'home' }, '', '#home');
            this.state.currentPage = 'home';
        }
        window.onpopstate = this.handlePopState.bind(this);

        this.startAppFlow();
    },

    handlePopState(event) {
        const state = event.state;
        
        if (ui.isModalOpen()) {
            ui.closeAllModals(true); 
            return; 
        }

        if (state && state.page) {
            this.navigateTo(state.page, true); // `true` = isPopping
        } else {
            this.navigateTo('home', true); // Fallback
        }
    },

    async startAppFlow() {
        this.applyTheme();
        $('#splash-screen').classList.remove('hidden');
        this.getTableNumberFromURL();
        
        try {
            const { data: { session } } = await supabase.auth.getSession();
            this.state.user = session?.user;
            if (!this.state.user) {
                const { data: signInData, error } = await supabase.auth.signInAnonymously();
                if (error) throw new Error(`Anonymous sign-in failed: ${error.message}`);
                this.state.user = signInData.user;
            }
            
            await Promise.all([ 
                this.fetchCustomerProfile(), 
                this.fetchMenuData(), 
                this.fetchAppSettings() 
            ]);

            $('#splash-screen').style.display = 'none';
            $('#app').classList.remove('hidden');
            $('#app').classList.add('flex');

            if (!this.state.customerProfile) {
                this.showOnboardingModal();
            } else if (this.state.tableNumber) {
                this.startSession();
            } else {
                this.showTableNumberModal();
            }

        } catch (error) {
            console.error("CRITICAL: Initialization failed.", error);
            $('#splash-screen').innerHTML = `<div class="text-primary text-center p-4">Could not load the app. Please check your connection and try again.</div>`;
        }
    },

    getTableNumberFromURL() {
        const params = new URLSearchParams(window.location.search);
        const tableNum = params.get('table');
        if (tableNum && !isNaN(parseInt(tableNum))) this.state.tableNumber = parseInt(tableNum);
    },

    async fetchCustomerProfile() { 
        if (!this.state.user) return;
        try {
            const { data, error } = await supabase.from('customers').select('*').eq('id', this.state.user.id).single();
            if (error && error.code !== 'PGRST116') throw error;
            if (data) this.state.customerProfile = data;
        } catch (error) { console.error('Error fetching profile:', error); ui.showToast('Could not fetch your profile.'); }
    },

    async fetchMenuData() {
        try {
            // UPDATED: Added `is_available` to the query, `false` items will be hidden
            const { data, error } = await supabase.from('products')
                .select('*')
                .eq('is_available', true)
                .order('id');
            if (error) throw error;
            
            const groupedMenu = data.reduce((acc, item) => {
                let category = acc.find(c => c.category === item.category);
                if (!category) {
                    category = { category: item.category, items: [] };
                    acc.push(category);
                }
                category.items.push(item);
                return acc;
            }, []);

            this.state.menuData = groupedMenu;

        } catch (error) {
            console.error('Error fetching menu data:', error);
            ui.showToast('Could not load the menu.');
            this.state.menuData = [];
        }
    },
        
    async fetchAppSettings() {
        try {
            const { data, error } = await supabase.from('app_settings').select('key, value');
            if (error) throw error;
            this.state.appSettings = data.reduce((acc, { key, value }) => ({ ...acc, [key]: value }), {});
        } catch (error) { console.error('Error fetching app settings:', error); }
    },
    
    showOnboardingModal(){
        const tableInputHTML = !this.state.tableNumber 
            ? `<input type="number" id="table-number-input" class="w-full p-3 border border-custom rounded-xl bg-secondary text-primary" placeholder="Your Table Number" required>`
            : '';
        ui.showModal('onboarding-modal', `
            <h2 class="text-2xl font-bold text-primary mb-2">Welcome to H<span class="classy-x">X</span>OUSE</h2><p class="text-secondary mb-6">A few details to get you started.</p>
            <div class="space-y-4">
                <input type="text" id="user-name-input" class="w-full p-3 border border-custom rounded-xl bg-secondary text-primary" placeholder="Your Name" required>
                ${tableInputHTML}
                <input type="tel" id="mobile-number-input" class="w-full p-3 border border-custom rounded-xl bg-secondary text-primary" placeholder="Mobile Number (Optional)">
            </div>
            <button onclick="app.completeOnboarding()" class="btn btn-brand w-full mt-6">Let's Go</button>
        `);
    },
    
    async completeOnboarding(){
        const name = $('#user-name-input').value.trim();
        let tableNumber = this.state.tableNumber;
        if (!tableNumber) {
            const tableInput = $('#table-number-input');
            if (!tableInput || !tableInput.value) return ui.showToast("Please enter your table number.");
            tableNumber = parseInt(tableInput.value);
        }
        if (!name) return ui.showToast("Please enter your name.");
        
        const { data, error } = await supabase.from('customers').insert({ 
            id: this.state.user.id, name, 
            whatsapp_number: $('#mobile-number-input').value.trim() 
        }).select().single();
        if (error) return ui.showToast('Could not save profile. Please try again.');
        
        this.state.customerProfile = data;
        this.state.tableNumber = tableNumber;
        ui.closeModal('onboarding-modal');
        this.startSession();
    },
    
    showTableNumberModal() {
        ui.showModal('table-number-modal', `
            <h2 class="text-2xl font-bold text-primary mb-2">Welcome back, ${this.state.customerProfile.name}!</h2>
            <p class="text-secondary mb-6">Please enter your table number for today's visit.</p>
            <input type="number" id="table-number-input" class="w-full p-3 border border-custom rounded-xl bg-secondary text-primary" placeholder="Your Table Number" required>
            <button onclick="app.completeTableNumberEntry()" class="btn btn-brand w-full mt-6">Continue</button>
        `);
    },

    completeTableNumberEntry() {
        const tableNumber = $('#table-number-input').value;
        if (!tableNumber) return ui.showToast("Please enter your table number.");
        this.state.tableNumber = parseInt(tableNumber);
        ui.closeModal('table-number-modal');
        this.startSession();
    },

    async startSession() {
        await this.fetchActiveOrder();
        this.showMainInterface(this.state.currentPage, true);
    },
    
    showMainInterface(page, isPopping = false){
        $('#main-interface').classList.remove('hidden');
        $('#bottom-nav').classList.remove('hidden');
        ui.renderBottomNav();
        this.navigateTo(page, isPopping);
    },

    navigateTo(page, isPopping = false){
        if (this.state.currentPage === page && !isPopping) return; 
        if (!this.state.customerProfile) return;
        
        if (!isPopping) sound.play('click'); 
        
        this.state.currentPage = page;
        ui.renderHeader(page);
        ui.renderPageContent(page);
        ui.updateActiveNav(page);

        if (!isPopping) {
            history.pushState({ page: page }, '', '#' + page);
        }
    },

    // REMOVED: jumpToCategory. 'order' page is now the destination.
    
    applyTheme(){ document.body.dataset.theme = this.state.theme; },
    toggleTheme(t){ this.state.theme = t; localStorage.setItem('hxouse-theme', t); this.applyTheme(); this.navigateTo('more'); },

    addOrUpdateCartFromModal(itemId) {
        const quantity = parseInt($('#modal-quantity-select').value);
        const cartItem = this.state.cart.find(i => i.id === itemId);

        if (cartItem) {
            cartItem.quantity = quantity;
        } else {
            const item = this.state.menuData.flatMap(c => c.items).find(i => i.id === itemId);
            if (!item) return;
            this.state.cart.push({ cartId: Date.now(), ...item, quantity: quantity });
        }

        ui.showToast('Cart updated!');
        sound.play('add_to_cart');
        ui.closeModal('item-detail-modal');
        this.refreshPage();
    },
    
    calculateCartTotal(){ return this.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0); },
    
    refreshPage(){
        ui.refreshCartDependentUI();
        ui.renderPageContent(this.state.currentPage);
    },
    
    async placeOrder(paymentMethod, btnElement){
        if (this.state.cart.length === 0 || !this.state.tableNumber) return ui.showToast("Cart is empty or table number is missing.");
        
        btnElement.disabled = true;
        const originalBtnHTML = btnElement.innerHTML;
        btnElement.innerHTML = `<span class="flex items-center justify-center"><div class="spinner mr-2"></div> Processing...</span>`;
        
        try {
            const { data: tableData, error: tableError } = await supabase.from('tables').select('id').eq('table_number', this.state.tableNumber).single();
            if (tableError || !tableData) {
                throw new Error(`Table #${this.state.tableNumber} is not a valid table.`);
            }
            
            const orderPayload = {
                customer_id: this.state.user.id,
                table_id: tableData.id,
                total_amount: this.calculateCartTotal(),
                payment_method: paymentMethod,
                special_instructions: $('#special-instructions')?.value || '',
            };
            
            const { data: orderData, error: orderError } = await supabase.from('orders').insert(orderPayload).select().single();
            if (orderError) throw orderError;
            
            const orderItems = this.state.cart.map(i => ({
                order_id: orderData.id,
                product_id: i.id,
                quantity: i.quantity,
                price_at_time_of_order: i.price
            }));

            const { error: itemsError } = await supabase.from('order_items').insert(orderItems);
            if (itemsError) {
                await supabase.from('orders').delete().eq('id', orderData.id);
                throw itemsError;
            }

            ui.closeModal('payment-modal');
            await this.fetchActiveOrder();
            this.state.cart = [];
            this.refreshPage();
            sound.play('success');
            this.navigateTo('cart');

        } catch (error) {
            console.error("Order failed:", error);
            ui.showToast(`Order failed: ${error.message}`);
            btnElement.disabled = false;
            btnElement.innerHTML = originalBtnHTML;
            const otherBtn = [...$$('.payment-btn')].find(b => b !== btnElement);
            if(otherBtn) otherBtn.disabled = false;
        }
    },
    
    async fetchActiveOrder(){
        if (!this.state.user) return;
        const { data, error } = await supabase.from('orders').select(`*, order_items(*, products(name))`).eq('customer_id', this.state.user.id).in('status', ['received', 'preparing']).order('created_at', { ascending: false }).limit(1).single();
        if (error && error.code !== 'PGRST116') console.error('Fetch active order error:', error);
        
        this.state.activeOrder = data || null;
        if (this.state.activeOrder) {
            this.listenToOrderUpdates(this.state.activeOrder.id);
        }
    },
    
    listenToOrderUpdates(orderId){
        if (this.state.orderSubscription) supabase.removeChannel(this.state.orderSubscription);
        this.state.orderSubscription = supabase.channel(`public:orders:id=eq.${orderId}`)
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${orderId}` }, payload => {
                if (!this.state.activeOrder) return;
                const updatedOrder = payload.new;
                
                if (updatedOrder.status !== this.state.activeOrder.status) {
                    ui.showToast(`Your order is now: ${updatedOrder.status}`);
                    this.state.activeOrder.status = updatedOrder.status;
                }

                if (['delivered', 'cancelled'].includes(updatedOrder.status)) {
                    supabase.removeChannel(this.state.orderSubscription);
                    this.state.orderSubscription = null;
                    if (updatedOrder.status === 'delivered') {
                        ui.showModal('review-modal', `
                            <div class="text-center">
                                <i data-lucide="star" class="w-12 h-12 inline-block text-yellow-400 fill-yellow-400"></i>
                                <h2 class="text-2xl font-bold mt-4">Order Delivered!</h2>
                                <p class="text-secondary my-2">How was your experience?</p>
                                <textarea id="feedback-text" class="w-full p-3 border border-custom rounded-xl bg-secondary" rows="3" placeholder="Tell us more..."></textarea>
                                <button onclick="app.submitFeedback('${orderId}')" class="btn btn-brand w-full mt-4">Submit Feedback</button>
                                <button onclick="ui.closeModal('review-modal')" class="btn btn-secondary w-full mt-2">Maybe Later</button>
                            </div>
                        `);
                    } else {
                        ui.showToast('Your order has been cancelled.');
                    }
                    this.state.activeOrder = null;
                }
                this.refreshPage();
            }).subscribe();
    },

    async submitFeedback(orderId){
        const content = $('#feedback-text').value.trim();
        if (!content) return ui.showToast("Please enter your feedback.");
        const { error } = await supabase.from('feedback').insert({ order_id: orderId, customer_id: this.state.user.id, content: content });
        if (error) return ui.showToast(`Could not submit feedback: ${error.message}`);
        ui.closeModal('review-modal');
        ui.showToast("Thank you for your feedback!");
    },
    
    async sendStaffCall(callType = 'assistance') {
        if (!this.state.tableNumber) return ui.showToast('Table number not set.');
        const { data: tableData } = await supabase.from('tables').select('id').eq('table_number', this.state.tableNumber).single();
        if (!tableData) return ui.showToast('Invalid table number.');

        const { error } = await supabase.from('staff_calls').insert({
            table_id: tableData.id,
            customer_id: this.state.user.id,
            call_type: callType
        });

        if (error) {
            ui.showToast(`Error: ${error.message}`);
        } else {
            ui.showToast(`Staff have been notified!`, 5000);
        }
    },

    copyCaption(text) {
        navigator.clipboard.writeText(text).then(() => ui.showToast('Copied!'), () => ui.showToast('Copy failed.'));
    }
};

// =================================================================================
// SECTION 3: UI COMPONENTS & RENDERERS
// =================================================================================
const ui = {
    refreshIcons() {
        lucide.createIcons();
    },

    showModal(id, content) {
        const existingModal = $(`#${id}`);
        if (existingModal) existingModal.remove();
        const modalHTML = `<div id="${id}" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-end justify-center z-50 p-4 pt-10"><div class="modal-content bg-primary shadow-xl p-6 w-full max-w-lg">${content}</div></div>`;
        $('#modal-container').insertAdjacentHTML('beforeend', modalHTML);
        
        history.pushState({ modal: id }, '', window.location.href);

        this.refreshIcons();
    },
    closeModal(id, isPopping = false) {
        const modal = $(`#${id}`);
        if (!modal) return false;
        
        modal.remove();
        
        if (!isPopping && history.state && history.state.modal === id) {
            history.back();
        }
        return true;
    },
    isModalOpen() { 
        return !!$('#modal-container').firstElementChild; 
    },
    closeAllModals(isPopping = false) {
        $$('#modal-container > div').forEach(modal => {
            this.closeModal(modal.id, isPopping);
        });
    },

    showToast(message, duration = 3000) {
        const toast = $('#toast'), p = $('#toast-message');
        p.textContent = message;
        toast.classList.remove('hidden');
        toast.style.animation = 'none';
        void toast.offsetWidth; 
        toast.style.animation = `toast-in 0.5s cubic-bezier(0.16, 1, 0.3, 1), toast-out 0.5s cubic-bezier(0.16, 1, 0.3, 1) ${duration / 1000 - 0.5}s forwards`;
        
        setTimeout(() => {
            toast.classList.add('hidden');
            toast.style.animation = '';
        }, duration);
    },
    
    renderHeader(page) {
        const header = $('#page-header');
        const pageConfigs = {
            home: { title: 'H<span class="classy-x">X</span>OUSE', back: false },
            order: { title: 'Menu', back: false },
            cart: { title: app.state.activeOrder ? 'Track Order' : 'My Cart', back: false },
            social: { title: 'Social', back: false },
            more: { title: 'More Options', back: false },
        };
        const config = pageConfigs[page] || { title: 'H<span class="classy-x">X</span>OUSE', back: false };
        header.innerHTML = `
            <div class="flex items-center space-x-2">
                <h1 class="text-2xl font-bold brand-text">${config.title}</h1>
            </div>
            <div class="text-right">
                <p class="font-semibold text-primary text-sm">${app.state.customerProfile.name}</p>
                <p class="text-xs text-secondary">Table #${app.state.tableNumber || 'N/A'}</p>
            </div>`;
    },
    
    renderPageContent(page) {
        const content = $('#page-content');
        content.innerHTML = '';
        const renderers = {
            home: this.renderHomePage,
            order: this.renderMenuPage,
            cart: this.renderCartPage,
            social: this.renderSocialPage,
            more: this.renderMorePage,
        };
        content.classList.remove('fade-in');
        void content.offsetWidth; 
        content.classList.add('fade-in');
        renderers[page]?.call(this);
        this.refreshIcons();
    },
    
    renderBottomNav(){
        const icons = { 
            home: 'home', 
            order: 'book-open', 
            cart: 'shopping-cart', 
            social: 'users', 
            more: 'menu' 
        };
        const pages = ['home', 'order', 'cart', 'social', 'more'];
        $('#bottom-nav').innerHTML = pages.map(p => `
            <button onclick="app.navigateTo('${p}')" class="nav-item flex-1 p-2 text-secondary" data-page="${p}">
                <div class="nav-item-content">
                    <i data-lucide="${icons[p]}" class="w-6 h-6"></i>
                    <span id="${p}-tab-label" class="nav-label text-xs capitalize mt-0.5">${p}</span>
                </div>
            </button>`).join('');
        this.refreshIcons();
    },
    
    updateActiveNav(page) {
        // --- FIXED: Added null checks ---
        const cartLabel = $('#cart-tab-label');
        const cartIcon = $$('.nav-item[data-page="cart"] i')[0];
        
        if (app.state.activeOrder) {
            if (cartLabel) cartLabel.textContent = 'Track';
            if (cartIcon) cartIcon.setAttribute('data-lucide', 'clipboard-list');
        } else {
            if (cartLabel) cartLabel.textContent = 'Cart';
            if (cartIcon) cartIcon.setAttribute('data-lucide', 'shopping-cart');
        }
        
        $$('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.page === page);
        });
        
        this.refreshIcons();
        this.refreshCartDependentUI();
    },

    refreshCartDependentUI() {
        const existingCount = $('#cart-count');
        if (existingCount) existingCount.remove();

        const total = app.state.cart.reduce((s, i) => s + i.quantity, 0);
        if (total > 0 && !app.state.activeOrder) {
            const cartNav = $('.nav-item[data-page="cart"] .nav-item-content');
            if (cartNav) {
                cartNav.classList.add('relative');
                cartNav.innerHTML += `<span id="cart-count" class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">${total}</span>`;
            }
        }
    },

    // --- NEW: Redesigned Home Page (with Video) ---
    renderHomePage(){
        const settings = app.state.appSettings;
        const promoTitle = 'Order for ₹799+ & post a story to get a <span class="instagram-card">Free Hamper!</span>';
        
        $('#page-content').innerHTML = `
            <div class="space-y-6">
                <!-- Video Slideshow is Back -->
                <div class="relative h-64 overflow-hidden rounded-b-2xl">
                    <video src="https://ttdnlatylcqrevzlyrru.supabase.co/storage/v1/object/public/assets/lv_0_20251012011509.mp4" autoplay loop muted playsinline preload="metadata" class="absolute top-1/2 left-1/2 w-full h-full object-cover -translate-x-1/2 -translate-y-1/2"></video>
                    <div class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4">
                        <h1 class="text-3xl font-bold" style="font-family: 'Playfair Display', serif;">${settings.welcome_title || 'H<span class="classy-x">X</span>OUSE'}</h1>
                        <p class="text-lg mt-1 font-light">${settings.welcome_subtitle || 'COFFEE CO.'}</p>
                    </div>
                </div>
                
                <div class="p-4 space-y-8">
                    <button onclick="app.navigateTo('order')" class="btn btn-brand w-full text-lg py-4">
                        <i data-lucide="book-open" class="w-5 h-5 mr-2"></i>
                        View Full Menu
                    </button>
                    
                    <div onclick="app.navigateTo('social')" class="card card-clickable cursor-pointer group relative p-6 overflow-hidden">
                        <i data-lucide="gift" class="absolute -top-4 -right-4 w-24 h-24 text-primary opacity-5"></i>
                        <h2 class="text-xl font-bold text-primary">${promoTitle}</h2>
                        <p class="mt-1 text-secondary text-sm">Tap to learn more & get caption ideas.</p>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <button onclick="app.sendStaffCall()" class="card card-clickable p-4 text-center flex flex-col items-center justify-center h-28">
                            <i data-lucide="bell" class="w-8 h-8 brand-text"></i>
                            <p class="font-semibold mt-2 text-primary">Call Staff</p>
                        </button>
                    </div>
                </div>
            </div>`;
    },
    
    // --- UPDATED: Menu Page (with Search and "All" tab) ---
    renderMenuPage() {
        const content = $('#page-content');
        if (app.state.menuData.length === 0) {
            content.innerHTML = `<div class="p-4 text-center text-secondary">Loading menu...</div>`; return;
        }

        // Create categories array with "All"
        let categories = [{ category: 'All' }, ...app.state.menuData];

        // Set default category if not set
        if (!app.state.currentMenuCategory) {
            app.state.currentMenuCategory = 'All';
        }

        content.innerHTML = `
            <!-- NEW: Search Bar -->
            <div class="p-4 sticky top-16 bg-primary z-10 border-b border-custom">
                <div class="relative">
                    <input type="text" id="menu-search-input" 
                           oninput="ui.handleSearch(this.value)" 
                           value="${app.state.currentSearchTerm}"
                           class="w-full pl-10 pr-4 py-3 rounded-xl bg-secondary border border-custom text-primary" 
                           placeholder="Search menu...">
                    <i data-lucide="search" class="w-5 h-5 text-secondary absolute left-3 top-1/2 -translate-y-1/2"></i>
                </div>
            </div>
            
            <!-- Category Tabs -->
            <div class="horizontal-scroll sticky top-[141px] bg-primary z-10 flex space-x-2 px-4 py-3 overflow-x-auto border-b border-custom">
                ${categories.map(c => `<button 
                    class="category-tab whitespace-nowrap font-semibold py-2 px-4 rounded-full ${app.state.currentMenuCategory === c.category ? 'active' : 'text-secondary'}" 
                    data-category="${c.category}" 
                    onclick="ui.filterMenuByCategory('${c.category}', this)">
                    ${c.category}
                </button>`).join('')}
            </div>
            
            <div id="menu-items" class="p-4 space-y-4"></div>`;

        this.updateMenuDisplay(); // Initial render
    },

    // --- NEW: Search handler ---
    handleSearch(term) {
        app.state.currentSearchTerm = term.toLowerCase();
        this.updateMenuDisplay();
    },

    filterMenuByCategory(category, tabElement) {
        app.state.currentMenuCategory = category; 
        
        $$('.category-tab').forEach(tab => tab.classList.remove('active'));
        if(tabElement) tabElement.classList.add('active');
        
        this.updateMenuDisplay();
    },

    // --- NEW: Central function to update menu items based on state ---
    updateMenuDisplay() {
        let allItems = app.state.menuData.flatMap(c => c.items);
        let itemsToShow = [];

        // 1. Filter by Category
        if (app.state.currentMenuCategory === 'All') {
            itemsToShow = allItems;
        } else {
            itemsToShow = allItems.filter(i => i.category === app.state.currentMenuCategory);
        }

        // 2. Filter by Search Term
        if (app.state.currentSearchTerm) {
            itemsToShow = itemsToShow.filter(i => 
                i.name.toLowerCase().includes(app.state.currentSearchTerm) ||
                (i.description && i.description.toLowerCase().includes(app.state.currentSearchTerm))
            );
        }

        this.renderMenuItems(itemsToShow);
        this.refreshIcons();
    },

    // Typographical Menu List
    renderMenuItems(items) {
        const container = $('#menu-items');
        if (items.length === 0) {
            container.innerHTML = `<p class="text-secondary text-center p-8">No items match your search.</p>`;
            return;
        }

        container.innerHTML = items.map(item => {
                const cartItem = app.state.cart.find(ci => ci.id === item.id);
                const quantityBadge = cartItem ? `<div class="absolute top-2 right-2 brand-bg text-xs rounded-full h-6 w-6 flex items-center justify-center font-bold shadow-lg">${cartItem.quantity}</div>` : '';

                return `
                <div class="card overflow-hidden relative">
                    ${quantityBadge}
                    <div class="p-4 flex justify-between items-start cursor-pointer" onclick="ui.showItemDetailModal(${item.id})">
                        <div class="flex-grow pr-4">
                            <h3 class="font-semibold text-lg text-primary">${item.name}</h3>
                            <p class="text-secondary text-sm mt-1">${item.description || ''}</p>
                            <p class="font-bold text-primary text-base mt-3">₹${item.price}</p>
                        </div>
                        <button onclick="event.stopPropagation(); ui.showItemDetailModal(${item.id})" class="btn btn-brand w-12 h-12 rounded-xl p-0 flex-shrink-0">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
    },
    
    renderCartPage() {
        const content = $('#page-content');
        if (app.state.activeOrder) this.renderOrderTracking(content);
        else if (app.state.cart.length > 0) this.renderCart(content);
        else content.innerHTML = `<div class="text-center p-10 flex flex-col items-center">
            <i data-lucide="shopping-basket" class="w-20 h-20 text-secondary opacity-50"></i>
            <h2 class="text-2xl font-bold text-primary mt-4">Your cart is empty</h2>
            <p class="text-secondary mt-2">Add items from the menu to get started.</p>
            <button onclick="app.navigateTo('order')" class="btn btn-brand mt-6">View Menu</button>
            </div>`;
    },

    renderCart(container){
        const total = app.calculateCartTotal();
        let hamperMessage = '';
        if (total > 0 && total < 799) {
            const amountNeeded = 799 - total;
            hamperMessage = `<div class="p-4"><div class="bg-orange-100 border border-orange-200 text-orange-800 p-3 rounded-xl text-center font-semibold text-sm flex items-center justify-center">
                <i data-lucide="gift" class="w-4 h-4 mr-2"></i>
                Order for ₹${amountNeeded.toFixed(2)} more to get a free hamper!
                </div></div>`;
        } else if (total >= 799) {
            hamperMessage = `<div class="p-4"><div class="bg-green-100 border border-green-200 text-green-800 p-3 rounded-xl text-center font-semibold text-sm flex items-center justify-center">
                <i data-lucide="party-popper" class="w-4 h-4 mr-2"></i>
                You're eligible for a free hamper! Don't forget to post a story.
                </div></div>`;
        }

        container.innerHTML = `
            <div class="p-4 space-y-3">${app.state.cart.map(i => `
                <div class="card p-3">
                    <div class="flex justify-between items-start">
                        <p class="font-bold text-primary">${i.name}</p>
                        <p class="font-semibold text-primary">₹${(i.price * i.quantity).toFixed(2)}</p>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <button onclick="app.state.cart = app.state.cart.filter(ci => ci.cartId !== ${i.cartId}); app.refreshPage();" class="text-red-500 font-semibold text-xs hover:underline">Remove</button>
                        <p class="text-sm text-secondary">Quantity: ${i.quantity}</p>
                    </div>
                </div>`).join('')}
            </div>
            ${hamperMessage}
            <div class="p-4"><textarea id="special-instructions" class="w-full p-3 border-custom rounded-xl bg-secondary" placeholder="Add special instructions..."></textarea></div>
            <div class="p-4 bg-primary border-t border-custom sticky bottom-20">
                <div class="flex justify-between items-center mb-4"><span class="text-xl font-bold text-primary">Total</span><span class="text-xl font-bold">₹${total.toFixed(2)}</span></div>
                <button id="place-order-btn" onclick="ui.showPaymentModal()" class="btn btn-brand w-full text-lg py-4">Proceed to Payment</button>
            </div>`;
    },

    renderOrderTracking(container) {
        const order = app.state.activeOrder;
        if (!order) { container.innerHTML = ''; return; }
        
        const statuses = ['received', 'preparing', 'delivered'];
        const icons = { received: 'clipboard-list', preparing: 'chef-hat', delivered: 'smile' };
        const currentIndex = statuses.indexOf(order.status);
        const progressPercentage = currentIndex > 0 ? (currentIndex / (statuses.length - 1)) * 100 : 0;
        
        container.innerHTML = `
            <div class="p-6 flex flex-col items-center justify-center h-full">
                <h2 class="text-3xl font-bold text-center capitalize">Your Order is ${order.status}</h2>
                <p class="text-secondary text-center mb-10">Order ID: #${order.id.slice(0,6)}</p>
                
                <div class="tracker-container my-12 w-full max-w-sm">
                    <div class="tracker-line-container">
                        <div class="tracker-progress" style="width: ${progressPercentage}%"></div>
                    </div>
                    ${statuses.map((status, index) => `
                        <div class="tracker-step ${index <= currentIndex ? 'active' : ''}">
                            <div class="tracker-icon-container"><i data-lucide="${icons[status]}" class="w-5 h-5"></i></div>
                            <span class="tracker-label capitalize">${status}</span>
                        </div>`).join('')}
                </div>

                <div class="mt-auto pt-10 text-center">
                    <p class="text-secondary mb-4">While you wait, why not play a game?</p>
                    <button onclick="ui.showGamesModal()" class="btn btn-brand px-8">Play Games</button>
                </div>
            </div>`;
    },
    
    renderSocialPage(){
        const promoTitle = 'Order for ₹799+ & post a story to get a <span class="instagram-card">Free Hamper!</span>';
        const promoSubtitle = 'Show your bill & story at the counter to claim your gift from H<span class="classy-x">X</span>OUSE.';
        
        $('#page-content').innerHTML = `
            <div class="p-4 space-y-6 text-center">
                 <div class="card p-6">
                    <h2 class="text-2xl font-bold text-primary">Join Our Community!</h2>
                    <p class="text-secondary mt-1">Follow us on Instagram for updates, offers, and good vibes.</p>
                    <a href="https://instagram.com/hxousecoffeeco" target="_blank" class="instagram-card text-2xl font-bold my-4 block">@hxousecoffeeco</a>
                    <div class="flex justify-center">
                         <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://instagram.com/hxousecoffeeco" alt="Instagram QR Code" class="rounded-lg bg-white p-2 border border-custom">
                    </div>
                    <p class="text-xs text-secondary mt-2">Scan to follow!</p>
                </div>

                <div onclick="ui.showInstagramPromo()" class="card card-clickable cursor-pointer group relative p-6 overflow-hidden text-left">
                    <i data-lucide="gift" class="absolute -top-4 -right-4 w-24 h-24 text-primary opacity-5"></i>
                    <h2 class="text-2xl font-bold text-primary">${promoTitle}</h2>
                    <p class="mt-1 text-secondary">${promoSubtitle}</p>
                    <button class="btn btn-brand mt-4 text-sm px-4 py-2">Get Caption Ideas &rarr;</button>
                </div>
            </div>
        `;
    },

    renderMorePage(){
        const options = [
            { icon: "palette", text: "Change Theme", action: "ui.showThemeModal()" },
            { icon: "gamepad-2", text: "Play Games", action: "ui.showGamesModal()" },
            { icon: "wifi", text: "View Wi-Fi Details", action: "ui.showWifiModal()" },
            { icon: "history", text: "Order History", action: "ui.showOrderHistoryModal()" },
        ];
        $('#page-content').innerHTML = `
            <div class="p-4 space-y-3">${options.map(opt => `
                <button onclick="${opt.action}" class="w-full flex items-center justify-between card card-clickable p-4 text-left">
                    <div class="flex items-center">
                        <i data-lucide="${opt.icon}" class="w-6 h-6 brand-text mr-4"></i>
                        <span class="font-semibold text-primary">${opt.text}</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-secondary"></i>
                </button>`).join("")}
            </div>`;
    },

    // --- MODAL RENDERERS ---
    showPaymentModal(){
         ui.showModal('payment-modal', `
            <h2 class="text-xl font-bold text-primary mb-4">Select Payment</h2>
            <div class="space-y-3">
                <button onclick="app.placeOrder('Pay at Counter', this)" class="payment-btn btn btn-secondary w-full">
                    <i data-lucide="landmark" class="w-5 h-5 mr-3"></i>
                    <span>Pay at Counter</span>
                </button>
                <button onclick="app.placeOrder('UPI / QR Code', this)" class="payment-btn btn btn-secondary w-full">
                    <i data-lucide="smartphone" class="w-5 h-5 mr-3"></i>
                    <span>UPI / QR Code</span>
                </button>
            </div>
            <button onclick="ui.closeModal('payment-modal')" class="btn btn-secondary w-full mt-6">Cancel</button>
        `);
    },
    
    showItemDetailModal(itemId){
        const item = app.state.menuData.flatMap(c => c.items).find(i => i.id === itemId); if (!item) return;
        const cartItem = app.state.cart.find(ci => ci.id === itemId);
        const currentQuantity = cartItem ? cartItem.quantity : 1;
        let optionsHTML = Array.from({ length: 10 }, (_, i) => `<option value="${i + 1}" ${i + 1 === currentQuantity ? 'selected' : ''}>${i + 1}</option>`).join('');

        ui.showModal('item-detail-modal', `
            <div>
                <h2 class="text-2xl font-bold text-primary">${item.name}</h2>
                <p class="text-xl font-semibold text-secondary">₹${item.price}</p>
            </div>
            <p class="text-secondary mt-2">${item.description || 'A delicious choice.'}</p>
            <div class="flex items-center justify-between my-6 bg-secondary p-3 rounded-xl">
                <label for="modal-quantity-select" class="font-semibold text-primary">Quantity:</label>
                <select id="modal-quantity-select" class="bg-primary border border-custom text-primary font-semibold rounded-lg p-2">${optionsHTML}</select>
            </div>
            <div class="mt-6 grid grid-cols-2 gap-4">
                <button onclick="ui.closeModal('item-detail-modal')" class="btn btn-secondary">Back</button>
                <button onclick="app.addOrUpdateCartFromModal(${item.id})" class="btn btn-brand">${cartItem ? 'Update Quantity' : 'Add to Cart'}</button>
            </div>`);
    },

    showInstagramPromo(){
        const vibes = Object.entries(STATIC_DATA.captionIdeas).map(([key, _]) => ({
            name: key, icon: { student: 'graduation-cap', office: 'briefcase', couple: 'heart', friends: 'party-popper' }[key]
        }));
        ui.showModal('insta-modal', `
            <h2 class="text-2xl font-bold">Post for a Free Hamper!</h2>
            <p class="text-secondary mt-1 mb-6">If your order is over ₹799, post a story tagging us, and show both at the counter!</p>
            <div class="grid grid-cols-2 gap-4">${vibes.map(v => `
                <button onclick="ui.showCaptionIdeas('${v.name}')" class="btn btn-secondary flex-col h-28">
                    <i data-lucide="${v.icon}" class="w-8 h-8"></i>
                    <p class="font-semibold mt-2 capitalize">${v.name}</p>
                </button>`).join('')}
            </div>
            <button onclick="ui.closeModal('insta-modal')" class="btn btn-secondary w-full mt-6">Cancel</button>
        `);
    },

    showCaptionIdeas(category){
        ui.closeModal('insta-modal');
        const captions = STATIC_DATA.captionIdeas[category];
        ui.showModal('caption-modal', `
            <h2 class="text-2xl font-bold">Caption Ideas</h2>
            <p class="text-secondary mt-1 mb-4">Tap to copy. Tag us <span class="font-bold brand-text">@hxousecoffeeco</span>!</p>
            <div class="space-y-2 max-h-48 overflow-y-auto">${captions.map(c => `
                <div onclick="app.copyCaption('${c.replace(/'/g, "\\'")}')" class="bg-secondary p-3 rounded-lg text-sm font-medium cursor-pointer flex justify-between items-center">
                    <span>${c}</span><i data-lucide="copy" class="w-4 h-4 brand-text ml-2"></i>
                </div>`).join('')}
            </div>
            <a href="instagram://story-camera" class="btn btn-brand w-full text-center mt-6" style="background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%); color: white;">
                <i data-lucide="instagram" class="w-5 h-5 mr-2"></i>
                Open Instagram Story
            </a>
            <button onclick="ui.closeModal('caption-modal')" class="btn btn-secondary w-full mt-2">Close</button>
        `);
    },
    
    showGamesModal() {
        ui.showModal('games-modal', `
            <h2 class="text-xl font-bold text-center mb-4">Entertainment</h2>
            <div class="space-y-3">
                ${Object.values(GAMES).map(game => `
                    <div class="card p-4">
                        <h3 class="text-lg font-bold text-primary mb-1">${game.title}</h3>
                        <p class="text-secondary text-sm mb-3">${game.description}</p>
                        <button onclick="GAMES['${game.id}'].start()" class="btn btn-brand text-sm px-4 py-2">Play</button>
                    </div>`).join("")}
            </div>
            <button onclick="ui.closeModal('games-modal')" class="btn btn-secondary w-full mt-6">Close</button>
        `);
    },

    showThemeModal() {
        const themes = [ { n: 'matcha', i: 'coffee' }, { n: 'light', i: 'sun' }, { n: 'dark', i: 'moon' }, { n: 'sunset', i: 'sunset' }];
        ui.showModal('theme-modal', `
            <h2 class="text-xl font-bold mb-4">Choose Theme</h2>
            <div class="grid grid-cols-2 gap-4">${themes.map(t => `<button onclick="app.toggleTheme('${t.n}')" class="btn btn-secondary flex-col h-28 ${app.state.theme === t.n ? 'brand-border' : ''}">
                <i data-lucide="${t.i}" class="w-8 h-8"></i>
                <p class="font-semibold mt-2 capitalize">${t.n}</p>
                </button>`).join('')}</div>
            <button onclick="ui.closeModal('theme-modal')" class="btn btn-secondary w-full mt-6">Close</button>
        `);
    },
    
    showWifiModal() {
        ui.showModal('wifi-modal', `
            <div class="text-center">
                <i data-lucide="wifi" class="w-12 h-12 brand-text mx-auto"></i>
                <h2 class="text-xl font-bold mt-4 mb-2">Wi-Fi Network</h2>
                <p class="text-secondary mb-4">Connect and enjoy!</p>
                <div class="card p-4">
                    <p class="text-xs">Network Name</p><p class="font-bold text-lg">THE CO-WORK HUB</p>
                    <hr class="border-custom my-3">
                    <p class="text-xs">Password</p><p class="font-bold text-lg">95462418</p>
                </div>
                <button onclick="ui.closeModal('wifi-modal')" class="btn btn-secondary w-full mt-6">Close</button>
            </div>
        `);
    },
    
    async showOrderHistoryModal() {
        const { data } = await supabase.from('orders').select(`*, order_items (products(name), quantity)`).eq('customer_id', app.state.user.id).order('created_at', { ascending: false });
        const historyHTML = data?.length > 0 ? data.map(o => `
            <div class="card p-3">
                <div class="flex justify-between">
                    <div>
                        <p class="font-bold">Order #${o.id.slice(0, 6)}</p>
                        <p class="text-xs text-secondary">${new Date(o.created_at).toLocaleString()}</p>
                    </div>
                    <p class="font-semibold">₹${o.total_amount}</p>
                </div>
                <div class="text-sm text-secondary mt-2">${o.order_items.map(i => `${i.products.name} (x${i.quantity})`).join(', ')}</div>
            </div>`).join('') : '<p class="text-secondary text-center">No past orders found.</p>';
        
        ui.showModal('history-modal', `
            <h2 class="text-xl font-bold text-center mb-4">Order History</h2>
            <div class="space-y-3 max-h-60 overflow-y-auto">${historyHTML}</div>
            <button onclick="ui.closeModal('history-modal')" class="btn btn-secondary w-full mt-6">Close</button>
        `);
    }
};

// =================================================================================
//  SECTION 4: GAMES & INTERACTIVE MODULES
// =================================================================================
const GAMES = {
    ticTacToe: {
        id: 'ticTacToe', title: 'Tic-Tac-Toe', description: 'Classic 2-player game for your table.',
        board: Array(9).fill(null),
        currentPlayer: "X",
        winner: null,
        start() {
            this.reset();
            ui.showModal('ttt-modal', `
                <h2 class="text-2xl font-bold mb-2 text-center">Tic-Tac-Toe</h2>
                <p id="ttt-status" class="font-semibold text-secondary mb-4 text-center">Player X's turn</p>
                <div class="w-full max-w-[250px] mx-auto">
                    <div id="ttt-board" class="grid grid-cols-3 gap-2 my-4">
                        ${this.board.map((_, i) => `<div class="aspect-square bg-secondary flex items-center justify-center text-5xl sm:text-6xl font-bold rounded-lg cursor-pointer" onclick="GAMES.ticTacToe.play(${i})"></div>`).join("")}
                    </div>
                </div>
                <button onclick="GAMES.ticTacToe.start()" class="btn btn-brand w-full mt-2">New Game</button>
                <button onclick="ui.closeModal('ttt-modal')" class="btn btn-secondary w-full mt-2">Close</button>
            `);
        },
        play(i) {
            if (this.board[i] || this.winner) return;
            this.board[i] = this.currentPlayer;
            this.checkWinner();
            this.currentPlayer = this.currentPlayer === "X" ? "O" : "X";
            this.updateUI();
        },
        checkWinner() {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]
            ];
            for (let line of lines) {
                const [a, b, c] = line;
                if (this.board[a] && this.board[a] === this.board[b] && this.board[a] === this.board[c]) {
                    this.winner = this.board[a];
                    sound.play("win");
                    return;
                }
            }
            if (this.board.every(cell => cell)) { this.winner = "Draw"; sound.play("draw"); }
        },
        updateUI() {
            $$("#ttt-board > div").forEach((cell, i) => {
                cell.textContent = this.board[i];
                cell.style.color = this.board[i] === "X" ? "#3b82f6" : "#ef4444";
            });
            $("#ttt-status").textContent = this.winner ? (this.winner === "Draw" ? "It's a Draw!" : `Player ${this.winner} wins!`) : `Player ${this.currentPlayer}'s turn`;
        },
        reset() { this.board.fill(null); this.currentPlayer = "X"; this.winner = null; }
    },
    coffeeTrivia: {
        id: 'coffeeTrivia', title: 'Coffee Trivia', description: 'Test your coffee knowledge!',
        currentQuestion: null,
        trivia: [
            { q: "Where was coffee first discovered?", o: ["Brazil", "Ethiopia", "Colombia", "Vietnam"], a: 1 },
            { q: "What does 'espresso' mean in Italian?", o: ["Fast Coffee", "Dark Coffee", "Expressed or Forced Out", "Morning Ritual"], a: 2 },
            { q: "What is the most expensive coffee in the world, often involving an animal?", o: ["Blue Mountain", "Geisha", "Kopi Luwak", "Bourbon"], a: 2 },
            { q: "Which country is the largest producer of coffee?", o: ["Brazil", "Vietnam", "Indonesia", "India"], a: 0 }
        ],
        start() {
            this.currentQuestion = this.trivia[Math.floor(Math.random() * this.trivia.length)];
            const item = this.currentQuestion;
            ui.showModal('trivia-modal', `
                <div class="text-center">
                    <h2 class="text-xl font-bold mb-2">Coffee Trivia</h2>
                    <p class="text-secondary mb-6 h-12">${item.q}</p>
                    <div id="trivia-options" class="space-y-3">
                        ${item.o.map((opt, index) => `<button class="trivia-option btn btn-secondary w-full" onclick="GAMES.coffeeTrivia.checkAnswer(${index}, ${item.a})">${opt}</button>`).join('')}
                    </div>
                    <button onclick="ui.closeModal('trivia-modal')" class="btn btn-secondary w-full mt-6">Close</button>
                </div>
            `);
        },
        checkAnswer(selectedIndex, correctIndex) {
            const options = $$('.trivia-option');
            options.forEach((btn, index) => {
                btn.disabled = true;
                btn.classList.remove('btn-secondary');
                if (index === correctIndex) {
                    btn.classList.add('bg-green-500', 'text-white');
                } else if (index === selectedIndex) {
                    btn.classList.add('bg-red-500', 'text-white');
                }
            });
            if (selectedIndex === correctIndex) sound.play('success');
            else sound.play('draw');
            setTimeout(() => this.start(), 2000);
        }
    },
    coffeeArt: {
        id: 'coffeeArt', title: 'Coffee Art Studio', description: 'Unleash your inner barista and create some latte art.',
        canvas: null, ctx: null, painting: false,
        start() {
            ui.showModal('art-modal', `<div class="text-center"><h2 class="text-2xl font-bold mb-2">Coffee Art Studio</h2><div class="relative w-full aspect-square mx-auto my-4 rounded-full bg-[#c4a484] overflow-hidden cursor-crosshair" id="canvas-container"><canvas id="coffee-art-canvas"></canvas></div><div class="flex justify-center items-center space-x-2"><button onclick="GAMES.coffeeArt.changeColor('#ffffff')" class="w-8 h-8 rounded-full bg-white border-2 border-custom"></button><button onclick="GAMES.coffeeArt.changeColor('#5a3825')" class="w-8 h-8 rounded-full bg-[#5a3825] border-2 border-custom"></button><button onclick="GAMES.coffeeArt.clearCanvas()" class="btn btn-secondary font-semibold py-1 px-3 rounded-lg text-sm">Clear</button></div><button onclick="ui.closeModal('art-modal')" class="btn btn-secondary w-full mt-6">Done</button></div>`);
            this.initCanvas();
        },
        initCanvas() {
            this.canvas = $("#coffee-art-canvas");
            const container = $('#canvas-container');
            if (!this.canvas || !container) return;
            this.ctx = this.canvas.getContext("2d");
            const size = container.clientWidth;
            this.canvas.width = size;
            this.canvas.height = size;
            this.ctx.strokeStyle = "#ffffff"; this.ctx.lineWidth = 5; this.ctx.lineCap = "round";
            this.canvas.addEventListener("pointerdown", this.startPosition.bind(this));
            this.canvas.addEventListener("pointerup", this.finishedPosition.bind(this));
            this.canvas.addEventListener("pointermove", this.draw.bind(this));
            this.canvas.addEventListener("touchstart", this.startPosition.bind(this), { passive: false });
            this.canvas.addEventListener("touchend", this.finishedPosition.bind(this));
            this.canvas.addEventListener("touchmove", this.draw.bind(this), { passive: false });
        },
        getEventPosition(e) {
            const rect = this.canvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
            }
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        },
        startPosition(e) { this.painting = true; this.draw(e); },
        finishedPosition() { this.painting = false; this.ctx.beginPath(); },
        draw(e) {
            if (!this.painting) return; 
            e.preventDefault();
            const { x, y } = this.getEventPosition(e);
            this.ctx.lineTo(x, y); this.ctx.stroke();
            this.ctx.beginPath(); this.ctx.moveTo(x, y);
        },
        changeColor(c) { if(this.ctx) this.ctx.strokeStyle = c; },
        clearCanvas() { if(this.ctx) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); }
    },
};

// =================================================================================
//  SECTION 5: APP INITIALIZATION
// =================================================================================
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    app.init();
});

</script>
</body>
</html>

