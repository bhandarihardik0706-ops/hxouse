<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Welcome to HXOUSE Coffee Co.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400..900&family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary-light: #FFFFFF; --bg-secondary-light: #F3F4F6; --text-primary-light: #111827; --text-secondary-light: #6B7280; --border-light: #E5E7EB; --brand-primary-light: #111827;
            --bg-primary-dark: #111111; --bg-secondary-dark: #1F2023; --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF; --border-dark: #374151; --brand-primary-dark: #FFFFFF;
            --bg-primary-sunset: #1E1E2E; --bg-secondary-sunset: #2D2D44; --text-primary-sunset: #F6F6F6; --text-secondary-sunset: #A8A8C3; --border-sunset: #4A4A6A; --brand-primary-sunset: #FFA756;
            --bg-primary-matcha: #F0FFF4; --bg-secondary-matcha: #DCF2E3; --text-primary-matcha: #2F4858; --text-secondary-matcha: #5C7A89; --border-matcha: #B8D8C0; --brand-primary-matcha: #3A8154;
            --app-height: 100vh;
        }
        [data-theme="light"] { --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border-color: var(--border-light); --brand-primary: var(--brand-primary-light); }
        [data-theme="dark"] { --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border-color: var(--border-dark); --brand-primary: var(--brand-primary-dark); }
        [data-theme="sunset"] { --bg-primary: var(--bg-primary-sunset); --bg-secondary: var(--bg-secondary-sunset); --text-primary: var(--text-primary-sunset); --text-secondary: var(--text-secondary-sunset); --border-color: var(--border-sunset); --brand-primary: var(--brand-primary-sunset); }
        [data-theme="matcha"] { --bg-primary: var(--bg-primary-matcha); --bg-secondary: var(--bg-secondary-matcha); --text-primary: var(--text-primary-matcha); --text-secondary: var(--text-secondary-matcha); --border-color: var(--border-matcha); --brand-primary: var(--brand-primary-matcha); }

        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Poppins', sans-serif; background-color: #000000; color: var(--text-primary); -webkit-tap-highlight-color: transparent; transition: background-color 0.5s ease; }
        .app-container { background-color: var(--bg-primary); transition: background-color 0.5s ease; height: var(--app-height); }
        .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); }
        .bg-primary { background-color: var(--bg-primary); } .bg-secondary { background-color: var(--bg-secondary); }
        .border-custom { border-color: var(--border-color); } .brand-text { color: var(--brand-primary); }
        .brand-bg { background-color: var(--brand-primary); color: var(--bg-primary); }
        .brand-border { border-color: var(--brand-primary); }

        .fade-in { animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; } @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; display: none; } }

        .toast { animation: toast-in 0.5s ease, toast-out 0.5s ease forwards; }
        @keyframes toast-in { from { bottom: -100px; opacity: 0; } to { bottom: 80px; opacity: 1; } }
        @keyframes toast-out { from { opacity: 1; } to { opacity: 0; display: none; } }

        .modal-overlay { animation: fadeIn 0.3s ease; }
        .modal-content {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #splash-screen img { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* MODIFIED: Custom height transition class for smooth accordion */
        .accordion-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
            /* Use a CSS variable that will be set by JS on toggle */
            max-height: 0;
            opacity: 0;
        }
        .accordion-content.open {
            opacity: 1;
        }


        .tracker-container { display: flex; align-items: center; justify-content: space-between; position: relative; }
        .tracker-line-container { position: absolute; top: 18px; left: 40px; right: 40px; height: 4px; background-color: var(--border-color); border-radius: 2px; }
        .tracker-progress { height: 100%; background-color: var(--brand-primary); border-radius: 2px; transition: width 0.5s ease-in-out; }
        .tracker-step { display: flex; flex-direction: column; align-items: center; text-align: center; width: 80px; position: relative; z-index: 1; }
        .tracker-icon-container { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-primary); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; font-size: 20px; }
        .tracker-step.active .tracker-icon-container { border-color: var(--brand-primary); background-color: var(--brand-primary); color: var(--bg-primary); transform: scale(1.1); }
        .tracker-label { margin-top: 8px; font-size: 10px; font-weight: 600; transition: color 0.3s ease; }
        .tracker-step.active .tracker-label { color: var(--brand-primary); }

        .instagram-card {
            background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .classy-x {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-weight: 600;
            font-size: 1.5em;
            vertical-align: -0.2em;
        }
        .spinner {
            border: 2px solid var(--bg-primary);
            border-top: 2px solid var(--brand-primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .add-to-cart-btn { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-primary); color: var(--brand-primary); border: 2px solid var(--border-color); font-size: 24px; font-weight: 600; line-height: 1; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .add-to-cart-btn:hover { transform: scale(1.1); background-color: var(--brand-primary); color: var(--bg-primary); border-color: var(--brand-primary); }
        .quantity-control { display: flex; align-items: center; justify-content: space-between; background-color: var(--brand-primary); color: var(--bg-primary); border-radius: 9999px; font-weight: 600; overflow: hidden; width: 100px; height: 40px; user-select: none; }
        .quantity-control button { width: 34px; height: 100%; font-size: 20px; line-height: 1; transition: background-color 0.2s ease; }
        .quantity-control button:hover { background-color: rgba(0,0,0,0.1); }
        .quantity-control span { font-size: 16px; }

        #loyalty-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--bg-secondary); outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 4px; }
        #loyalty-slider:hover { opacity: 1; }
        #loyalty-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--brand-primary); cursor: pointer; border-radius: 50%; }
        #loyalty-slider::-moz-range-thumb { width: 20px; height: 20px; background: var(--brand-primary); cursor: pointer; border-radius: 50%; border: none; }

        /* Custom CSS for Accordion Arrow Transition */
        .accordion-arrow {
            transition: transform 0.3s ease;
        }
        .rotate-90 {
            transform: rotate(90deg);
        }
    </style>
</head>
<body data-theme="matcha">

    <div id="splash-screen" class="fixed inset-0 bg-primary flex items-center justify-center z-[100]">
        <img src="https://qaytrfhpqsajgfqedxak.supabase.co/storage/v1/object/public/assets/WhatsApp%20Image%202025-10-08%20at%2009.25.36_1c1533ac.jpg" alt="HXOUSE Logo" class="w-48 h-48 object-contain rounded-full">
    </div>

    <div id="app" class="app-container max-w-lg mx-auto shadow-2xl flex flex-col hidden">
        <main class="flex-grow overflow-y-auto">
            <div id="main-interface" class="hidden">
                <header id="page-header" class="sticky top-0 bg-primary z-20 h-16 px-4 flex justify-between items-center border-b border-custom"></header>
                <div id="page-content"></div>
            </div>
            <div class="h-20 flex-shrink-0"></div>
        </main>
        <nav id="bottom-nav" class="fixed bottom-0 left-1/2 -translate-x-1/2 max-w-lg w-full bg-primary border-t border-custom flex justify-around items-center h-16 z-30 hidden"></nav>
    </div>

    <div id="modal-container"></div>
    <div id="toast" class="hidden fixed right-4 brand-bg py-3 px-5 rounded-lg shadow-xl z-50">
        <p id="toast-message"></p>
    </div>

<script>
const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

function setAppHeight() {
  document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
}
window.addEventListener('resize', setAppHeight);
setAppHeight();

const SUPABASE_URL = 'https://ttdnlatylcqrevzlyrru.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0ZG5sYXR5bGNxcmV2emx5cnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzAyMDEsImV4cCI6MjA3NTc0NjIwMX0.aiQ1_viA1JrugEyMWxA2e5f2Aqrao9BNgCTb70NWyCc';
const supabase = self.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const PAGES = ['home', 'order', 'cart', 'social', 'cowork', 'more'];

const STATIC_DATA = {
    bestSellers: [10, 39, 61, 93],
    captionIdeas: {
        student: [ "Fueling my study session with @hxousecoffeeco ‚òïÔ∏èüìö #StudentLife", "Caffeine and concentration, courtesy of @hxousecoffeeco." ],
        office: [ "My real co-worker: this cup from @hxousecoffeeco üíº #WorkFuel", "Turning coffee into code with @hxousecoffeeco." ],
        couple: [ "Coffee dates with my favorite person ‚ù§Ô∏è @hxousecoffeeco", "Love is in the air, and it smells like coffee from @hxousecoffeeco." ],
        friends: [ "Good times and great coffee with the best crew! @hxousecoffeeco #Friends", "A perfect blend of friendship and coffee at @hxousecoffeeco!" ]
    }
};

const sound = {
    audioContext: null,
    init() {
        if (this.audioContext) return;
        try { this.audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
        catch (e) { console.error("Web Audio API is not supported."); }
    },
    play(type) {
        if (!this.audioContext) return;
        const o = this.audioContext.createOscillator(), g = this.audioContext.createGain();
        o.connect(g); g.connect(this.audioContext.destination); g.gain.setValueAtTime(0, this.audioContext.currentTime);
        const sounds = {
            click: { type: 'sine', freq: 600, gain: 0.2, len: 0.1 },
            add_to_cart: { type: 'triangle', freq: 440, gain: 0.3, len: 0.2 },
            success: { type: 'sine', freq: 523.25, gain: 0.3, len: 0.3, secondFreq: 659.25 },
            win: { type: 'sine', freq: 587.33, gain: 0.4, len: 0.3, secondFreq: 880 },
            draw: { type: 'sawtooth', freq: 220, gain: 0.2, len: 0.2, secondFreq: 180 },
        };
        const s = sounds[type]; if (!s) return;
        o.type = s.type; o.frequency.setValueAtTime(s.freq, this.audioContext.currentTime);
        g.gain.linearRampToValueAtTime(s.gain, this.audioContext.currentTime + 0.01);
        if (s.secondFreq) { o.frequency.setValueAtTime(s.secondFreq, this.audioContext.currentTime + (s.len / 2)); }
        g.gain.linearRampToValueAtTime(0, this.audioContext.currentTime + s.len);
        o.start(this.audioContext.currentTime); o.stop(this.audioContext.currentTime + s.len);
    }
};

const app = {
    state: {
        currentPage: 'home',
        cart: [],
        activeOrder: null,
        tableNumber: null,
        user: null,
        customerProfile: null,
        theme: 'matcha',
        menuData: [], // Grouped menu by category
        allMenuItems: [], // Flat list of all available items
        appSettings: {},
        orderSubscription: null,
        // REMOVED: currentMenuCategory - not needed for accordion view
        // New state for accordion menu
        expandedCategory: null, // Tracks which category accordion is open
        searchQuery: '',
        searchResults: [],
        pointsToRedeem: 0,
    },

    async init() {
        document.body.addEventListener('click', () => sound.init(), { once: true });

        const initialHash = location.hash.substring(1);
        if (PAGES.includes(initialHash)) {
             this.state.currentPage = initialHash;
        } else {
             this.state.currentPage = 'home';
             location.hash = 'home';
        }
        window.addEventListener('popstate', this.handleHardwareBack.bind(this));

        this.startAppFlow();
    },

    async startAppFlow() {
        this.applyTheme();
        $('#splash-screen').classList.remove('hidden');
        this.getTableNumberFromURL();

        try {
            const { data: { session } } = await supabase.auth.getSession();
            this.state.user = session?.user;
            if (!this.state.user) {
                const { data: signInData, error } = await supabase.auth.signInAnonymously();
                if (error) throw new Error(`Anonymous sign-in failed: ${error.message}`);
                this.state.user = signInData.user;
            }

            await this.fetchCustomerProfile();
            await Promise.all([ this.fetchMenuData(), this.fetchAppSettings() ]);

            // Set the first category as expanded by default on load
            if (this.state.menuData.length > 0) {
                this.state.expandedCategory = this.state.menuData[0].category;
            }

            $('#splash-screen').style.display = 'none';
            $('#app').classList.remove('hidden');
            $('#app').classList.add('flex');

            if (!this.state.customerProfile || !this.state.customerProfile.name || !this.state.customerProfile.whatsapp_number) {
                 this.showOnboardingModal();
            } else if (this.state.tableNumber) {
                this.startSession();
            } else {
                this.showTableNumberModal();
            }

        } catch (error) {
            console.error("CRITICAL: Initialization failed.", error);
            $('#splash-screen').innerHTML = `<div class="text-primary text-center p-4">Could not load. Please check connection.</div>`;
        }
    },

    getTableNumberFromURL() {
        const params = new URLSearchParams(window.location.search);
        const scannedTableNum = params.get('table'); // Get what the QR code *says*
        
        if (scannedTableNum && !isNaN(parseInt(scannedTableNum))) {
            // --- START OF FIX ---
            // This map corrects the physically mixed-up QR codes.
            
            const qrCodeFixMap = {
                // "scanned_table_num": "correct_table_num"
                "6": 1,
                "10": 2, // Correct mapping: Scan 10 shows 2
                "1": 3,
                "7": 4,
                "4": 6,
                "3": 7, // Correct mapping: Scan 3 shows 7
                "2": 8
                // Tables 5 and 9 are correct, so they are not in the map.
            };
    
            // Check if the scanned number is in our fix map
            const correctTableNum = qrCodeFixMap[scannedTableNum] || scannedTableNum;
            
            this.state.tableNumber = parseInt(correctTableNum);
            // --- END OF FIX ---
        }
    },

    async fetchCustomerProfile() {
        if (!this.state.user) return;
        try {
            const { data, error } = await supabase.from('customers')
                .select('*, loyalty_points')
                .eq('id', this.state.user.id)
                .single();

            if (error && error.code !== 'PGRST116') throw error;

            if (data) {
                data.loyalty_points = data.loyalty_points || 0;
                this.state.customerProfile = data;
            } else {
                 this.state.customerProfile = { id: this.state.user.id, name: null, loyalty_points: 0, whatsapp_number: null };
            }
        } catch (error) {
            console.error('Error fetching profile:', error);
            ui.showToast('Could not fetch your profile.');
            this.state.customerProfile = { id: this.state.user?.id || 'unknown', name: 'Guest', loyalty_points: 0, whatsapp_number: null };
        }
    },

    async fetchMenuData() {
        try {
            const { data, error } = await supabase.from('products').select('*').order('id');
            if (error) throw error;

            this.state.allMenuItems = data.filter(i => i.is_available);

            // Grouping logic remains the same
            const groupedMenu = data.reduce((acc, item) => {
                if (!item.is_available) return acc;
                let category = acc.find(c => c.category === item.category);
                if (!category) {
                    category = { category: item.category, items: [] };
                    acc.push(category);
                }
                category.items.push(item);
                return acc;
            }, []);

            this.state.menuData = groupedMenu;

        } catch (error) {
            console.error('Error fetching menu data:', error);
            ui.showToast('Could not load the menu.');
            this.state.menuData = [];
            this.state.allMenuItems = [];
        }
    },

    async fetchAppSettings() {
        try {
            const { data, error } = await supabase.from('app_settings').select('key, value');
            if (error) throw error;
            this.state.appSettings = data.reduce((acc, { key, value }) => ({ ...acc, [key]: value }), {});
        } catch (error) { console.error('Error fetching app settings:', error); }
    },

    showOnboardingModal(){
        const tableInputHTML = !this.state.tableNumber
            ? `<input type="number" id="table-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Table Number" required>`
            : '';
        ui.showModal('onboarding-modal', `
            <h2 class="text-2xl font-bold text-primary mb-2">Welcome to H<span class="classy-x">X</span>OUSE</h2><p class="text-secondary mb-6">A few details to get you started.</p>
            <div class="space-y-4">
                <input type="text" id="user-name-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Name" required>
                <input type="tel" id="mobile-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Mobile Number (for Loyalty Points)" required>
                ${tableInputHTML}
            </div>
            <button onclick="app.completeOnboarding()" class="w-full mt-6 brand-bg font-semibold py-3 px-6 rounded-lg">Let's Go</button>
        `);
    },

    async completeOnboarding(){
        const name = $('#user-name-input').value.trim();
        const phone = $('#mobile-number-input').value.trim();
        let tableNumber = this.state.tableNumber;

        if (!tableNumber) {
             const tableInput = $('#table-number-input');
             if (!tableInput || !tableInput.value) return ui.showToast("Please enter your table number.");
             tableNumber = parseInt(tableInput.value);
        }
        if (!name) return ui.showToast("Please enter your name.");
        if (!phone || !/^\d{10}$/.test(phone.replace(/\D/g,''))) return ui.showToast("Please enter a valid 10-digit mobile number for loyalty points.");
        const cleanPhone = phone.replace(/\D/g,'');

        let finalProfileData;
        try {
            // --- START FIX for "duplicate key" error ---

            // 1. Check for profile *by ID* (our current auth user)
            const { data: existingById, error: errorById } = await supabase.from('customers')
                .select('*, loyalty_points')
                .eq('id', this.state.user.id)
                .maybeSingle();
            
            if (errorById && errorById.code !== 'PGRST116') {
                // This is not a "not found" error, so throw it
                console.error("Error fetching profile by ID:", errorById);
                throw errorById;
            }

            // 2. Check for profile *by Phone* (linked to a *different* auth user)
            const { data: existingByPhone, error: errorByPhone } = await supabase.from('customers')
                .select('id, loyalty_points')
                .eq('whatsapp_number', cleanPhone)
                .not('id', 'eq', this.state.user.id) // Exclude our current user from this check
                .maybeSingle();

            if (errorByPhone && errorByPhone.code !== 'PGRST116') {
                 console.error("Error fetching profile by Phone:", errorByPhone);
                 throw errorByPhone;
            }

            if (existingByPhone) {
                // CONFLICT: This phone number is already linked to a *different* profile.
                
                // --- MODIFICATION: Added console.error for clarity ---
                const errorMsg = "Phone number conflict. This phone is already linked to another account.";
                console.error(errorMsg, { phone: cleanPhone, existingId: existingByPhone.id, currentId: this.state.user.id });
                ui.showToast(errorMsg);
                // --- END MODIFICATION ---

                // We must stop here to prevent the error.
                return; 
            }

            // If we are here, it means:
            // 1. The phone number is NOT linked to any *other* user.
            // 2. The current user *either* has a profile (`existingById`) or they don't.

            if (existingById) {
                // Case 1: We found a profile for our current user. Update it.
                // This user might have logged in before but not provided a phone.
                console.log("Updating existing customer profile by ID:", this.state.user.id);
                const { data: updatedData, error: updateError } = await supabase.from('customers')
                    .update({
                        name: name,
                        whatsapp_number: cleanPhone
                        // We don't touch loyalty_points, it's already set
                    })
                    .eq('id', this.state.user.id)
                    .select('*, loyalty_points')
                    .single();
                
                if (updateError) throw updateError;
                finalProfileData = updatedData;

            } else {
                // Case 2: No profile for our user ID, and phone is not taken. Create new profile.
                // This is a brand new user.
                console.log("Inserting new customer profile for ID:", this.state.user.id);
                const { data: insertedData, error: insertError } = await supabase.from('customers')
                    .insert({
                        id: this.state.user.id,
                        name: name,
                        whatsapp_number: cleanPhone,
                        loyalty_points: 0 // New users start at 0
                    })
                    .select('*, loyalty_points')
                    .single();

                if (insertError) {
                    // If we get "duplicate key" (code 23505) here, it *must* be an RLS issue
                    // where our `existingById` check failed to *see* the row.
                    console.error("Insert failed, checking for RLS conflict...", insertError);
                    if (insertError.code === '23505') {
                        // This is the duplicate key error.
                        // We can now assume the record exists but was hidden.
                        // Let's try to UPDATE it as a fallback.
                        console.warn("Insert failed (duplicate key). Attempting to update fallback.");
                        const { data: updatedData, error: updateError } = await supabase.from('customers')
                            .update({
                                name: name,
                                whatsapp_number: cleanPhone
                            })
                            .eq('id', this.state.user.id) // Update the record with our ID
                            .select('*, loyalty_points')
                            .single();
                        
                        if (updateError) {
                            // Both insert and update failed. This is a critical error.
                            console.error("Fallback update also failed:", updateError);
                            throw updateError; 
                        }
                        // Fallback update succeeded
                        finalProfileData = updatedData;
                        ui.showToast('Profile updated.');

                    } else {
                        // It was a different error, throw it
                        throw insertError;
                    }
                } else {
                    // Insert succeeded
                    finalProfileData = insertedData;
                }
            }
            // --- END FIX ---

            this.state.customerProfile = finalProfileData;
            this.state.customerProfile.loyalty_points = this.state.customerProfile.loyalty_points || 0;
            this.state.tableNumber = tableNumber;
            ui.closeModal('onboarding-modal');
            this.startSession();

        } catch (error) {
            console.error("Onboarding/Linking Error:", error);
            if (error.message.includes('duplicate key value violates unique constraint')) {
                // This message is now more generic, as our logic handles the primary key one.
                // This might catch a duplicate phone number if our check failed.
                ui.showToast('This phone number might be linked to another session. Please retry.');
            } else if (error.message.includes('violates row-level security policy for table')) {
                 ui.showToast('Could not save profile due to security policy. Please contact support.');
            } else {
                 ui.showToast(`Could not save profile: ${error.message}`);
            }
        }
    },


    showTableNumberModal() {
        ui.showModal('table-number-modal', `
            <h2 class="text-2xl font-bold text-primary mb-2">Welcome back, ${this.state.customerProfile.name}!</h2>
            <p class="text-secondary mb-6">Please enter your table number for today's visit.</p>
            <input type="number" id="table-number-input" class="w-full p-3 border border-custom rounded-lg bg-secondary text-primary" placeholder="Your Table Number" required>
            <button onclick="app.completeTableNumberEntry()" class="w-full mt-6 brand-bg font-semibold py-3 px-6 rounded-lg">Continue</button>
        `);
    },

    completeTableNumberEntry() {
        const tableNumber = $('#table-number-input').value;
        if (!tableNumber) return ui.showToast("Please enter your table number.");
        this.state.tableNumber = parseInt(tableNumber);
        ui.closeModal('table-number-modal');
        this.startSession();
    },

    async startSession() {
        await this.fetchActiveOrder();
        this.showMainInterface();
    },

    showMainInterface(){
        $('#main-interface').classList.remove('hidden');
        $('#bottom-nav').classList.remove('hidden');
        ui.renderBottomNav();
        this.navigateTo(this.state.currentPage, false);
    },

    navigateTo(page, pushToHistory = true){
         if (!this.state.customerProfile) return;
         sound.play('click');
         if (pushToHistory && location.hash.substring(1) !== page) {
            location.hash = page;
         } else if (!pushToHistory && location.hash.substring(1) !== page) {
            history.replaceState(null, '', '#' + page);
         }
         this.state.currentPage = page;
         ui.renderHeader(page);
         ui.renderPageContent(page);
         ui.updateActiveNav(page);
    },

    handleHardwareBack(event) {
         const currentHash = location.hash.substring(1);
         const openModal = $('#modal-container').children[0];

         if (openModal) {
            ui.closeModal(openModal.id);
            event.preventDefault();
            // Ensure the hash reflects the current page after closing modal
            history.pushState(null, '', '#' + this.state.currentPage);
            return;
         }

         // If the current hash doesn't match the state (e.g., user used browser back/forward)
         if (PAGES.includes(currentHash) && currentHash !== this.state.currentPage) {
            this.navigateTo(currentHash, false); // Sync state to the hash
         }
         // If on a page other than home, navigate back to home
         else if (this.state.currentPage !== 'home') {
             event.preventDefault(); // Prevent default back behavior (like closing app)
             this.navigateTo('home');
         }
         // If already on home, let the default back behavior happen (or do nothing to prevent closing)
         // To prevent closing entirely, you might add: else { event.preventDefault(); }
    },

    applyTheme(){ document.body.dataset.theme = this.state.theme; },
    toggleTheme(t){ this.state.theme = t; localStorage.setItem('hxouse-theme', t); this.applyTheme(); this.navigateTo('more'); },

    addOrUpdateCart(itemId, quantityChange) {
        sound.play('click');
        const item = this.state.allMenuItems.find(i => i.id === itemId);
        if (!item) return;

        let cartItem = this.state.cart.find(i => i.id === itemId);
        let newQuantity = (cartItem ? cartItem.quantity : 0) + quantityChange;

        if (newQuantity <= 0) {
            this.state.cart = this.state.cart.filter(i => i.id !== itemId);
        } else {
            if (cartItem) {
                cartItem.quantity = newQuantity;
            } else {
                this.state.cart.push({ cartId: Date.now(), ...item, quantity: newQuantity });
            }
            if (quantityChange > 0) sound.play('add_to_cart');
        }
        this.state.pointsToRedeem = 0; // Reset points on cart change
        this.refreshPage();
    },

    setCartItemQuantity(itemId, quantity) {
        const item = this.state.allMenuItems.find(i => i.id === itemId);
        if (!item) return;

        if (quantity <= 0) {
            this.state.cart = this.state.cart.filter(i => i.id !== itemId);
        } else {
            let cartItem = this.state.cart.find(i => i.id === itemId);
            if (cartItem) {
                cartItem.quantity = quantity;
            } else {
                this.state.cart.push({ cartId: Date.now(), ...item, quantity: quantity });
            }
        }
        if(quantity > 0) {
            sound.play('add_to_cart');
            ui.showToast('Cart updated!');
        }
        this.state.pointsToRedeem = 0; // Reset points on quantity change
        ui.closeModal('item-detail-modal');
        this.refreshPage();
    },

    performSearch(query) {
         const searchContainer = $('#search-results-container');
         const menuSections = $('#menu-sections');
         this.state.searchQuery = query.toLowerCase();

         if (this.state.searchQuery.length > 1) {
            if (searchContainer) searchContainer.classList.remove('hidden');
            if (menuSections) menuSections.classList.add('hidden');
            this.state.searchResults = this.state.allMenuItems.filter(item =>
                item.name.toLowerCase().includes(this.state.searchQuery) ||
                (item.description && item.description.toLowerCase().includes(this.state.searchQuery))
            );
            ui.renderMenuItems(this.state.searchResults, 'search-results-container');
         } else {
            if (searchContainer) searchContainer.classList.add('hidden');
            if (menuSections) menuSections.classList.remove('hidden');
            this.state.searchResults = [];
            // When search is cleared, we naturally go back to the accordion view
            // No need to explicitly filter, as the accordion view is always rendered
            ui.renderMenuPageContent(); // Re-render the accordion view
         }
    },

    // Modified function to handle category expansion/collapse
    toggleCategory(categoryName) {
        sound.play('click');
        const contentDiv = $(`#items-for-${categoryName.replace(/\s/g, '-')}`);

        if (this.state.expandedCategory === categoryName) {
            // Close
            contentDiv.style.maxHeight = '0';
            contentDiv.classList.remove('open');
            this.state.expandedCategory = null;
        } else {
            // Close previous, open new
            if (this.state.expandedCategory) {
                const prevContent = $(`#items-for-${this.state.expandedCategory.replace(/\s/g, '-')}`);
                if (prevContent) {
                    prevContent.style.maxHeight = '0';
                    prevContent.classList.remove('open');
                }
            }

            // Open new
            contentDiv.classList.add('open');
            // Set max-height dynamically after content is visible
            // We use a slight delay and scroll after the height is set
            setTimeout(() => {
                const innerDiv = contentDiv.querySelector('.p-4');
                // Set max-height to inner content height + padding/margin, or a large number if necessary
                contentDiv.style.maxHeight = innerDiv.scrollHeight + 32 + 'px';
                // Optional: Scroll the main page content to the newly opened section
                contentDiv.closest('main').scrollTo({
                    top: contentDiv.parentElement.offsetTop - $('#page-header').offsetHeight,
                    behavior: 'smooth'
                });
            }, 50); // Small delay to allow element height calculation

            this.state.expandedCategory = categoryName;
        }
        ui.renderMenuPageContent(); // Re-render to update arrow icon (visual consistency)
    },


    calculateCartTotal(){
        const subtotal = this.state.cart.reduce((t, i) => t + (i.price * i.quantity), 0);
        const availablePoints = this.state.customerProfile?.loyalty_points || 0;

        // 1. Calculate max discount
        const redeemablePoints = Math.floor(availablePoints * 0.8);
        const maxRedeemableForOrder = Math.min(redeemablePoints, Math.floor(subtotal));

        // 2. Clamp current discount
        const actualPointsToRedeem = Math.min(this.state.pointsToRedeem, maxRedeemableForOrder);
        const discountAmount = actualPointsToRedeem;

        // 3. Update state if clamped
        if (this.state.pointsToRedeem !== actualPointsToRedeem) {
            console.log("Clamping points to redeem:", actualPointsToRedeem);
            this.state.pointsToRedeem = actualPointsToRedeem;
        }
        
        // 4. Calculate final totals WITH GST
        const discountedSubtotal = subtotal - discountAmount;
        const gst = discountedSubtotal * 0.05; // 5% GST
        const finalTotal = discountedSubtotal + gst;

        return { 
            subtotal, 
            discountAmount, 
            discountedSubtotal, 
            gst, 
            finalTotal: Math.max(0, finalTotal),
            maxRedeemableForOrder // Pass this to the cart renderer
        };
    },

    updatePointsToRedeem(points) {
        this.state.pointsToRedeem = parseInt(points);
        ui.updateCartSummary(); // Re-render cart summary with new discount
    },

    refreshPage(){
        ui.refreshCartDependentUI();
        // Re-render the content of the current page
        if (PAGES.includes(this.state.currentPage)) {
            ui.renderPageContent(this.state.currentPage);
        }
    },

    async placeOrder(paymentMethod, btnElement){
        if (this.state.cart.length === 0 || !this.state.tableNumber) return ui.showToast("Cart empty or table missing.");
        if (!this.state.customerProfile || !this.state.customerProfile.id) {
            console.error("Critical Error: Customer profile ID is missing.", this.state.customerProfile);
            return ui.showToast("Error: Your profile is not loaded correctly. Please refresh.");
        }

        btnElement.disabled = true; const originalBtnHTML = btnElement.innerHTML;
        btnElement.innerHTML = `<span class="flex items-center justify-center"><div class="spinner mr-2"></div> Processing...</span>`;

        // Recalculate just before placing order to ensure points are valid
        const { subtotal, discountAmount, gst, finalTotal, maxRedeemableForOrder } = this.calculateCartTotal();
        const pointsToRedeem = this.state.pointsToRedeem; // This is the discountAmount

        let orderData;

        try {
            const { data: tableData, error: tableError } = await supabase.from('tables').select('id').eq('table_number', this.state.tableNumber).single();
            if (tableError || !tableData) throw new Error(`Table #${this.state.tableNumber} invalid.`);

            // Check points again right before RPC call for safety
            if (pointsToRedeem > 0) {
                const { data: currentProfile, error: profileError } = await supabase.from('customers').select('loyalty_points').eq('id', this.state.customerProfile.id).single();
                if (profileError || !currentProfile || currentProfile.loyalty_points < pointsToRedeem) {
                     throw new Error('Insufficient points. Please refresh cart.');
                }
            }

            // Calculate effective discount percentage for admin panel consistency
            const effectiveDiscountPercent = (subtotal > 0) ? (discountAmount / subtotal) * 100 : 0;

            const orderPayload = {
                customer_id: this.state.customerProfile.id,
                table_id: tableData.id,
                
                // --- MODIFIED FIELDS for Consistency ---
                total_amount: finalTotal, // Admin panel expects final total here
                discount_percentage: effectiveDiscountPercent, // Admin panel uses this
                
                // --- Fields for this app's logic ---
                discount_points_redeemed: pointsToRedeem,
                discount_amount: discountAmount,
                final_amount: finalTotal, // This app uses this (now matches total_amount)

                payment_method: paymentMethod,
                special_instructions: $('#special-instructions')?.value || '',
                feedback_submitted: false
            };
            const { data: insertedOrder, error: orderError } = await supabase.from('orders').insert(orderPayload).select().single();
            if (orderError) {
                console.error("Order Insert Error:", orderError);
                throw new Error(`Order placement failed. (Hint: Check RLS policies for 'orders' table. Customer ID: ${this.state.customerProfile.id})`);
            }
            orderData = insertedOrder;

            const orderItems = this.state.cart.map(i => ({
                order_id: orderData.id,
                product_id: i.id,
                quantity: i.quantity,
                price_at_time_of_order: i.price
            }));
            const { error: itemsError } = await supabase.from('order_items').insert(orderItems);
            if (itemsError) {
                console.error("Order Items Insert Error:", itemsError);
                // Attempt to delete the failed order header
                await supabase.from('orders').delete().eq('id', orderData.id);
                throw new Error(`Order items failed. (Hint: Check RLS policies for 'order_items' table)`);
            }

            // Points transactions *after* successful order and items insert
            try {
                if (pointsToRedeem > 0) {
                     const { error: redeemError } = await supabase.rpc('redeem_loyalty_points', { customer_id_input: this.state.customerProfile.id, points_to_redeem: pointsToRedeem });
                     if (redeemError) throw new Error(`Redeem failed: ${redeemError.message}`);
                     // Update local state *after* successful RPC
                     this.state.customerProfile.loyalty_points -= pointsToRedeem;
                }

                const pointsEarned = Math.floor(subtotal / 500) * 50;
                if (pointsEarned > 0) {
                     const { error: incrementError } = await supabase.rpc('increment_loyalty_points', { customer_id_input: this.state.customerProfile.id, points_to_add: pointsEarned });
                     if (incrementError) console.error("Award points failed:", incrementError);
                     else {
                         // Update local state *after* successful RPC
                         this.state.customerProfile.loyalty_points += pointsEarned;
                     }
                }
            } catch (pointsError) {
                // Log warning but don't fail the entire order process
                console.warn("Points transaction failed after order success:", pointsError.message);
                ui.showToast("Order placed, but points update failed.");
                // Fetch latest profile to ensure UI consistency eventually
                await this.fetchCustomerProfile();
            }

            // Success flow
            ui.closeModal('payment-modal');
            this.state.activeOrder = orderData; // Set active order locally
            this.listenToOrderUpdates(orderData.id); // Start listening
            this.state.cart = [];
            this.state.pointsToRedeem = 0;
            this.refreshPage(); // Refresh UI (will show tracking page now)
            sound.play('success');
            this.navigateTo('cart'); // Navigate to cart/tracking

        } catch (error) {
            console.error("Place Order Failed:", error);
            ui.showToast(`Order failed: ${error.message}`);
            // If the error was points-related, refresh points display
            if (error.message.includes('points') || error.message.includes('profile')) {
                await this.fetchCustomerProfile(); // Get latest points count
                this.state.pointsToRedeem = 0; // Reset slider
                this.refreshPage(); // Update cart UI
            }
            // Reset button state
            btnElement.disabled = false;
            btnElement.innerHTML = originalBtnHTML;
            const otherBtn = [...$$('.payment-btn')].find(b => b !== btnElement);
            if(otherBtn) otherBtn.disabled = false;
        }
    },


    async fetchActiveOrder(){
        if (!this.state.user || !this.state.customerProfile?.id) return;
        const { data, error } = await supabase.from('orders')
            .select(`*, order_items(*, products(name)), feedback_submitted`)
            .eq('customer_id', this.state.customerProfile.id)
            .in('status', ['received', 'preparing'])
            .order('created_at', { ascending: false })
            .limit(1).single();

        if (error && error.code !== 'PGRST116') console.error('Fetch active order error:', error);
        this.state.activeOrder = data || null;
        if (this.state.activeOrder) {
            this.listenToOrderUpdates(this.state.activeOrder.id);
        }
    },

    listenToOrderUpdates(orderId){
        if (this.state.orderSubscription) {
            supabase.removeChannel(this.state.orderSubscription);
            this.state.orderSubscription = null;
        }
        console.log(`Listening order: ${orderId}`);
        this.state.orderSubscription = supabase.channel(`public:orders:id=eq.${orderId}`)
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `id=eq.${orderId}` }, payload => {
                if (!this.state.activeOrder || this.state.activeOrder.id !== payload.new.id) return;

                const updatedOrder = payload.new;
                let uiNeedsRefresh = false;

                if (updatedOrder.status !== this.state.activeOrder.status) {
                    ui.showToast(`Your order is now: ${updatedOrder.status}`);
                    this.state.activeOrder.status = updatedOrder.status;
                    uiNeedsRefresh = true;
                }
                if ('feedback_submitted' in updatedOrder && updatedOrder.feedback_submitted !== this.state.activeOrder.feedback_submitted) {
                    this.state.activeOrder.feedback_submitted = updatedOrder.feedback_submitted;
                    uiNeedsRefresh = true;
                }

                if (['delivered', 'cancelled'].includes(updatedOrder.status)) {
                    supabase.removeChannel(this.state.orderSubscription);
                    this.state.orderSubscription = null;
                    console.log("Order finished, unsubscribed.");

                    // Show feedback modal ONLY if delivered AND feedback not submitted
                    if (updatedOrder.status === 'delivered' && !updatedOrder.feedback_submitted) {
                         ui.showModal('review-modal', `
                            <div class="text-center">
                                <span class="text-3xl">‚≠ê</span>
                                <h2 class="text-2xl font-bold mt-4">Order Delivered!</h2>
                                <p class="text-secondary my-2">How was your experience? <br/>(+10 Loyalty Points for feedback!)</p>
                                <textarea id="feedback-text" class="w-full p-3 border border-custom rounded-lg bg-secondary" rows="3" placeholder="Tell us more..."></textarea>
                                <button onclick="app.submitFeedback('${orderId}')" class="w-full mt-4 brand-bg font-semibold py-3 rounded-lg">Submit Feedback</button>
                                <button onclick="ui.closeModal('review-modal')" class="w-full mt-2 bg-secondary py-3 rounded-lg">Maybe Later</button>
                            </div>`);
                    } else if (updatedOrder.status === 'cancelled') {
                        ui.showToast('Your order has been cancelled.');
                    }
                    this.state.activeOrder = null; // Clear active order
                    uiNeedsRefresh = true;
                }
                // Refresh UI only if relevant changes occurred
                if(uiNeedsRefresh && this.state.currentPage === 'cart') {
                     this.refreshPage();
                } else if (uiNeedsRefresh && this.state.currentPage === 'home') {
                    this.refreshPage(); // Refresh home to remove active order banner if needed
                }
            }).subscribe((status, err) => {
                if (status === 'SUBSCRIBED') {
                    console.log(`Subscribed to order ${orderId}`);
                } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                    console.error(`Subscription failed:`, status, err);
                    // Optionally attempt to resubscribe or notify user
                }
            });
    },


    async submitFeedback(orderId){
        if (!this.state.customerProfile || !this.state.customerProfile.id) return ui.showToast("Error: Profile not loaded.");
        const content = $('#feedback-text').value.trim();
        if (!content) return ui.showToast("Please enter your feedback.");

        const submitBtn = $('#review-modal button:first-of-type');
        if (submitBtn) submitBtn.disabled = true;

        try {
            // Verify feedback status again right before submitting
            const { data: orderData, error: fetchError } = await supabase.from('orders').select('feedback_submitted').eq('id', orderId).single();
            if (fetchError || !orderData) throw new Error("Could not verify order status.");
            if (orderData.feedback_submitted) {
                ui.showToast("Feedback already submitted for this order.");
                ui.closeModal('review-modal');
                return; // Exit if already submitted
            }

            // 1. Insert feedback
            const { error: insertError } = await supabase.from('feedback').insert({
                order_id: orderId,
                customer_id: this.state.customerProfile.id,
                content: content,
                rating: 5 // Defaulting rating to 5 as there's no UI for it
            });
            if (insertError) throw insertError;

            // 2. Mark order as feedback submitted (best effort)
             const { error: updateError } = await supabase.from('orders')
                 .update({ feedback_submitted: true })
                 .eq('id', orderId);
             if (updateError) console.warn("Could not mark order as feedback submitted:", updateError);

            // 3. Award loyalty points
            const { error: incrementError } = await supabase.rpc('increment_loyalty_points', { customer_id_input: this.state.customerProfile.id, points_to_add: 10 });
            if (incrementError) {
                console.error("Feedback points award failed:", incrementError);
                ui.showToast("Feedback submitted, but points award failed.");
            }
            else {
                 // Update local state *after* successful RPC
                 this.state.customerProfile.loyalty_points += 10;
                 ui.showToast("Thank you for your feedback! +10 Points added.");
            }

            // Close modal and refresh relevant UI parts
            ui.closeModal('review-modal');
            this.refreshPage(); // This will re-render the current page, updating points display if on 'More' page

        } catch (error) {
             console.error("Feedback submission error:", error);
             ui.showToast(`Feedback failed: ${error.message}`);
             if (submitBtn) submitBtn.disabled = false; // Re-enable button on error
        }
    },

    async sendStaffCall(callType = 'assistance') {
        if (!this.state.tableNumber) return ui.showToast('Table number not set.');
        if (!this.state.customerProfile || !this.state.customerProfile.id) return ui.showToast("Error: Profile not loaded.");
        const { data: tableData } = await supabase.from('tables').select('id').eq('table_number', this.state.tableNumber).single();
        if (!tableData) return ui.showToast('Invalid table number.');

        const { error } = await supabase.from('staff_calls').insert({
            table_id: tableData.id,
            customer_id: this.state.customerProfile.id,
            call_type: callType
        });

        if (error) {
            ui.showToast(`Error calling staff: ${error.message}`);
        } else {
            ui.showToast(`Staff have been notified! They'll be right over.`, 5000);
        }
    },

    copyCaption(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.top = "0";
        textArea.style.left = "0";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) ui.showToast('Copied!');
            else ui.showToast('Copy failed.');
        } catch (err) {
            console.error('Fallback copy failed', err);
            ui.showToast('Copy failed.');
        }
        document.body.removeChild(textArea);
    }
};

const ui = {
    showModal(id, content) {
        location.hash = id; // Add modal ID to hash
        const existingModal = $(`#${id}`);
        if (existingModal) existingModal.remove();

        const modalHTML = `
            <div id="${id}" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-end justify-center z-50 p-4">
                <div class="modal-content bg-primary rounded-t-2xl shadow-xl p-6 w-full max-w-lg">
                    ${content}
                </div>
            </div>`;
        $('#modal-container').insertAdjacentHTML('beforeend', modalHTML);
    },

    closeModal(id) {
        const modal = $(`#${id}`);
        if (modal) modal.remove();
        // If the current hash is the modal we are closing, go back
        if (location.hash.substring(1) === id) {
            // Check history length to avoid issues on initial load
            if (history.length > 1 && window.performance.navigation.type !== window.performance.navigation.TYPE_RELOAD) {
                history.back();
            } else {
                 // If no history, replace the hash to avoid broken back button
                 history.replaceState(null, '', location.pathname + location.search + '#' + app.state.currentPage);
            }
        }
    },

    showToast(message, duration = 3000) {
        const toast = $('#toast'), p = $('#toast-message');
        p.textContent = message;
        toast.classList.remove('hidden');
        toast.style.animation = `toast-in 0.5s ease, toast-out 0.5s ease ${duration / 1000 - 0.5}s forwards`;
        setTimeout(() => {
            toast.classList.add('hidden');
            toast.style.animation = '';
        }, duration);
    },

    renderHeader(page) {
        const header = $('#page-header');
        const pageConfigs = {
            home: { title: 'H<span class="classy-x">X</span>OUSE'},
            order: { title: 'Menu'},
            cart: { title: app.state.activeOrder ? 'Track Order' : 'My Cart'},
            social: { title: 'Social'},
            cowork: { title: 'Cowork'},
            more: { title: 'More Options'}
        };
        const config = pageConfigs[page] || { title: 'H<span class="classy-x">X</span>OUSE' };
        header.innerHTML = `
            <div class="flex items-center space-x-2">
                <h1 class="text-2xl font-bold brand-text">${config.title}</h1>
            </div>
            <div class="text-right">
                <p class="font-semibold text-primary text-sm">${app.state.customerProfile?.name || 'Guest'}</p>
                <p class="text-xs text-secondary">Table #${app.state.tableNumber || 'N/A'}</p>
            </div>`;
    },

    renderPageContent(page) {
        const content = $('#page-content');
        content.innerHTML = ''; // Clear previous content
        const renderers = {
            home: this.renderHomePage,
            order: this.renderMenuPage,
            cart: this.renderCartPage,
            social: this.renderSocialPage,
            cowork: this.renderCoworkPage,
            more: this.renderMorePage,
        };
        content.classList.remove('fade-in');
        void content.offsetWidth; // Trigger reflow
        content.classList.add('fade-in');
        // Call the appropriate render function if it exists
        renderers[page]?.call(this);
    },

    renderBottomNav(){
        const icons = {
            home: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`,
            order: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`,
            cart: `<div class="relative"><svg id="cart-icon-svg" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg><span id="cart-count" class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span></div>`,
            social: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>`,
            cowork: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>`,
            more: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" /></svg>`
        };

        const labels = { home: 'Home', order: 'Menu', cart: 'Cart', social: 'Social', cowork: 'Cowork', more: 'More' };
        $('#bottom-nav').innerHTML = PAGES.map(p => `<button onclick="app.navigateTo('${p}')" class="nav-item flex-1 p-2 text-secondary" data-page="${p}">${icons[p]}<span id="${p}-tab-label" class="text-xs font-bold capitalize">${labels[p]}</span></button>`).join('');
    },

    updateActiveNav(page) {
        const cartLabel = $('#cart-tab-label'), cartIcon = $('#cart-icon-svg');
        if (app.state.activeOrder) {
            cartLabel.textContent = 'Track';
            cartIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />`;
        } else {
            cartLabel.textContent = 'Cart';
            cartIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />`;
        }
        $$('.nav-item').forEach(item => {
            const isActive = item.dataset.page === page;
            item.classList.toggle('brand-text', isActive);
            item.classList.toggle('text-secondary', !isActive);
            item.style.transform = isActive ? 'scale(1.1)' : 'scale(1)';
        });
        this.refreshCartDependentUI();
    },

    refreshCartDependentUI() {
        const el = $('#cart-count');
        const total = app.state.cart.reduce((s, i) => s + i.quantity, 0);
        if (total > 0 && !app.state.activeOrder) {
            el.textContent = total;
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
        }
    },

    renderHomePage(){
        const settings = app.state.appSettings;
        const activeOrderHTML = app.state.activeOrder ? `<div class="bg-blue-500/10 border-2 border-blue-500/20 rounded-xl p-4 text-center"> <h2 class="font-bold text-primary">Your order is ${app.state.activeOrder.status}!</h2> <p class="text-secondary text-sm">Order ID: #${app.state.activeOrder.id.slice(0,6)}</p> <button onclick="app.navigateTo('cart')" class="mt-2 text-sm font-semibold text-blue-600 hover:underline">View Details &rarr;</button> </div>` : '';
        const loyaltyBannerHTML = `
            <div class="bg-yellow-100 border border-yellow-200 text-yellow-800 p-4 rounded-xl text-center shadow-sm">
                <h2 class="font-bold text-lg">‚ú® Earn 10% Back! ‚ú®</h2>
                <p class="mt-1">Get <strong class="font-semibold">50 Loyalty Points</strong> (worth ‚Çπ50) for every ‚Çπ500 spent.</p>
                <p class="text-xs mt-1">Redeem points in your cart! Also check out our Cowork space.</p>
            </div>`;

        const promoTitle = 'Order for ‚Çπ799+ & post a story to get a <span class="instagram-card">Free Hamper!</span>';
        const promoSubtitle = 'Show bill & story at counter.';
        const bestSellerItems = STATIC_DATA.bestSellers.map(id => app.state.allMenuItems.find(item => item.id === id)).filter(Boolean);
        const bestSellersHTML = bestSellerItems.map(item => `
            <div onclick="ui.showItemDetailModal(${item.id})" class="cursor-pointer flex-shrink-0 w-40 bg-secondary rounded-xl p-3 flex flex-col items-center text-center">
                <div class="text-3xl mb-2">${item.image_url || '‚òïÔ∏è'}</div>
                <h3 class="font-bold text-primary text-sm flex-grow">${item.name}</h3>
                <p class="font-semibold text-secondary text-sm mt-1">‚Çπ${item.price}</p>
            </div>`).join('');

        $('#page-content').innerHTML = `
            <div class="space-y-6">
                <div class="relative h-48 overflow-hidden rounded-b-2xl">
                    <video src="https://ttdnlatylcqrevzlyrru.supabase.co/storage/v1/object/public/assets/lv_0_20251012011509.mp4" autoplay loop muted playsinline preload="metadata" class="absolute top-1/2 left-1/2 w-full h-full object-cover -translate-x-1/2 -translate-y-1/2"></video>
                    <div class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center text-white text-center p-4">
                        <h1 class="text-3xl font-bold">${settings.welcome_title || 'H<span class="classy-x">X</span>OUSE'}</h1>
                        <p class="text-lg mt-1 font-light">${settings.welcome_subtitle || 'COFFEE CO.'}</p>
                    </div>
                </div>
                <div class="p-4 space-y-8">
                    ${loyaltyBannerHTML}
                    ${activeOrderHTML ? `<div class="mt-8">${activeOrderHTML}</div>` : ''}
                    <div class="mt-8">
                        <h2 class="text-2xl font-bold text-primary mb-4 px-1">Our Best Sellers</h2>
                        <div class="flex space-x-4 overflow-x-auto pb-2">${bestSellersHTML}</div>
                    </div>
                    <button onclick="app.navigateTo('order')" class="w-full brand-bg font-semibold py-4 px-6 rounded-lg text-lg"> View Full Menu </button>
                    <div onclick="app.navigateTo('social')" class="cursor-pointer group relative bg-secondary rounded-xl p-6 overflow-hidden shadow-sm text-left">
                        <h2 class="text-2xl font-bold text-primary">${promoTitle}</h2>
                        <p class="mt-1 text-secondary">${promoSubtitle}</p>
                        <button class="font-semibold mt-3 text-sm brand-bg px-4 py-2 rounded-lg group-hover:opacity-90 transition">Learn More &rarr;</button>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <button onclick="app.sendStaffCall()" class="bg-secondary rounded-xl p-4 text-center flex flex-col items-center justify-center h-28"><span class="text-3xl">üõé</span><p class="font-semibold mt-2 text-primary">Call Staff</p></button>
                    </div>
                </div>
            </div>`;
    },

    renderMenuPage(){
        const content = $('#page-content');
        if (app.state.menuData.length === 0 && app.state.allMenuItems.length === 0) {
            content.innerHTML = `<div class="p-4 text-center text-secondary">Loading menu...</div>`;
            return;
        }

        content.innerHTML = `
            <div id="active-order-banner" class="p-4 hidden"></div>
            <div class="p-4">
                <input type="text" id="menu-search-input" placeholder="Search menu..." class="w-full p-3 border-2 border-custom rounded-lg bg-secondary text-primary text-lg" oninput="app.performSearch(this.value)" value="${app.state.searchQuery}">
            </div>
            
            <div id="menu-sections" class="p-4 space-y-3">
                ${this.renderMenuPageContent()}
            </div>

            <div id="search-results-container" class="p-4 grid grid-cols-1 gap-4 hidden"></div>`;

        if (app.state.activeOrder) {
            $('#active-order-banner').classList.remove('hidden');
            $('#active-order-banner').innerHTML = `
                <div class="bg-blue-500/10 border-2 border-blue-500/20 rounded-xl p-4 text-center">
                    <h2 class="font-bold text-primary">Your order is ${app.state.activeOrder.status}!</h2>
                    <p class="text-secondary text-sm">Order ID: #${app.state.activeOrder.id.slice(0,6)}</p>
                    <button onclick="app.navigateTo('cart')" class="mt-2 text-sm font-semibold text-blue-600 hover:underline">View Details &rarr;</button>
                </div>`;
        }
        
        // If there's an active search query, display search results
        if (app.state.searchQuery.length > 1) {
            app.performSearch(app.state.searchQuery);
        } else {
             // After initial render, call this to set the correct max-height for the initial open category
             const initialCategory = app.state.expandedCategory;
             if (initialCategory) {
                 const contentDiv = $(`#items-for-${initialCategory.replace(/\s/g, '-')}`);
                 if (contentDiv) {
                    contentDiv.classList.add('open');
                    const innerDiv = contentDiv.querySelector('.p-4');
                    // Ensure the inner div is measured after rendering
                    contentDiv.style.maxHeight = innerDiv.scrollHeight + 32 + 'px'; // +32 for padding/margin buffer
                 }
             }
        }
    },

    // NEW FUNCTION: Renders the vertical accordion menu
    renderMenuPageContent() {
        const menuSections = $('#menu-sections');
        const contentHTML = app.state.menuData.map(group => this.renderCategorySection(group)).join('');
        if (!menuSections) return contentHTML;
        
        menuSections.innerHTML = contentHTML;
    },
    
    // NEW FUNCTION: Renders a single expandable category section
    renderCategorySection(group) {
        const isExpanded = app.state.expandedCategory === group.category;
        
        // Initial max-height calculation for rendering purposes, actual transition logic is in app.toggleCategory
        const initialMaxHeight = isExpanded ? '500px' : '0'; // Use a large buffer initially if expanded
        const openClass = isExpanded ? 'open' : '';
        const rotateClass = isExpanded ? 'rotate-90' : 'rotate-0';
        
        return `
            <div class="bg-secondary rounded-xl shadow-sm overflow-hidden border border-custom">
                <!-- Category Header (Clickable) -->
                <button onclick="app.toggleCategory('${group.category}')" class="w-full flex items-center justify-between p-4 focus:outline-none">
                    <h2 class="text-xl font-bold text-primary">${group.category}</h2>
                    <svg xmlns="http://www.w3.org/2000/svg" class="accordion-arrow h-6 w-6 text-brand-primary ${rotateClass}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
                
                <!-- Items Content (Collapsible) -->
                <div id="items-for-${group.category.replace(/\s/g, '-')}" class="accordion-content ${openClass}" style="max-height: ${initialMaxHeight};">
                    <div class="p-4 pt-0 space-y-3">
                        ${group.items.length > 0 ? group.items.map(item => this.renderMenuItemCard(item)).join('') : '<p class="text-secondary text-center py-4">No items available in this category.</p>'}
                    </div>
                </div>
            </div>
        `;
    },
    
    // RENAMED/MODIFIED FUNCTION: Renders a single menu item card (for use in both accordion and search results)
    renderMenuItemCard(item) {
        const cartItem = app.state.cart.find(ci => ci.id === item.id);
        const actionButtonHTML = cartItem
            ? `<div class="quantity-control" onclick="event.stopPropagation();">
                   <button onclick="app.addOrUpdateCart(${item.id}, -1)">-</button>
                   <span>${cartItem.quantity}</span>
                   <button onclick="app.addOrUpdateCart(${item.id}, 1)">+</button>
               </div>`
            : `<button class="add-to-cart-btn" onclick="event.stopPropagation(); app.addOrUpdateCart(${item.id}, 1)">
                   <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
               </button>`; // Added plus icon for aesthetics

        return `
            <div class="bg-primary rounded-lg shadow-md overflow-hidden cursor-pointer border border-custom" onclick="ui.showItemDetailModal(${item.id})">
                <div class="p-3 flex items-center justify-between">
                    <div class="flex-1 pr-4">
                        <h3 class="font-semibold text-base truncate text-primary">${item.name}</h3>
                        <p class="font-bold text-sm text-secondary mt-1">‚Çπ${item.price}</p>
                    </div>
                    <div class="flex-shrink-0">
                        ${actionButtonHTML}
                    </div>
                </div>
            </div>`;
    },

    // ORIGINAL FUNCTION: Renders search results
    renderMenuItems(items, containerId) {
        const container = $(`#${containerId}`);
        if (!container) return;
        if (!items || items.length === 0) {
            container.innerHTML = `<p class="text-secondary text-center col-span-full mt-8">No items found.</p>`;
            return;
        }
        // Use the new single card renderer
        container.innerHTML = items.map(item => this.renderMenuItemCard(item)).join('');
    },

    renderCartPage() {
        const content = $('#page-content');
        if (app.state.activeOrder) this.renderOrderTracking(content);
        else if (app.state.cart.length > 0) this.renderCart(content);
        else content.innerHTML = `
            <div class="text-center p-10">
                <h2 class="text-2xl font-bold text-primary">Your cart is empty</h2>
                <p class="text-secondary mt-2">Add items from the menu to get started.</p>
                <button onclick="app.navigateTo('order')" class="mt-6 brand-bg font-semibold py-3 px-6 rounded-lg">View Menu</button>
            </div>`;
    },

    renderCart(container){
        // MODIFICATION: Use new calculateTotals function
        const { subtotal, discountAmount, gst, finalTotal, maxRedeemableForOrder } = app.calculateCartTotal();
        const loyaltyPoints = app.state.customerProfile?.loyalty_points || 0;
        
        // Clamp pointsToRedeem on initial render as well
        app.state.pointsToRedeem = Math.min(app.state.pointsToRedeem, maxRedeemableForOrder);
        const currentDiscount = app.state.pointsToRedeem; // This is the discountAmount

        let hamperMessage = '';
        if (subtotal > 0 && subtotal < 799) {
            const amountNeeded = 799 - subtotal;
            hamperMessage = `<div class="p-4"><div class="bg-yellow-100 border border-yellow-200 text-yellow-800 p-3 rounded-lg text-center font-bold">üõí Order for ‚Çπ${amountNeeded.toFixed(2)} more to get a free hamper!</div></div>`;
        } else if (subtotal >= 799) {
            hamperMessage = `<div class="p-4"><div class="bg-green-100 border border-green-200 text-green-800 p-3 rounded-lg text-center font-bold">üéâ You're eligible for a free hamper! Don't forget to post a story.</div></div>`;
        }

        const loyaltyExplanation = `<p class="text-xs text-secondary mt-1 mb-3">Earn 50 points (worth ‚Çπ50) for every ‚Çπ500 spent on subtotal. Redeemable points = 80% of balance.</p>`;

        let loyaltySectionHTML = '';
        if (loyaltyPoints > 0 && maxRedeemableForOrder > 0) {
            loyaltySectionHTML = `
                <div class="p-4 border-t border-b border-custom">
                    <h3 class="font-bold text-lg mb-2 text-primary">Redeem Loyalty Points</h3>
                    <p class="text-sm text-secondary mb-1">Available: ${loyaltyPoints} points</p>
                    ${loyaltyExplanation}
                    <p class="text-sm text-secondary mb-3">Redeemable (max ‚Çπ${maxRedeemableForOrder}):</p>
                    <input type="range" id="loyalty-slider" min="0" max="${maxRedeemableForOrder}" value="${app.state.pointsToRedeem}"
                           oninput="app.updatePointsToRedeem(this.value)" class="w-full h-2 rounded-lg cursor-pointer">
                    <div class="flex justify-between text-sm font-semibold mt-2">
                        <span>Redeem: <span id="points-to-redeem-display">${app.state.pointsToRedeem}</span> pts</span>
                        <span>Discount: - ‚Çπ<span id="discount-amount-display">${currentDiscount.toFixed(2)}</span></span>
                    </div>
                </div>`;
        } else if (loyaltyPoints > 0) {
             loyaltySectionHTML = `<div class="p-4 border-t border-b border-custom"><p class="text-sm text-secondary text-center">You have ${loyaltyPoints} points. ${loyaltyExplanation} Earn more/increase order total to redeem.</p></div>`;
        } else {
             loyaltySectionHTML = `<div class="p-4 border-t border-b border-custom"><p class="text-sm text-secondary text-center">${loyaltyExplanation}</p></div>`;
        }


        container.innerHTML = `
            <div class="p-4 space-y-3">
                ${app.state.cart.map(i => `
                    <div class="bg-secondary p-3 rounded-xl flex items-center justify-between">
                        <div>
                            <p class="font-bold text-primary">${i.name}</p>
                            <p class="font-semibold text-secondary text-sm">‚Çπ${(i.price * i.quantity).toFixed(2)}</p>
                        </div>
                        <div class="quantity-control" style="background-color: var(--bg-primary); color: var(--brand-primary); border: 1px solid var(--border-color);">
                            <button onclick="app.addOrUpdateCart(${i.id}, -1)">-</button>
                            <span>${i.quantity}</span>
                            <button onclick="app.addOrUpdateCart(${i.id}, 1)">+</button>
                        </div>
                    </div>
                `).join('')}
            </div>
            ${hamperMessage}
            ${loyaltySectionHTML}
            <div class="p-4"><textarea id="special-instructions" class="w-full p-3 border-custom rounded-lg bg-secondary" placeholder="Add special instructions..."></textarea></div>
            <div class="p-4 bg-primary border-t-custom sticky bottom-16">
                 <div id="cart-summary" class="mb-4 space-y-1 text-primary"></div>
                <button id="place-order-btn" onclick="ui.showPaymentModal()" class="w-full brand-bg font-bold py-4 rounded-lg">Proceed to Payment</button>
            </div>`;
        this.updateCartSummary(); // Initial render of summary
    },

    updateCartSummary() {
        // Recalculate here as well to ensure consistency
        const { subtotal, discountAmount, gst, finalTotal } = app.calculateCartTotal();
        const currentDiscount = discountAmount; // Use the value from the function

        const pointsDisplay = $('#points-to-redeem-display');
        const discountDisplay = $('#discount-amount-display');
        if(pointsDisplay) pointsDisplay.textContent = currentDiscount.toFixed(0); // Points are integers
        if(discountDisplay) discountDisplay.textContent = currentDiscount.toFixed(2);

        const summaryDiv = $('#cart-summary');
        if (summaryDiv) {
            summaryDiv.innerHTML = `
                <div class="flex justify-between items-center text-md">
                    <span>Subtotal</span>
                    <span>‚Çπ${subtotal.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center text-md text-green-600 ${currentDiscount > 0 ? '' : 'hidden'}">
                    <span>Loyalty Discount</span>
                    <span>- ‚Çπ${currentDiscount.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center text-md ${gst > 0 ? '' : 'hidden'}">
                    <span>GST (5%)</span>
                    <span>‚Çπ${gst.toFixed(2)}</span>
                </div>
                <div class="flex justify-between items-center text-xl font-bold pt-1 border-t border-custom">
                    <span>To Pay</span>
                    <span>‚Çπ${finalTotal.toFixed(2)}</span>
                </div>`;
        }
    },


    renderOrderTracking(container) {
        const order = app.state.activeOrder;
        if (!order) { container.innerHTML = ''; return; }
        const statuses = ['received', 'preparing', 'delivered'];
        const icons = { received: 'üìù', preparing: 'üç≥', delivered: 'üòä' };
        const currentIndex = statuses.indexOf(order.status);
        const progressPercentage = currentIndex > 0 ? (currentIndex / (statuses.length - 1)) * 100 : 0;
        container.innerHTML = `
            <div class="p-6 flex flex-col items-center justify-center h-full">
                <h2 class="text-3xl font-bold text-center capitalize">Your Order is ${order.status}</h2>
                <p class="text-secondary text-center mb-10">Order ID: #${order.id.slice(0,6)}</p>
                <div class="tracker-container my-12 w-full max-w-sm">
                    <div class="tracker-line-container">
                        <div class="tracker-progress" style="width: ${progressPercentage}%"></div>
                    </div>
                    ${statuses.map((status, index) => `
                        <div class="tracker-step ${index <= currentIndex ? 'active' : ''}">
                            <div class="tracker-icon-container">${icons[status]}</div>
                            <span class="tracker-label capitalize">${status}</span>
                        </div>`).join('')}
                </div>
                <div class="mt-auto pt-10 text-center">
                    <p class="text-secondary mb-4">While you wait, why not play a game?</p>
                    <button onclick="ui.showGamesModal()" class="brand-bg font-semibold py-3 px-8 rounded-lg">Play Games</button>
                </div>
            </div>`;
    },

    renderSocialPage(){
        const promoTitle = 'Order for ‚Çπ799+ & post a story to get a <span class="instagram-card">Free Hamper!</span>';
        const promoSubtitle = 'Show your bill & story at the counter to claim your gift from H<span class="classy-x">X</span>OUSE.';
        $('#page-content').innerHTML = `
            <div class="p-4 space-y-6 text-center">
                 <div class="bg-secondary p-6 rounded-xl shadow-sm">
                    <h2 class="text-2xl font-bold text-primary">Join Our Community!</h2>
                    <p class="text-secondary mt-1">Follow us on Instagram for updates, offers, and good vibes.</p>
                    <a href="https://instagram.com/hxousecoffeeco" target="_blank" class="instagram-card text-2xl font-bold my-4 block">@hxousecoffeeco</a>
                    <div class="flex justify-center">
                         <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://instagram.com/hxousecoffeeco" alt="Instagram QR Code" class="rounded-lg bg-white p-2">
                    </div>
                    <p class="text-xs text-secondary mt-2">Scan to follow!</p>
                </div>

                <div onclick="ui.showInstagramPromo()" class="cursor-pointer group relative bg-secondary rounded-xl p-6 overflow-hidden shadow-sm text-left">
                     <h2 class="text-2xl font-bold text-primary">${promoTitle}</h2>
                    <p class="mt-1 text-secondary">${promoSubtitle}</p>
                    <button class="font-semibold mt-3 text-sm brand-bg px-4 py-2 rounded-lg group-hover:opacity-90 transition">Get Caption Ideas &rarr;</button>
                </div>
            </div>
        `;
    },

    renderCoworkPage() {
        $('#page-content').innerHTML = `
            <div class="p-6 space-y-6 text-center">
                 <div class="bg-secondary p-8 rounded-xl shadow-lg border border-custom">
                    <span class="text-5xl mb-4 block">üè¢</span>
                    <h2 class="text-3xl font-bold text-primary mb-2">Work & Caffeinate!</h2>
                    <p class="text-lg text-secondary mb-6">Did you know HXOUSE offers a dedicated coworking space?</p>
                    <ul class="text-left space-y-2 mb-8 list-disc list-inside text-secondary">
                        <li>High-speed Wi-Fi included</li>
                        <li>Comfortable seating & power outlets</li>
                        <li>Quiet, productive environment</li>
                        <li>Perfect for students, freelancers & teams</li>
                        <li>Exclusive cafe discounts for members</li>
                    </ul>
                    <p class="text-primary font-semibold mb-4">Interested? Ask our staff!</p>
                    <button onclick="app.sendStaffCall('cowork_inquiry')" class="w-full mb-4 brand-bg font-semibold py-3 px-6 rounded-lg transition hover:opacity-90">
                        üõé Call Staff for Tour & Details
                    </button>

                    <a href="https://instagram.com/hxousecoffeeco" target="_blank" class="inline-block bg-secondary text-primary font-semibold py-3 px-6 rounded-lg transition hover:bg-primary hover:text-secondary">
                        Follow <span class="instagram-card" style="background: none; -webkit-text-fill-color: inherit; font-weight: bold;">@hxousecoffeeco</span>
                    </a>
                </div>
            </div>
        `;
    },

    renderMorePage(){
        const loyaltyPoints = app.state.customerProfile?.loyalty_points ?? 0;
        const loyaltyExplanation = `<p class="text-xs text-secondary mt-1">Earn 50 pts (‚Çπ50) per ‚Çπ500 spent. 1 pt = ‚Çπ1 discount (redeem in Cart).</p>`;
        const options = [
            { icon: "ü™ô", text: `Loyalty Points: ${loyaltyPoints}`, action: "", explanation: loyaltyExplanation },
            { icon: "üõé", text: "Call Staff (General Assistance)", action: "app.sendStaffCall('assistance')" },
            { icon: "üé®", text: "Change Theme", action: "ui.showThemeModal()" },
            { icon: "üéÆ", text: "Play Games", action: "ui.showGamesModal()" },
            { icon: "üì∂", text: "View Wi-Fi Details", action: "ui.showWifiModal()" },
            { icon: "üìú", text: "Order History", action: "ui.showOrderHistoryModal()" },
        ];
        $('#page-content').innerHTML = `
            <div class="p-4 space-y-3">
                ${options.map(opt =>
                    opt.action
                    ? `<button onclick="${opt.action}" class="w-full flex items-center justify-between bg-secondary p-4 rounded-xl text-left">
                           <div class="flex items-center"><span class="text-2xl mr-4">${opt.icon}</span><span class="font-semibold text-primary">${opt.text}</span></div>
                           <span class="text-secondary">&rarr;</span>
                       </button>`
                    : `<div class="w-full bg-secondary p-4 rounded-xl text-left">
                           <div class="flex items-center"><span class="text-2xl mr-4">${opt.icon}</span><span class="font-semibold text-primary">${opt.text}</span></div>
                           ${opt.explanation || ''}
                       </div>`
                ).join("")}
            </div>`;
    },

    showPaymentModal(){
         ui.showModal('payment-modal', `
            <h2 class="text-xl font-bold text-primary mb-4">Select Payment</h2>
            <div class="space-y-3">
                <button onclick="app.placeOrder('Pay at Counter', this)" class="payment-btn w-full flex items-center justify-center bg-secondary p-4 rounded-xl"><span class="text-2xl mr-4">üíµ</span><span class="font-semibold">Pay at Counter</span></button>
                <!-- <button onclick="app.placeOrder('UPI / QR Code', this)" class="payment-btn w-full flex items-center justify-center bg-secondary p-4 rounded-xl"><span class="text-2xl mr-4">üì±</span><span class="font-semibold">UPI / QR Code</span></button> -->
            </div>
            <button onclick="ui.closeModal('payment-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Cancel</button>
        `);
    },

    showItemDetailModal(itemId){
        const item = app.state.allMenuItems.find(i => i.id === itemId); if (!item) return;
        const cartItem = app.state.cart.find(ci => ci.id === itemId);
        const currentQuantity = cartItem ? cartItem.quantity : 1;
        let optionsHTML = Array.from({ length: 10 }, (_, i) => `<option value="${i + 1}" ${i + 1 === currentQuantity ? 'selected' : ''}>${i + 1}</option>`).join('');
        optionsHTML = `<option value="0" ${!cartItem ? 'selected' : ''}>0 (Remove)</option>` + optionsHTML;

        ui.showModal('item-detail-modal', `
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold text-primary">${item.name}</h2>
                    <p class="text-xl font-semibold text-secondary">‚Çπ${item.price}</p>
                </div>
                <div class="text-5xl">${item.image_url || '‚òïÔ∏è'}</div>
            </div>
            <p class="text-secondary mt-2">${item.description || 'A delicious choice.'}</p>
            <div class="flex items-center justify-between my-6 bg-secondary p-3 rounded-lg">
                <label for="modal-quantity-select" class="font-semibold text-primary">Quantity:</label>
                <select id="modal-quantity-select" class="bg-primary border border-custom text-primary font-semibold rounded-lg p-2">${optionsHTML}</select>
            </div>
            <div class="mt-6 grid grid-cols-2 gap-4">
                <button onclick="ui.closeModal('item-detail-modal')" class="w-full bg-secondary font-semibold py-3 rounded-lg">Back</button>
                <button onclick="app.setCartItemQuantity(${item.id}, parseInt($('#modal-quantity-select').value))" class="w-full brand-bg font-semibold py-3 rounded-lg">${cartItem ? 'Update Quantity' : 'Add to Cart'}</button>
            </div>`);
    },

    showInstagramPromo(){
        const vibes = Object.entries(STATIC_DATA.captionIdeas).map(([key, _]) => ({
            name: key, icon: { student: 'üéì', office: 'üíº', couple: '‚ù§Ô∏è', friends: 'üéâ' }[key]
        }));
        ui.showModal('insta-modal', `
            <h2 class="text-2xl font-bold">Post for a Free Hamper!</h2>
            <p class="text-secondary mt-1 mb-6">If your order is over ‚Çπ799, post a story tagging us, and show both at the counter!</p>
            <div class="grid grid-cols-2 gap-4">${vibes.map(v => `
                <button onclick="ui.showCaptionIdeas('${v.name}')" class="bg-secondary p-4 rounded-xl text-center">
                    <span class="text-3xl">${v.icon}</span><p class="font-semibold mt-2 capitalize">${v.name}</p>
                </button>`).join('')}
            </div>
            <button onclick="ui.closeModal('insta-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Cancel</button>
        `);
    },

    showCaptionIdeas(category){
        ui.closeModal('insta-modal');
        const captions = STATIC_DATA.captionIdeas[category];
        ui.showModal('caption-modal', `
            <h2 class="text-2xl font-bold">Caption Ideas</h2>
            <p class="text-secondary mt-1 mb-4">Tap to copy. Tag us <span class="font-bold brand-text">@hxousecoffeeco</span>!</p>
            <div class="space-y-2 max-h-48 overflow-y-auto">${captions.map(c => `
                <div onclick="app.copyCaption('${c.replace(/'/g, "\\'")}')" class="bg-secondary p-3 rounded-lg text-sm font-medium cursor-pointer flex justify-between items-center">
                    <span>${c}</span><span class="text-xs font-bold brand-text">COPY</span>
                </div>`).join('')}
            </div>
            <a href="instagram://story-camera" class="block w-full text-center mt-6 bg-gradient-to-r from-yellow-400 via-red-500 to-pink-500 text-white font-semibold py-3 rounded-lg">Open Instagram Story</a>
            <button onclick="ui.closeModal('caption-modal')" class="w-full mt-2 bg-secondary font-semibold py-3 rounded-lg">Close</button>
        `);
    },

    showGamesModal() {
        ui.showModal('games-modal', `
            <h2 class="text-xl font-bold text-center mb-4">Entertainment</h2>
            <div class="space-y-3">
                ${Object.values(GAMES).map(game => `
                    <div class="bg-secondary p-4 rounded-xl">
                        <h3 class="text-lg font-bold text-primary mb-1">${game.title}</h3>
                        <p class="text-secondary text-sm mb-3">${game.description}</p>
                        <button onclick="GAMES['${game.id}'].start()" class="brand-bg font-semibold py-2 px-4 rounded-lg text-sm">Play</button>
                    </div>`).join("")}
            </div>
            <button onclick="ui.closeModal('games-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
        `);
    },

    showThemeModal() {
        const themes = [ { n: 'light', i: '‚òÄÔ∏è' }, { n: 'dark', i: 'üåô' }, { n: 'sunset', i: 'üåÜ' }, { n: 'matcha', i: 'üçµ' }];
        ui.showModal('theme-modal', `
            <h2 class="text-xl font-bold mb-4">Choose Theme</h2>
            <div class="grid grid-cols-2 gap-4">${themes.map(t => `<button onclick="app.toggleTheme('${t.n}')" class="bg-secondary p-4 rounded-xl text-center"><span class="text-3xl">${t.i}</span><p class="font-semibold mt-1 capitalize">${t.n}</p></button>`).join('')}</div>
            <button onclick="ui.closeModal('theme-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
        `);
    },

    showWifiModal() {
        ui.showModal('wifi-modal', `
            <div class="text-center">
                <h2 class="text-xl font-bold mb-2">Wi-Fi Network</h2>
                <p class="text-secondary mb-4">Connect and enjoy!</p>
                <div class="bg-secondary p-4 rounded-lg">
                    <p class="text-xs">Network Name</p><p class="font-bold text-lg">THE CO-WORK HUB</p>
                    <hr class="border-custom my-3">
                    <p class="text-xs">Password</p><p class="font-bold text-lg">95462418</p>
                </div>
                <button onclick="ui.closeModal('wifi-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
            </div>
        `);
    },

    async showOrderHistoryModal() {
        if (!app.state.customerProfile || !app.state.customerProfile.id) return ui.showToast("Error: Profile not loaded.");
        const { data } = await supabase.from('orders').select(`*, order_items (products(name), quantity), discount_amount, discount_points_redeemed`).eq('customer_id', app.state.customerProfile.id).order('created_at', { ascending: false });
        const historyHTML = data?.length > 0 ? data.map(o => `
            <div class="bg-secondary p-3 rounded-lg">
                <div class="flex justify-between">
                    <div>
                        <p class="font-bold">Order #${o.id.slice(0, 6)}</p>
                        <p class="text-xs text-secondary">${new Date(o.created_at).toLocaleString()}</p>
                    </div>
                    <p class="font-semibold">‚Çπ${(o.final_amount ?? o.total_amount).toFixed(2)}</p>
                </div>
                <div class="text-sm text-secondary mt-2">${o.order_items.length > 0 ? o.order_items.map(i => `${i.products.name} (x${i.quantity})`).join(', ') : 'No items found'}</div>
                ${o.discount_amount > 0 ? `<p class="text-xs text-green-600 mt-1">Discount: -‚Çπ${o.discount_amount.toFixed(2)} (${o.discount_points_redeemed} points)</p>` : ''}
            </div>`).join('') : '<p class="text-secondary text-center">No past orders found.</p>';

        ui.showModal('history-modal', `
            <h2 class="text-xl font-bold text-center mb-4">Order History</h2>
            <div class="space-y-3 max-h-60 overflow-y-auto">${historyHTML}</div>
            <button onclick="ui.closeModal('history-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Close</button>
        `);
    }
};

const GAMES = {
    ticTacToe: {
        id: 'ticTacToe', title: 'Tic-Tac-Toe', description: 'Classic 2-player game for your table.',
        board: Array(9).fill(null),
        currentPlayer: "X",
        winner: null,
        start() {
            this.reset();
            ui.showModal('ttt-modal', `
                <h2 class="text-2xl font-bold mb-2 text-center">Tic-Tac-Toe</h2>
                <p id="ttt-status" class="font-semibold text-secondary mb-4 text-center">Player X's turn</p>
                <div class="w-full max-w-[250px] mx-auto">
                    <div id="ttt-board" class="grid grid-cols-3 gap-2 my-4">
                        ${this.board.map((_, i) => `<div class="aspect-square bg-secondary flex items-center justify-center text-5xl sm:text-6xl font-bold rounded-lg cursor-pointer" onclick="GAMES.ticTacToe.play(${i})"></div>`).join("")}
                    </div>
                </div>
                <button onclick="GAMES.ticTacToe.start()" class="w-full mt-2 brand-bg font-semibold py-3 rounded-lg">New Game</button>
                <button onclick="ui.closeModal('ttt-modal')" class="w-full mt-2 bg-secondary py-3 rounded-lg">Close</button>
            `);
        },
        play(i) {
            if (this.board[i] || this.winner) return;
            this.board[i] = this.currentPlayer;
            this.checkWinner();
            this.currentPlayer = this.currentPlayer === "X" ? "O" : "X";
            this.updateUI();
        },
        checkWinner() {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (let line of lines) {
                const [a, b, c] = line;
                if (this.board[a] && this.board[a] === this.board[b] && this.board[a] === this.board[c]) {
                    this.winner = this.board[a];
                    sound.play("win");
                    return;
                }
            }
            if (this.board.every(cell => cell)) {
                this.winner = "Draw";
                sound.play("draw");
            }
        },
        updateUI() {
            $$("#ttt-board > div").forEach((cell, i) => {
                cell.textContent = this.board[i];
                cell.style.color = this.board[i] === "X" ? "#3b82f6" : "#ef4444";
            });
            $("#ttt-status").textContent = this.winner ? (this.winner === "Draw" ? "It's a Draw!" : `Player ${this.winner} wins!`) : `Player ${this.currentPlayer}'s turn`;
        },
        reset() {
            this.board.fill(null);
            this.currentPlayer = "X";
            this.winner = null;
        }
    },
    coffeeTrivia: {
        id: 'coffeeTrivia', title: 'Coffee Trivia', description: 'Test your coffee knowledge!',
        currentQuestion: null,
        trivia: [
            { q: "Where was coffee first discovered?", o: ["Brazil", "Ethiopia", "Colombia", "Vietnam"], a: 1 },
            { q: "What does 'espresso' mean in Italian?", o: ["Fast Coffee", "Dark Coffee", "Expressed or Forced Out", "Morning Ritual"], a: 2 },
            { q: "What is the most expensive coffee in the world, often involving an animal?", o: ["Blue Mountain", "Geisha", "Kopi Luwak", "Bourbon"], a: 2 },
            { q: "Which country is the largest producer of coffee?", o: ["Brazil", "Vietnam", "Indonesia", "India"], a: 0 }
        ],
        start() {
            this.currentQuestion = this.trivia[Math.floor(Math.random() * this.trivia.length)];
            const item = this.currentQuestion;
            ui.showModal('trivia-modal', `
                <div class="text-center">
                    <h2 class="text-xl font-bold mb-2">Coffee Trivia</h2>
                    <p class="text-secondary mb-6 h-12">${item.q}</p>
                    <div id="trivia-options" class="space-y-3">
                        ${item.o.map((opt, index) => `<button class="trivia-option w-full bg-secondary font-semibold p-3 rounded-lg text-left" onclick="GAMES.coffeeTrivia.checkAnswer(${index}, ${item.a})">${opt}</button>`).join('')}
                    </div>
                    <button onclick="ui.closeModal('trivia-modal')" class="w-full mt-6 bg-secondary py-3 rounded-lg">Close</button>
                </div>
            `);
        },
        checkAnswer(selectedIndex, correctIndex) {
            const options = $$('.trivia-option');
            options.forEach((btn, index) => {
                btn.disabled = true;
                if (index === correctIndex) {
                    btn.classList.remove('bg-secondary');
                    btn.classList.add('bg-green-500', 'text-white');
                } else if (index === selectedIndex) {
                    btn.classList.remove('bg-secondary');
                    btn.classList.add('bg-red-500', 'text-white');
                }
            });

            if (selectedIndex === correctIndex) {
                sound.play('success');
            } else {
                sound.play('draw');
            }

            setTimeout(() => this.start(), 2000);
        }
    },
    coffeeArt: {
        id: 'coffeeArt', title: 'Coffee Art Studio', description: 'Unleash your inner barista and create some latte art.',
        canvas: null, ctx: null, painting: false,
        start() {
            ui.showModal('art-modal', `
                <div class="text-center">
                    <h2 class="text-2xl font-bold mb-2">Coffee Art Studio</h2>
                    <div class="relative w-full aspect-square mx-auto my-4 rounded-full bg-[#c4a484] overflow-hidden cursor-crosshair" id="canvas-container">
                        <canvas id="coffee-art-canvas"></canvas>
                    </div>
                    <div class="flex justify-center items-center space-x-2">
                        <button onclick="GAMES.coffeeArt.changeColor('#ffffff')" class="w-8 h-8 rounded-full bg-white border-2 border-custom"></button>
                        <button onclick="GAMES.coffeeArt.changeColor('#5a3825')" class="w-8 h-8 rounded-full bg-[#5a3825] border-2 border-custom"></button>
                        <button onclick="GAMES.coffeeArt.clearCanvas()" class="bg-secondary font-semibold py-1 px-3 rounded-lg text-sm">Clear</button>
                    </div>
                    <button onclick="ui.closeModal('art-modal')" class="w-full mt-6 bg-secondary font-semibold py-3 rounded-lg">Done</button>
                </div>`);
            this.initCanvas();
        },
        initCanvas() {
            this.canvas = $("#coffee-art-canvas");
            const container = $('#canvas-container');
            if (!this.canvas || !container) return;
            this.ctx = this.canvas.getContext("2d");
            const size = container.clientWidth;
            this.canvas.width = size;
            this.canvas.height = size;
            this.ctx.strokeStyle = "#ffffff"; this.ctx.lineWidth = 5; this.ctx.lineCap = "round";
            this.canvas.addEventListener("pointerdown", this.startPosition.bind(this));
            this.canvas.addEventListener("pointerup", this.finishedPosition.bind(this));
            this.canvas.addEventListener("pointermove", this.draw.bind(this));
            this.canvas.addEventListener("touchstart", this.startPosition.bind(this), { passive: false });
            this.canvas.addEventListener("touchend", this.finishedPosition.bind(this));
            this.canvas.addEventListener("touchmove", this.draw.bind(this), { passive: false });
        },
        getEventPosition(e) {
            const rect = this.canvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
            }
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        },
        startPosition(e) { this.painting = true; this.draw(e); },
        finishedPosition() { this.painting = false; this.ctx.beginPath(); },
        draw(e) {
            if (!this.painting) return;
            e.preventDefault();
            const { x, y } = this.getEventPosition(e);
            this.ctx.lineTo(x, y); this.ctx.stroke();
            this.ctx.beginPath(); this.ctx.moveTo(x, y);
        },
        changeColor(c) { if(this.ctx) this.ctx.strokeStyle = c; },
        clearCanvas() { if(this.ctx) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height); }
    },
};

document.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>
